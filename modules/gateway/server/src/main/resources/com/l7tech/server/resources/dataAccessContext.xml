<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC  "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<!--
    The Spring Hibernate configuration. References Hibernate mappings, defines transaction managers
    persistence interceptors, and transactional behaviour.
-->
<!--suppress SpringModelInspection -->
<beans>

    <!--
    Hibernate / C3P0 Properties location
    -->
    <bean id="hibernateProperties"
          class="com.l7tech.server.util.PasswordDecryptingPropertiesFactoryBean"
          depends-on="systemProperties">
        <constructor-arg ref="propertiesDecryptor"/>
        <property name="ignoreResourceNotFound" value="true"/>
        <property name="locations">
            <list>
                <value>classpath:com/l7tech/server/resources/database.properties</value>
                <value>classpath:com/l7tech/server/resources/c3p0.properties</value>
                <value>classpath:com/l7tech/server/resources/hibernate_default.properties</value>
                <value>classpath:hibernate.properties</value>
                <value>file:${com.l7tech.server.configDirectory}${file.separator}database.properties</value>
                <value>file:${com.l7tech.server.configDirectory}${file.separator}hibernate.properties</value>
            </list>
        </property>
    </bean>

    <!-- Configures data source based on hibernateProperties -->
    <bean class="org.springframework.beans.factory.config.PropertyOverrideConfigurer">
        <property name="ignoreInvalidKeys" value="true"/>
        <property name="propertiesArray">
            <list>
                <ref local="hibernateProperties"/>
            </list>
        </property>
    </bean>

    <!-- General purpose pooled data source -->
    <bean id="c3p0DataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource" destroy-method="close">
        <constructor-arg value="c3p0DataSource"/> <!-- Name used for identification only, does not affect configuration -->
    </bean>

    <!-- Administrative pooled data source, smaller pool, shorter timeouts -->
    <bean id="c3p0AdminDataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource" destroy-method="close">
        <constructor-arg value="c3p0AdminDataSource"/> <!-- Name used for identification only, does not affect configuration configuration-->
    </bean>

    <!-- Data source that can be switched for different pooling strategies -->
    <bean id="switchedDataSource" class="com.l7tech.server.util.UserSwitchedRoutingDataSource">
        <property name="defaultTargetDataSource" ref="c3p0DataSource"/>
        <property name="targetDataSources">
            <map>
                <entry key="default"><ref local="c3p0DataSource"/></entry>
                <entry key="admin"><ref local="c3p0AdminDataSource"/></entry>
            </map>
        </property>
    </bean>

    <!--
    Default Hibernate Session Manager
    -->
    <bean id="sessionFactory" class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
        <property name="mappingResources">
            <list>
                <value>com/l7tech/server/resources/SSG.hbm.xml</value>
                <value>com/l7tech/server/resources/audit.hbm.xml</value>
                <value>com/l7tech/server/resources/rbac.hbm.xml</value>
                <value>com/l7tech/server/resources/wsdm.hbm.xml</value>
            </list>
        </property>
        <property name="dataSource" ref="switchedDataSource"/>
        <property name="hibernateProperties" ref="hibernateProperties"/>
        <property name="entityInterceptor" ref="persistenceEventInterceptor"/>
    </bean>

    <!--
    Default Hibernate Transaction Manager
    -->
    <bean id="transactionManager" class="org.springframework.orm.hibernate3.HibernateTransactionManager">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <!-- The audit events hibernate interceptor -->
    <bean id="persistenceEventInterceptor" class="com.l7tech.server.PersistenceEventInterceptor"/>

    <!-- Hibernate managers that need transaction interception -->
    <bean class="org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator">
        <property name="proxyTargetClass" value="false"/>
        <property name="interceptorNames">
            <list>
                <idref bean="annotationTransactionInterceptor"/>
            </list>
        </property>
        <property name="beanNames">
            <list>
                <!-- IDPs -->
                <idref bean="internalIdentityProvider"/>
                <idref bean="federatedIdentityProvider"/>
                <idref bean="internalUserManager"/>
                <idref bean="internalGroupManager"/>
                <idref bean="federatedUserManager"/>
                <idref bean="federatedGroupManager"/>

                <!-- Entity managers -->
                <idref bean="serviceManager"/>
                <idref bean="identityProviderConfigManager"/>
                <idref bean="trustedCertManager"/>
                <idref bean="clientCertManager"/>
                <idref bean="auditRecordManager"/>
                <idref bean="statusUpdateManager"/>
                <idref bean="sampleMessageManager"/>
                <idref bean="serviceDocumentManager"/>
                <idref bean="resolutionManager"/>
                <idref bean="clusterInfoManager"/>
                <idref bean="clusterPropertyManager"/>
                <idref bean="serviceUsageManager"/>
                <idref bean="jmsEndpointManager"/>
                <idref bean="jmsConnectionManager"/>
                <idref bean="auditExporter"/>
                <idref bean="counterIDManager"/>
                <idref bean="entityFinder"/>
                <idref bean="attributeConfigManager"/>
                <idref bean="identityMappingManager"/>
                <idref bean="securityTokenMappingManager"/>
                <idref bean="roleManager"/>
                <idref bean="schemaEntryManager"/>
                <idref bean="sharedKeyManager"/>
                <idref bean="keystoreFileManager"/>
                <idref bean="revocationCheckPolicyManager"/>
                <idref bean="ssgConnectorManager"/>
                <idref bean="policyManager"/>
                <idref bean="policyVersionManager"/>
                <idref bean="sinkManager"/>
                <idref bean="esmSubscriptionManager"/>
            </list>
        </property>
    </bean>


    <bean class="org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor">
        <property name="transactionInterceptor" ref="annotationTransactionInterceptor"/>
    </bean>

    <bean id="annotationTransactionInterceptor" class="org.springframework.transaction.interceptor.TransactionInterceptor">
        <property name="transactionManager" ref="transactionManager"/>
        <property name="transactionAttributeSource">
            <bean class="org.springframework.transaction.annotation.AnnotationTransactionAttributeSource"/>
        </property>
    </bean>

</beans>
