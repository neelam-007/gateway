<?xml version="1.0" encoding="UTF-8"?>
<!--
    The Application Context contains the definitions that describe the SSG server side components.
    Things such as identity managers, trust components, policy services token services etc. are defined
    here.
    Admin Services are defined in adminContext.xml.
    Data Access (Hibernate, Transactions) is defined in dataAccessContext.xml.
-->
<!--suppress SpringModelInspection -->
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                            http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
                            http://www.springframework.org/schema/aop
                            http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
                            http://www.springframework.org/schema/tx
                            http://www.springframework.org/schema/tx/spring-tx-2.5.xsd
                            http://www.springframework.org/schema/context
                            http://www.springframework.org/schema/context/spring-context-2.5.xsd">


    <!-- enable automatic proxy generation for any class or superclass annotated with @Transactional -->
    <tx:annotation-driven order="20000"/>

    <context:annotation-config/>

    <bean id="applicationEventPublisher" class="com.l7tech.server.util.ApplicationEventPublisherFactoryBean"/>

    <bean id="systemProperties" class="com.l7tech.server.SystemProperties">
        <!-- Don't fully initialize serverconfig (no cluster propertes / db access) -->
        <constructor-arg>
            <bean class="com.l7tech.server.ServerConfig" factory-method="getInstance"/>
        </constructor-arg>
    </bean>

    <bean id="gatewayState" class="com.l7tech.server.GatewayState"/>

    <!-- Crypto init -->
    <bean id="initLunaPinFinder" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.security.keystore.luna.GatewayLunaPinFinder"/>
        <property name="targetMethod" value="setClusterPassphrase"/>
        <property name="arguments">
            <bean class="com.l7tech.server.util.PropertiesValueFactoryBean">
                <constructor-arg ref="nodeProperties"/>
                <constructor-arg value="node.cluster.pass"/>
            </bean>
        </property>
    </bean>

    <bean id="cryptoInit" class="com.l7tech.server.security.CryptoInitializer" depends-on="initLunaPinFinder">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="licenseManager"/>
    </bean>

    <!-- SSG boot process -->
    <bean id="ssgBoot" class="com.l7tech.server.BootProcess"
          depends-on="systemAuditListener systemProperties serviceWsdlImportChecker"><!-- sinkManager -->
        <property name="serverConfig" ref="serverConfig"/>
        <property name="otherPropertiesFiles">
            <map>
                <entry key="com.l7tech.server"
                       value="${com.l7tech.server.configDirectory}${file.separator}node.properties"/>
            </map>
        </property>
        <property name="systemProperties" ref="systemProperties"/>
    </bean>

    <bean id="clusterBoot" class="com.l7tech.server.cluster.ClusterBootProcess">
        <constructor-arg index="0" ref="clusterInfoManager"/>
        <constructor-arg index="1" ref="distributedMessageIdManager"/>
        <constructor-arg index="2" ref="serverConfig"/>
    </bean>

    <bean id="clusterPropertyManager" class="com.l7tech.server.cluster.ClusterPropertyManagerImpl"
          parent="hibernateBean">
    </bean>

    <bean id="genericEntityManager" class="com.l7tech.server.entity.GenericEntityManagerImpl"
          parent="hibernateBean">
    </bean>

    <bean id="clusterPropertyCache" class="com.l7tech.server.cluster.ClusterPropertyCache">
        <property name="clusterPropertyManager" ref="clusterPropertyManager"/>
        <property name="clusterPropertyListener">
            <bean class="com.l7tech.gateway.common.spring.factory.config.LazyProxyFactoryBean">
                <constructor-arg value="serverConfig"/>
                <constructor-arg value="com.l7tech.server.cluster.ClusterPropertyListener"/>
            </bean>
        </property>
    </bean>

    <bean id="configureServerVariablesClusterPropertyCache"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="staticMethod"
                  value="com.l7tech.server.policy.variable.ServerVariables.setClusterPropertyCache"/>
        <property name="arguments">
            <list>
                <ref local="clusterPropertyCache"/>
            </list>
        </property>
    </bean>

    <bean id="configureServerVariablesSecurePasswordManager"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="staticMethod"
                  value="com.l7tech.server.policy.variable.ServerVariables.setSecurePasswordManager"/>
        <property name="arguments">
            <list>
                <ref local="securePasswordManager"/>
            </list>
        </property>
    </bean>

    <bean id="configureServerVariablesClusterInfoManager"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="staticMethod" value="com.l7tech.server.policy.variable.ServerVariables.setClusterInfoManager"/>
        <property name="arguments">
            <list>
                <ref local="clusterInfoManager"/>
            </list>
        </property>
    </bean>

    <bean id="configureServerVariablesSsgConnectorManager"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="staticMethod" value="com.l7tech.server.policy.variable.ServerVariables.setSsgConnectorManager"/>
        <property name="arguments">
            <list>
                <ref local="ssgConnectorManager"/>
            </list>
        </property>
    </bean>

    <bean id="configureServerVariablesJdbcConnectionManager"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="staticMethod" value="com.l7tech.server.policy.variable.ServerVariables.setJdbcConnectionManager"/>
        <property name="arguments">
            <list>
                <ref local="jdbcConnectionManager"/>
            </list>
        </property>
    </bean>

    <bean id="timeSource" class="com.l7tech.util.TimeSource"/>

    <bean id="configurePolicyEnforcementContextFactoryTimeSource" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="staticMethod" value="com.l7tech.server.message.PolicyEnforcementContextFactory.setTimeSource"/>
        <property name="arguments">
            <list>
                <ref bean="timeSource"/>
            </list>
        </property>
    </bean>

    <bean id="configureServerVariablesTimeSource" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="staticMethod" value="com.l7tech.server.policy.variable.ServerVariables.setTimeSource"/>
        <property name="arguments">
            <list>
                <ref bean="timeSource"/>
            </list>
        </property>
    </bean>

    <bean id="originalRequestUpdator" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="staticMethod" value="com.l7tech.message.Message.setDefaultEnableOriginalDocument"/>
        <property name="arguments">
            <list>
                <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
                    <property name="targetObject" ref="clusterPropertyCache"/>
                    <property name="targetMethod" value="getPropertyValue"/>
                    <property name="arguments">
                        <list>
                            <value>audit.originalMainPart.enable</value>
                        </list>
                    </property>
                </bean>
            </list>
        </property>
    </bean>

    <bean id="auditPolicyEvaluator" class="com.l7tech.server.audit.AuditPolicyEvaluator">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="policyCache"/>
        <constructor-arg index="2" ref="policyManager"/>
        <constructor-arg index="3" ref="jdbcConnectionPoolManager"/>
    </bean>

    <bean id="auditLookupPolicyEvaluator" class="com.l7tech.server.audit.AuditLookupPolicyEvaluator">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="policyCache"/>
    </bean>

    <bean id="auditFilterPolicyManager" class="com.l7tech.server.audit.AuditFilterPolicyManager">
        <constructor-arg ref="policyCache"/>
        <constructor-arg ref="stashManagerFactory"/>
    </bean>

    <bean id="ssgShutdown" class="com.l7tech.server.boot.ShutdownWatcher"/>

    <bean id="jceProvider" class="com.l7tech.security.prov.JceProvider" factory-method="getInstance"
          depends-on="cryptoInit clusterPropertyCache"/>

    <bean id="secureRandom" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject" ref="jceProvider"/>
        <property name="targetMethod" value="getSecureRandom"/>
    </bean>

    <bean id="passwordHasher" class="com.l7tech.server.identity.internal.GatewayPasswordHasher">
        <constructor-arg ref="secureRandom"/>
    </bean>

    <bean id="jmsThreadPool" class="com.l7tech.server.util.ThreadPoolBean">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" value="JMS Thread Pool"/>
        <constructor-arg index="2" value="jmsListenerThreadLimit"/>
        <constructor-arg index="3" value="jms.listenerThreadLimit"/>
        <constructor-arg index="4" value="25"/>
    </bean>

    <!-- JMS boot process  -->
    <bean id="jmsBootProcess" class="com.l7tech.server.transport.jms2.JmsBootProcess">
        <constructor-arg index="0" ref="jmsThreadPool"/>
        <constructor-arg index="1" ref="licenseManager"/>
        <constructor-arg index="2" ref="jmsConnectionManager"/>
        <constructor-arg index="3" ref="jmsEndpointManager"/>
        <constructor-arg index="4" ref="jmsPropertyMapper"/>
        <constructor-arg index="5">
            <bean class="com.l7tech.server.transport.jms2.ConfigurableJmsEndpointListenerFactory">
                <constructor-arg index="0" ref="serverConfig"/>
                <constructor-arg index="1" value="Pooled"/>
                <constructor-arg index="2">
                    <map>
                        <entry key="Pooled">
                            <bean class="com.l7tech.server.transport.jms2.asynch.PooledJmsEndpointListenerFactory">
                                <constructor-arg type="com.l7tech.server.util.ThreadPoolBean" ref="jmsThreadPool"/>
                            </bean>
                        </entry>
                        <entry key="Simple">
                            <bean class="com.l7tech.server.transport.jms2.synch.LegacyJmsEndpointListenerFactory"/>
                        </entry>
                    </map>
                </constructor-arg>
            </bean>
        </constructor-arg>
        <constructor-arg index="6">
            <null/>
        </constructor-arg>
    </bean>

    <bean id="emailListenerThreadPool" class="com.l7tech.server.util.ThreadPoolBean">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" value="Email Listener Thread Pool"/>
        <constructor-arg index="2" value="emailListenerThreadLimit"/>
        <constructor-arg index="3" value="email.listenerThreadLimit"/>
        <constructor-arg index="4" value="25"/>
    </bean>

    <!-- Email boot process -->
    <bean id="emailListenerBootProcess" class="com.l7tech.server.transport.email.EmailListenerBootProcess">
        <constructor-arg type="com.l7tech.server.util.ThreadPoolBean" ref="emailListenerThreadPool"/>
        <constructor-arg type="com.l7tech.gateway.common.LicenseManager" ref="licenseManager"/>
        <constructor-arg type="com.l7tech.server.transport.email.EmailListenerManager" ref="emailListenerManager"/>
        <constructor-arg ref="clusterNodeId"/>
        <constructor-arg type="java.util.Timer">
            <null/>
        </constructor-arg>
        <property name="pollingEmailListenerFactory" ref="pollingEmailListenerFactory"/>
    </bean>

    <bean id="pollingEmailListenerFactory"
          class="com.l7tech.server.transport.email.asynch.PooledPollingEmailListenerFactory">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="emailListenerThreadPool"/>
    </bean>

    <!-- Abstract "parent" of any bean that needs access to sessionFactory and transactionManager -->
    <bean id="hibernateBean" abstract="true">
        <property name="sessionFactory" ref="sessionFactory"/>
        <property name="transactionManager" ref="transactionManager"/>
    </bean>

    <!--
    * singleton using the factory method. This is transitional, as it is referenced from
    * too many places.
    -->
    <bean id="serverConfig" class="com.l7tech.server.ServerConfig" factory-method="getInstance"
          depends-on="configureBackgroundTimer">
        <property name="propertyChangeListener">
            <bean class="com.l7tech.server.util.LazyPropertyChangeDispatcher">
                <constructor-arg>
                    <map>
                        <entry key="serviceMetricsServices">
                            <list>
                                <value>serviceMetricsEnabled</value>
                                <value>customerMapping.addToServiceMetrics</value>
                            </list>
                        </entry>
                        <entry key="ssgConnectorManager">
                            <list>
                                <value>interfaceTags</value>
                            </list>
                        </entry>

                        <entry key="certValidationProcessor">
                            <list>
                                <value>pkixTrust.useDefaultAnchors</value>
                                <value>pkixTrust.permittedCriticalExtensions</value>
                            </list>
                        </entry>
                        <entry key="jmsBootProcess">
                            <list>
                                <value>ioJmsErrorSleep</value>
                                <value>ioJmsMessageMaxBytes</value>
                                <value>jmsEndpointThreadDistribution</value>
                            </list>
                        </entry>
                        <entry key="jmsThreadPool">
                            <list>
                                <value>jmsListenerThreadLimit</value>
                            </list>
                        </entry>
                        <entry key="emailListenerThreadPool">
                            <list>
                                <value>emailListenerThreadLimit</value>
                            </list>
                        </entry>
                        <entry key="trustedCertManager">
                            <list>
                                <value>trustedCert.expiryCheckPeriod</value>
                            </list>
                        </entry>
                        <entry key="httpTransportModule">
                            <list>
                                <value>ioHttpPoolMaxConcurrency</value>
                                <value>ioHttpPoolMinSpareThreads</value>
                            </list>
                        </entry>
                        <entry key="trafficLogger">
                            <list>
                                <value>trafficLoggerDetail</value>
                                <value>trafficLoggerRecordReq</value>
                                <value>trafficLoggerRecordRes</value>
                                <value>trafficLoggerSelective</value>
                            </list>
                        </entry>
                        <entry key="sinkManager">
                            <list>
                                <value>logLevels</value>
                            </list>
                        </entry>
                        <entry key="auditLogListenerTarget">
                            <list>
                                <value>auditBatchExternal</value>
                                <value>auditLogFormatServiceHeader</value>
                                <value>auditLogFormatServiceFooter</value>
                                <value>auditLogFormatServiceDetail</value>
                                <value>auditLogFormatOther</value>
                                <value>auditLogFormatOtherDetail</value>
                            </list>
                        </entry>
                        <entry key="schemaConfiguration">
                            <list>
                                <value>schemaMaxCacheEntries</value>
                                <value>schemaMaxCacheAge</value>
                                <value>schemaMaxStaleCacheAge</value>
                                <value>schemaRecompileLatency</value>
                                <value>schemaRecompileMinAge</value>
                                <value>schemaRecompileMaxAge</value>
                                <value>schemaCacheMaxSchemaSize</value>
                                <value>schemaSoftwareFallback</value>
                                <value>schema.remoteResourceRegex</value>
                                <value>schema.allowDoctype</value>
                            </list>
                        </entry>
                        <entry key="auditDetailFilter">
                            <list>
                                <value>auditAssociatedLogsThreshold</value>
                            </list>
                        </entry>
                        <entry key="defaultKey">
                            <list>
                                <value>keyStoreDefaultSslKey</value>
                                <value>keyStoreDefaultCaKey</value>
                                <value>keyStoreAuditViewerKey</value>
                                <value>keyStoreAuditSigningKey</value>
                                <value>keyStoreSearchForAlias</value>
                            </list>
                        </entry>
                        <entry key="logonService">
                            <list>
                                <value>logon.lockoutTime</value>
                                <value>logon.maxAllowableAttempts</value>
                                <value>logon.inactivityPeriod</value>
                            </list>
                        </entry>
                        <entry key="passwordEnforcerManager">
                            <list>
                                <value>security.pcidss.enabled</value>
                            </list>
                        </entry>
                        <entry key="auditArchiver">
                            <list>
                                <value>auditArchiverTimerPeriod</value>
                                <value>auditArchiverStaleTimeout</value>
                                <value>auditArchiverShutdownThreshold</value>
                                <value>auditArchiverStartThreshold</value>
                                <value>auditArchiverStopThreshold</value>
                                <value>auditArchiverBatchSize</value>
                                <value>auditArchiverWarningThreshold</value>
                            </list>
                        </entry>
                        <entry key="auditArchiveReceiver">
                            <list>
                                <value>auditArchiverFtpConfig</value>
                                <value>auditArchiverFtpMaxUploadFileSize</value>
                                <value>auditArchiverFtpFileprefix</value>
                            </list>
                        </entry>
                        <entry key="kerberosConfig">
                            <list>
                                <value>krb5Keytab</value>
                                <value>krb5Realm</value>
                                <value>krb5KDC</value>
                            </list>
                        </entry>
                        <entry key="pollingEmailListenerFactory">
                            <list>
                                <value>ioMailInConnectTimeout</value>
                                <value>ioMailInTimeout</value>
                            </list>
                        </entry>
                        <entry key="ldapRuntimeConfig">
                            <list>
                                <value>ldapReadTimeout</value>
                                <value>ldapConnectionTimeout</value>
                                <value>ldapCertIndexInterval</value>
                                <value>ldapCertCacheLifetime</value>
                                <value>maxLdapSearchResultSize</value>
                                <value>ldap.group.searchMaxResults</value>
                            </list>
                        </entry>
                        <entry key="adminSessionManager">
                            <list>
                                <value>principalSessionCacheMaxTime</value>
                                <value>logon.sessionExpiry</value>
                            </list>
                        </entry>
                        <entry key="messageCacheStashManagerFactory">
                            <list>
                                <value>messageCacheDiskThreshold</value>
                            </list>
                        </entry>
                        <entry key="jmsResourceManager">
                            <list>
                                <value>ioJmsConnectionCacheMaxAge</value>
                                <value>ioJmsConnectionCacheMaxIdleTime</value>
                                <value>ioJmsConnectionCacheSize</value>
                            </list>
                        </entry>
                        <entry key="tokenService">
                            <list>
                                <value>service.validateWssTimestamps</value>
                                <value>httpDigest.enable</value>
                            </list>
                        </entry>
                        <entry key="simplePropertyChangeHandler">
                            <list>
                                <value>otherTextualContentTypes</value>
                                <value>ioDebugSsl</value>
                                <value>ioDebugSslValue</value>
                                <value>logStdOutLevel</value>
                                <value>logStdErrLevel</value>
                                <value>datetime.customFormats</value>
                                <value>datetime.autoFormats</value>
                            </list>
                        </entry>
                        <entry key="httpConfigurationCache">
                            <list>
                                <value>keyStoreDefaultSslKey</value>
                                <value>keyStoreDefaultCaKey</value>
                                <value>keyStoreSearchForAlias</value>
                                <value>ioHttpProxy</value>
                            </list>
                        </entry>
                        <entry key="auditLevelDetailFilter">
                            <list>
                                <value>audit.setDetailLevel.SEVERE</value>
                                <value>audit.setDetailLevel.WARNING</value>
                                <value>audit.setDetailLevel.INFO</value>
                                <value>audit.setDetailLevel.CONFIG</value>
                                <value>audit.setDetailLevel.FINE</value>
                                <value>audit.setDetailLevel.FINER</value>
                                <value>audit.setDetailLevel.FINEST</value>
                                <value>audit.auditDetailExcludeList</value>
                            </list>
                        </entry>
                        <entry key="auditingThrowsAdvice">
                            <list>
                                <value>audit.adminExceptions.auditPermissionDenied</value>
                                <value>audit.adminExceptions.excludes</value>
                            </list>
                        </entry>
                        <entry key="clusterInfoRefresher">
                            <list>
                                <value>admin.esmInterfaceTag</value>
                            </list>
                        </entry>
                        <entry key="databaseReplicationMonitor">
                            <list>
                                <value>db.replicationDelayCheckInterval</value>
                                <value>db.replicationDelayThreshold</value>
                                <value>db.replicationErrorAuditInterval</value>
                            </list>
                        </entry>
                        <entry key="auditLookupPolicyEvaluator">
                            <list>
                                <value>audit.lookup.cache.messageSizeLimit</value>
                            </list>
                        </entry>
                    </map>
                </constructor-arg>
            </bean>
        </property>
        <property name="clusterPropertyCache" ref="clusterPropertyCache"/>
    </bean>

    <bean id="uncachedConfig" class="com.l7tech.util.ConfigFactory" factory-method="getUncachedConfig" autowire-candidate="false"/>

    <bean id="simplePropertyChangeHandler" class="com.l7tech.server.SimplePropertyChangeHandler"/>

    <bean id="managedServerConfig" class="com.l7tech.server.ServerConfig$ManagedServerConfig">
        <constructor-arg ref="serverConfig"/>
    </bean>

    <bean id="masterPasswordManager" class="com.l7tech.util.MasterPasswordManager" depends-on="systemProperties">
        <constructor-arg>
            <bean class="com.l7tech.util.DefaultMasterPasswordFinder">
                <constructor-arg value="file:${com.l7tech.server.configDirectory}${file.separator}omp.dat"/>
            </bean>
        </constructor-arg>
    </bean>

    <!-- Database password encryption, for reading passwords from cluster-wide sources ie cluster properties -->
    <bean id="dbPasswordEncryption" class="com.l7tech.util.MasterPasswordManager">
        <constructor-arg ref="clusterSharedKey"/>
    </bean>

    <!-- Current cluster shared key, as raw byte array -->
    <bean id="clusterSharedKey" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject" ref="sharedKeyManager"/>
        <property name="targetMethod" value="getSharedKey"/>
    </bean>

    <bean id="propertiesDecryptor" class="com.l7tech.server.util.PropertiesDecryptor">
        <constructor-arg ref="masterPasswordManager"/>
        <property name="passwordProperties">
            <list>
                <value>node.cluster.pass</value>
                <value>node.db.config.main.pass</value>
            </list>
        </property>
    </bean>

    <!-- TODO cachingRoleManager? -->
    <bean id="roleManager" class="com.l7tech.server.security.rbac.RoleManagerImpl" parent="hibernateBean">
        <property name="rbacServices">
            <bean class="com.l7tech.gateway.common.spring.factory.config.LazyProxyFactoryBean">
                <constructor-arg value="rbacServices"/>
                <constructor-arg value="com.l7tech.server.security.rbac.RbacServices"/>
            </bean>
         </property>
    </bean>
    <bean id="rbacServices" class="com.l7tech.server.util.EntityCachingFactoryBean">
        <constructor-arg>
            <null/>
        </constructor-arg>
        <constructor-arg value="RbacServices"/>
        <constructor-arg value="com.l7tech.server.security.rbac.RbacServices"/>
        <constructor-arg>
            <bean class="com.l7tech.server.security.rbac.RbacServicesImpl">
                <property name="roleManager" ref="roleManager"/>
                <property name="entityFinder" ref="entityFinder"/>
            </bean>
        </constructor-arg>
    </bean>

    <!-- server side identity provider factory -->
    <bean id="identityProviderFactory" class="com.l7tech.server.identity.IdentityProviderFactory">
        <constructor-arg ref="identityProviderConfigManager"/>
    </bean>

    <!-- server side identity configuration manager -->
    <bean id="identityProviderConfigManager" class="com.l7tech.server.identity.IdProvConfManagerServer"
          parent="hibernateBean">
        <property name="roleManager" ref="roleManager"/>
    </bean>

    <!--
        Internal Identity Provider, UserManager and GroupManager

        The factory method with support with construction arguments. The bean must be instantiated
        programatically with the required runtime construction arguments (IdentityProviderConfig)
        See IdentityProviderFactory implementation.
    -->
    <bean id="internalIdentityProviderFactory" class="com.l7tech.server.identity.GenericIdentityProviderFactorySpi">
        <constructor-arg value="com.l7tech.server.identity.internal.InternalIdentityProviderImpl"/>
        <constructor-arg value="internalIdentityProvider"/>
    </bean>
    <bean id="internalIdentityProvider" class="com.l7tech.server.identity.internal.InternalIdentityProviderImpl"
          scope="prototype">
        <property name="clientCertManager" ref="clientCertManager"/>
        <property name="certificateAuthenticator" ref="certificateAuthenticator"/>
        <property name="userManager" ref="internalUserManager"/>
        <property name="groupManager" ref="internalGroupManager"/>
        <property name="passwordHasher" ref="passwordHasher"/>
    </bean>
    <bean name="internalUserManager" class="com.l7tech.server.identity.internal.InternalUserManagerImpl"
          scope="prototype" parent="hibernateBean">
        <constructor-arg ref="roleManager"/>
        <constructor-arg ref="clientCertManager"/>
        <constructor-arg ref="logonManager"/>
        <constructor-arg ref="passwordHasher"/>
        <constructor-arg>
            <bean class="com.l7tech.server.identity.internal.InternalUserPasswordManagerImpl">
                <constructor-arg ref="serverConfig"/>
                <constructor-arg ref="passwordHasher"/>
            </bean>
        </constructor-arg>
    </bean>
    <bean name="internalGroupManager" class="com.l7tech.server.identity.internal.InternalGroupManagerImpl"
          scope="prototype" parent="hibernateBean">
        <constructor-arg ref="roleManager"/>
    </bean>

    <!-- Federated Identity Provider, UserManager and GroupManager factories -->
    <bean id="federatedIdentityProviderFactory" class="com.l7tech.server.identity.GenericIdentityProviderFactorySpi">
        <constructor-arg value="com.l7tech.server.identity.fed.FederatedIdentityProviderImpl"/>
        <constructor-arg value="federatedIdentityProvider"/>
    </bean>
    <bean id="federatedIdentityProvider" class="com.l7tech.server.identity.fed.FederatedIdentityProviderImpl"
          scope="prototype">
        <property name="clientCertManager" ref="clientCertManager"/>
        <property name="trustedCertManager" ref="trustedCertManager"/>
        <property name="trustedCertServices" ref="trustedCertServices"/>
        <property name="certValidationProcessor" ref="certValidationProcessor"/>
        <property name="userManager" ref="federatedUserManager"/>
        <property name="groupManager" ref="federatedGroupManager"/>
    </bean>
    <bean name="federatedUserManager" class="com.l7tech.server.identity.fed.FederatedUserManagerImpl" scope="prototype"
          parent="hibernateBean">
        <constructor-arg ref="clientCertManager"/>
        <constructor-arg ref="logonManager"/>
    </bean>
    <bean name="federatedGroupManager" class="com.l7tech.server.identity.fed.FederatedGroupManagerImpl"
          scope="prototype" parent="hibernateBean"/>

    <!-- LDAP IdentityProvider, UserManager and GroupManager factories -->
    <bean id="ldapIdentityProviderFactory" class="com.l7tech.server.identity.GenericIdentityProviderFactorySpi">
        <constructor-arg value="com.l7tech.server.identity.ldap.LdapIdentityProviderImpl"/>
        <constructor-arg value="ldapIdentityProvider"/>
    </bean>
    <bean id="ldapRuntimeConfig" class="com.l7tech.server.identity.ldap.LdapRuntimeConfig">
        <constructor-arg index="0" ref="serverConfig"/>
    </bean>
    <bean id="ldapIdentityProvider" class="com.l7tech.server.identity.ldap.LdapIdentityProviderImpl" scope="prototype">
        <property name="clientCertManager" ref="clientCertManager"/>
        <property name="ldapRuntimeConfig" ref="ldapRuntimeConfig"/>
        <property name="certificateAuthenticator" ref="certificateAuthenticator"/>
        <property name="userManager">
            <bean class="com.l7tech.server.identity.ldap.LdapUserManagerImpl" scope="prototype">
                <property name="ldapRuntimeConfig" ref="ldapRuntimeConfig"/>
            </bean>
        </property>
        <property name="groupManager">
            <bean class="com.l7tech.server.identity.ldap.LdapGroupManagerImpl" scope="prototype">
                <property name="ldapRuntimeConfig" ref="ldapRuntimeConfig"/>
            </bean>
        </property>
        <property name="configManager" ref="identityProviderConfigManager"/>
    </bean>

    <!--
      LDAP classloader pointcut is on any bean annotated with @LdapClassLoaderRequired.
    -->
    <bean id="ldapClassLoaderPointcut" class="com.l7tech.server.util.AnnotationPointcut">
        <constructor-arg index="0">
            <list>
                <value>com.l7tech.server.identity.ldap.LdapClassLoaderRequired</value>
            </list>
        </constructor-arg>
        <constructor-arg index="1">
            <list/>
        </constructor-arg>
        <constructor-arg index="2" value="false"/>
        <constructor-arg index="3" value="30100"/>
        <!-- inside transaction -->
    </bean>

    <bean id="ldapClassLoaderAdvice" class="com.l7tech.server.identity.ldap.LdapClassLoaderMethodInterceptor">
    </bean>

    <bean id="ldapClassLoaderAdvisor" class="org.springframework.aop.support.DefaultPointcutAdvisor">
        <property name="pointcut" ref="ldapClassLoaderPointcut"/>
        <property name="advice" ref="ldapClassLoaderAdvice"/>
    </bean>

    <!-- Simplified bind-only non-listable LDAP identity provider  -->
    <bean id="bindOnlyLdapIdentityProviderFactory" class="com.l7tech.server.identity.GenericIdentityProviderFactorySpi">
        <constructor-arg value="com.l7tech.server.identity.ldap.BindOnlyLdapIdentityProviderImpl"/>
        <constructor-arg value="bindOnlyLdapIdentityProvider"/>
    </bean>
    <bean id="bindOnlyLdapIdentityProvider" class="com.l7tech.server.identity.ldap.BindOnlyLdapIdentityProviderImpl" scope="prototype">
        <property name="ldapRuntimeConfig" ref="ldapRuntimeConfig"/>
        <property name="userManager">
            <bean class="com.l7tech.server.identity.ldap.BindOnlyLdapUserManagerImpl" scope="prototype">
                <property name="ldapRuntimeConfig" ref="ldapRuntimeConfig"/>
            </bean>
        </property>
        <property name="groupManager">
            <bean class="com.l7tech.server.identity.ldap.BindOnlyLdapGroupManagerImpl" scope="prototype"/>
        </property>
    </bean>

    <!-- server side Cluster ID manager -->
    <bean id="clusterIDManager" class="com.l7tech.server.cluster.ClusterIDManager">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>
    <!-- server side Cluster Info manager -->
    <bean id="clusterInfoManager" class="com.l7tech.server.cluster.ClusterInfoManagerImpl"
          depends-on="clusterPropertyCache">
        <constructor-arg index="0" ref="clusterNodeId"/>
        <property name="sessionFactory" ref="sessionFactory"/>
        <property name="serverConfig" ref="serverConfig"/>
    </bean>
    <bean id="clusterInfoRefresher" class="com.l7tech.server.cluster.ClusterInfoRefresher"/>
    <!-- server side Service Usage  manager -->
    <bean id="serviceUsageManager" class="com.l7tech.server.cluster.ServiceUsageManagerImpl">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>
    <!-- server side DistributedMessageIdManager -->
    <bean id="distributedMessageIdManager" class="com.l7tech.server.cluster.DistributedMessageIdManager">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="clusterNodeId"/>
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <bean id="counterManager" class="com.l7tech.server.sla.CounterManagerImpl">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <!-- Logon service that monitors the login attempts in the SSM -->
    <bean id="logonService" class="com.l7tech.server.logon.SSMLogonService">
        <constructor-arg ref="transactionManager"/>
        <constructor-arg ref="logonManager"/>
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="roleManager"/>
        <constructor-arg ref="identityProviderFactory"/>
    </bean>

    <!-- logon manager handles the persistence of login attempts information to the database layer -->
    <bean id="logonManager" class="com.l7tech.server.logon.LogonInfoManagerImpl" parent="hibernateBean"/>

    <bean id="stigPasswordPolicy" class="com.l7tech.identity.IdentityProviderPasswordPolicy">
        <constructor-arg index="0" value="true"/>
        <!-- forcePasswordChange -->
        <constructor-arg index="1" value="true"/>
        <!-- noRepeatingCharacters -->
        <constructor-arg index="2" value="8"/>
        <!-- minPasswordLength -->
        <constructor-arg index="3" value="0"/>
        <!-- maxPasswordLength -->
        <constructor-arg index="4" value="1"/>
        <!-- minUpperCharacters -->
        <constructor-arg index="5" value="1"/>
        <!-- minLowerCharacters -->
        <constructor-arg index="6" value="1"/>
        <!-- minNumberCharacters -->
        <constructor-arg index="7" value="1"/>
        <!-- minSymbolCharacters -->
        <constructor-arg index="8" value="0"/>
        <!-- minNonNumberCharacters -->
        <constructor-arg index="9" value="4"/>
        <!-- minCharacterDifference -->
        <constructor-arg index="10" value="10"/>
        <!-- passwordRepeatFrequency -->
        <constructor-arg index="11" value="90"/>
        <!-- passwordExpiryDays -->
        <constructor-arg index="12" value="true"/>
        <!-- passwordChangeDaily -->
    </bean>

    <bean id="pcidssPasswordPolicy" class="com.l7tech.identity.IdentityProviderPasswordPolicy">
        <constructor-arg index="0" value="true"/>
        <!-- forcePasswordChange -->
        <constructor-arg index="1" value="false"/>
        <!-- noRepeatingCharacters -->
        <constructor-arg index="2" value="7"/>
        <!-- minPasswordLength -->
        <constructor-arg index="3" value="0"/>
        <!-- maxPasswordLength -->
        <constructor-arg index="4" value="1"/>
        <!-- minUpperCharacters -->
        <constructor-arg index="5" value="1"/>
        <!-- minLowerCharacters -->
        <constructor-arg index="6" value="1"/>
        <!-- minNumberCharacters -->
        <constructor-arg index="7" value="0"/>
        <!-- minSymbolCharacters -->
        <constructor-arg index="8" value="0"/>
        <!-- minNonNumberCharacters -->
        <constructor-arg index="9" value="0"/>
        <!-- minCharacterDifference -->
        <constructor-arg index="10" value="4"/>
        <!-- passwordRepeatFrequency -->
        <constructor-arg index="11" value="90"/>
        <!-- passwordExpiryDays -->
        <constructor-arg index="12" value="false"/>
        <!-- passwordChangeDaily -->
    </bean>

    <!-- password enforcer to enforce the password constraints -->
    <bean id="passwordEnforcerManager" class="com.l7tech.server.security.PasswordEnforcerManager">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="passwordPolicyManger"/>
        <constructor-arg ref="roleManager"/>
        <constructor-arg ref="passwordHasher"/>
        <constructor-arg ref="stigPasswordPolicy"/>
        <constructor-arg ref="pcidssPasswordPolicy"/>
    </bean>

    <bean id="passwordPolicyManger" class="com.l7tech.server.identity.IdentityProviderPasswordPolicyManagerImpl"
          parent="hibernateBean"/>

    <!-- server side policy factory -->
    <bean id="policyFactory" class="com.l7tech.server.policy.ServerPolicyFactory">
        <constructor-arg ref="licenseManager"/>
        <constructor-arg ref="injector"/>
    </bean>

    <bean id="resolutionConfigurationManager" class="com.l7tech.server.transport.ResolutionConfigurationManagerImpl"
          parent="hibernateBean"/>

    <bean id="serviceResolutionManager" class="com.l7tech.server.service.resolution.ServiceResolutionManager">
        <constructor-arg index="0" ref="resolutionConfigurationManager"/>
        <constructor-arg index="1" value="Default"/>
        <constructor-arg index="2">
            <list>
                <!-- The RequirePathResolver must come first -->
                <bean class="com.l7tech.server.service.resolution.RequirePathResolver">
                    <constructor-arg ref="auditFactory"/>
                </bean>
                <bean class="com.l7tech.server.service.resolution.ServiceOidResolver">
                    <constructor-arg ref="auditFactory"/>
                </bean>
                <bean class="com.l7tech.server.service.resolution.UriResolver">
                    <constructor-arg ref="auditFactory"/>
                </bean>
                <bean class="com.l7tech.server.service.resolution.CaseInsensitiveUriResolver">
                    <constructor-arg ref="auditFactory"/>
                </bean>
                <bean class="com.l7tech.server.service.resolution.SoapActionResolver">
                    <constructor-arg ref="auditFactory"/>
                </bean>
                <bean class="com.l7tech.server.service.resolution.UrnResolver">
                    <constructor-arg ref="auditFactory"/>
                </bean>
            </list>
        </constructor-arg>
        <constructor-arg index="3">
            <list>
                <bean class="com.l7tech.server.service.resolution.SoapVersionResolver">
                    <constructor-arg ref="auditFactory"/>
                </bean>
                <bean class="com.l7tech.server.service.resolution.SoapOperationResolver">
                    <constructor-arg ref="auditFactory"/>
                    <constructor-arg ref="serviceDocumentManager"/>
                </bean>
            </list>
        </constructor-arg>
    </bean>

    <bean id="folderCache" class="com.l7tech.server.folder.FolderCacheImpl">
        <constructor-arg index="0" ref="folderManager"/>
    </bean>

    <!-- service cache -->
    <bean id="serviceCache" class="com.l7tech.server.service.ServiceCache"
          depends-on="wsdlStrategyServiceDocumentsInitializer">
        <constructor-arg index="0" ref="policyCache"/>
        <constructor-arg index="1" ref="transactionManager"/>
        <constructor-arg index="2" ref="serviceManager"/>
        <constructor-arg index="3" ref="serviceUsageManager"/>
        <constructor-arg index="4" ref="serviceResolutionManager"/>
        <constructor-arg index="5" ref="clusterInfoManager"/>
        <constructor-arg index="6">
            <bean class="com.l7tech.server.util.ManagedTimer">
                <constructor-arg value="Service cache refresh"/>
            </bean>
        </constructor-arg>
    </bean>
    <bean id="managedServiceCache" class="com.l7tech.server.service.ServiceCache$ManagedServiceCache">
        <constructor-arg ref="serviceCache"/>
    </bean>

    <bean id="wsmfService" class="com.l7tech.server.hpsoam.WSMFService">
        <constructor-arg ref="serviceManager"/>
        <constructor-arg ref="messageProcessor"/>
    </bean>

    <bean id="keyUsageChecker" class="com.l7tech.server.security.cert.GatewayKeyUsageChecker">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="clusterPropertyManager"/>
    </bean>

    <bean id="sslContextInitializer" class="com.l7tech.server.security.cert.SslContextInitializer" init-method="init">
        <constructor-arg index="0" ref="trustManager"/>
        <constructor-arg index="1" ref="ssgKeyStoreManager"/>    
        <constructor-arg index="2" ref="applicationEventProxy"/>
    </bean>

    <!-- general server side HTTP client trust manager -->
    <!--suppress SpringBeanConstructorArgInspection -->
    <bean id="trustManager" class="com.l7tech.server.transport.http.SslClientTrustManager" depends-on="keyUsageChecker">
        <constructor-arg ref="trustedCertServices"/>
        <constructor-arg ref="certValidationProcessor"/>
        <constructor-arg>
            <!--suppress SpringBeanConstructorArgInspection -->
            <bean class="com.l7tech.server.security.cert.CertValidationProcessor$Facility" factory-method="valueOf">
                <constructor-arg value="OTHER"/>
            </bean>
        </constructor-arg>
    </bean>

    <!-- server side HTTP routing client trust manager -->
    <!--suppress SpringBeanConstructorArgInspection -->
    <bean id="routingTrustManager" class="com.l7tech.server.transport.http.SslClientTrustManager"
          depends-on="keyUsageChecker">
        <constructor-arg ref="trustedCertServices"/>
        <constructor-arg ref="certValidationProcessor"/>
        <constructor-arg>
            <!--suppress SpringBeanConstructorArgInspection -->
            <bean class="com.l7tech.server.security.cert.CertValidationProcessor$Facility" factory-method="valueOf">
                <constructor-arg value="ROUTING"/>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="roleManagerHelper" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.security.rbac.RoleManagerImpl"/>
        <property name="targetMethod" value="setIdentitySource"/>
        <property name="arguments">
            <list>
                <ref bean="adminSessionManager"/>
            </list>
        </property>
    </bean>

    <!-- Initialize the client-side SSLSocketFactory with the trust manager -->
    <bean id="anonClientSocketFactoryInitializer" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.transport.http.AnonymousSslClientSocketFactory"/>
        <property name="targetMethod" value="setTrustManager"/>
        <property name="arguments">
            <list>
                <ref bean="trustManager"/>
            </list>
        </property>
    </bean>
    <bean id="anonClientHostnameAwareSocketFactoryInitializer"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass"
                  value="com.l7tech.server.transport.http.AnonymousSslClientHostnameAwareSocketFactory"/>
        <property name="targetMethod" value="setTrustManager"/>
        <property name="arguments">
            <list>
                <ref bean="trustManager"/>
            </list>
        </property>
    </bean>
    <bean id="anonClientHostnameAwareSocketFactoryHostnameVerifierInitializer"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass"
                  value="com.l7tech.server.transport.http.AnonymousSslClientHostnameAwareSocketFactory"/>
        <property name="targetMethod" value="setHostnameVerifier"/>
        <property name="arguments">
            <list>
                <ref bean="ldapHostnameVerifier"/>
                <!-- LDAP verifier -->
            </list>
        </property>
    </bean>
    <bean id="clientSocketFactoryInitializer" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.transport.http.SslClientSocketFactory"/>
        <property name="targetMethod" value="setTrustManager"/>
        <property name="arguments">
            <list>
                <ref bean="trustManager"/>
            </list>
        </property>
    </bean>
    <bean id="clientSocketFactoryKeyManagerInitializer" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.transport.http.SslClientSocketFactory"/>
        <property name="targetMethod" value="setDefaultKeyManagers"/>
        <property name="arguments">
            <list>
                <ref bean="sslKeyManagers"/>
            </list>
        </property>
    </bean>
    <bean id="clientHostnameAwareSocketFactoryInitializer"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.transport.http.SslClientHostnameAwareSocketFactory"/>
        <property name="targetMethod" value="setTrustManager"/>
        <property name="arguments">
            <list>
                <ref bean="trustManager"/>
            </list>
        </property>
    </bean>
    <bean id="clientHostnameAwareSocketFactoryKeyManagerInitializer"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.transport.http.SslClientHostnameAwareSocketFactory"/>
        <property name="targetMethod" value="setDefaultKeyManagers"/>
        <property name="arguments">
            <list>
                <ref bean="sslKeyManagers"/>
            </list>
        </property>
    </bean>
    <bean id="clientHostnameAwareSocketFactoryHostnameVerifierInitializer"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.transport.http.SslClientHostnameAwareSocketFactory"/>
        <property name="targetMethod" value="setHostnameVerifier"/>
        <property name="arguments">
            <list>
                <ref bean="ldapHostnameVerifier"/>
                <!-- LDAP verifier, since this is also used with LDAP -->
            </list>
        </property>
    </bean>

    <!-- SSL for Syslog -->
    <bean id="syslogClientSocketFactoryInitializer" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.log.syslog.impl.SyslogSslClientSupport"/>
        <property name="targetMethod" value="setTrustManager"/>
        <property name="arguments">
            <list>
                <ref bean="trustManager"/>
            </list>
        </property>
    </bean>
    <bean id="syslogClientSocketFactoryKeyManagerInitializer"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.log.syslog.impl.SyslogSslClientSupport"/>
        <property name="targetMethod" value="setDefaultKeyManagers"/>
        <property name="arguments">
            <list>
                <ref bean="sslKeyManagers"/>
            </list>
        </property>
    </bean>
    <bean id="syslogClientSocketFactoryKeyStoreManagerInitializer"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.log.syslog.impl.SyslogSslClientSupport"/>
        <property name="targetMethod" value="setSsgKeyStoreManager"/>
        <property name="arguments">
            <list>
                <ref bean="ssgKeyStoreManager"/>
            </list>
        </property>
    </bean>

    <!-- SSL for JMS -->
    <bean id="mqSocketFactoryInitializer" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.transport.jms.JmsSslCustomizerSupport"/>
        <property name="targetMethod" value="setTrustManager"/>
        <property name="arguments">
            <list>
                <ref bean="trustManager"/>
            </list>
        </property>
    </bean>
    <bean id="mqSocketFactoryKeyManagerInitializer" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.transport.jms.JmsSslCustomizerSupport"/>
        <property name="targetMethod" value="setSsgKeyStoreManager"/>
        <property name="arguments">
            <list>
                <ref bean="ssgKeyStoreManager"/>
            </list>
        </property>
    </bean>

    <!-- SSL for LDAP -->
    <bean id="ldapSocketFactoryInitializer" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.identity.ldap.LdapSslCustomizerSupport"/>
        <property name="targetMethod" value="setTrustManager"/>
        <property name="arguments">
            <list>
                <ref bean="trustManager"/>
            </list>
        </property>
    </bean>
    <bean id="ldapSocketFactoryKeyManagerInitializer" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.identity.ldap.LdapSslCustomizerSupport"/>
        <property name="targetMethod" value="setSsgKeyStoreManager"/>
        <property name="arguments">
            <list>
                <ref bean="ssgKeyStoreManager"/>
            </list>
        </property>
    </bean>
    <bean id="ldapSocketFactoryHostnameVerifierInitializer"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.identity.ldap.LdapSslCustomizerSupport"/>
        <property name="targetMethod" value="setHostnameVerifier"/>
        <property name="arguments">
            <list>
                <ref bean="ldapHostnameVerifier"/>
            </list>
        </property>
    </bean>

    <!-- server side HTTP routing hostname verifier -->
    <bean id="hostnameVerifier" class="com.l7tech.server.transport.http.SslClientHostnameVerifier">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="trustedCertServices"/>
    </bean>

    <!-- server side LDAP hostname verifier -->
    <bean id="ldapHostnameVerifier" class="com.l7tech.server.transport.http.SslClientHostnameVerifier">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="trustedCertServices"/>
        <constructor-arg value="true"/>
    </bean>

    <bean id="httpConnectionIdleTimeoutManager" class="com.l7tech.server.transport.http.HttpConnectionIdleTimeoutManager">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1">
            <bean class="com.l7tech.server.util.ManagedTimer">
                <constructor-arg value="HTTP Connection Idle Timeout"/>
            </bean>
        </constructor-arg>
    </bean>

    <!-- server side HTTP routing HTTP client factory -->
    <bean id="httpRoutingHttpClientFactory"
          class="com.l7tech.server.util.IdentityBindingHttpClientFactory"
          scope="prototype">
        <property name="connectionManagerParameters">
            <map>
                <entry key="http.connection.stalecheck">
                    <value type="java.lang.Boolean">true</value>
                </entry>
            </map>
        </property>
        <property name="listener" ref="httpConnectionIdleTimeoutManager"/>
    </bean>

    <!-- SSL hostname verifier for internode communication -->
    <bean id="internodeHostnameVerifier" class="com.l7tech.server.transport.http.InternodeSslClientHostnameVerifier">
        <constructor-arg ref="defaultKey"/>
    </bean>

    <!-- HTTP client factory for internode communication -->
    <bean id="internodeHttpClientFactory" class="com.l7tech.server.util.HttpClientFactory">
        <constructor-arg ref="defaultKey"/>
        <constructor-arg ref="trustManager"/>
        <constructor-arg ref="internodeHostnameVerifier"/>
    </bean>

    <!-- server side service manager -->
    <bean id="serviceManager" class="com.l7tech.server.service.ServiceManagerImp" parent="hibernateBean">
        <constructor-arg ref="roleManager"/>
        <constructor-arg ref="serviceAliasManager"/>
    </bean>

    <!--service side service alias manager-->
    <bean id="serviceAliasManager" class="com.l7tech.server.service.ServiceAliasManagerImpl" parent="hibernateBean"/>

    <!-- server side trusted cert manager -->
    <bean id="trustedCertManager" class="com.l7tech.server.identity.cert.TrustedCertManagerImp"
          parent="hibernateBean" depends-on="clusterPropertyCache">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg>
            <bean class="com.l7tech.server.util.ManagedTimer">
                <constructor-arg value="Trusted Certificate Expiry Checker"/>
            </bean>
        </constructor-arg>
        <constructor-arg ref="clusterInfoManager"/>
    </bean>
    <bean id="trustedCertCache" class="com.l7tech.server.util.EntityCachingFactoryBean">
        <constructor-arg>
            <null/>
        </constructor-arg>
        <constructor-arg value="TrustedCertCache"/>
        <constructor-arg value="com.l7tech.server.identity.cert.TrustedCertCache"/>
        <constructor-arg>
            <bean class="com.l7tech.server.identity.cert.TrustedCertCacheImpl">
                <constructor-arg ref="trustedCertManager"/>
            </bean>
        </constructor-arg>
    </bean>

    <!-- server side TrustedCert services layer -->
    <bean id="trustedCertServices" class="com.l7tech.server.identity.cert.TrustedCertServicesImpl">
        <constructor-arg ref="trustedCertCache"/>
    </bean>

    <!-- server side revocation check policy manager -->
    <bean id="revocationCheckPolicyManager" class="com.l7tech.server.identity.cert.RevocationCheckPolicyManagerImpl"
          parent="hibernateBean"/>

    <!-- server side SampleMessage manager -->
    <bean id="sampleMessageManager" class="com.l7tech.server.service.SampleMessageManagerImp" parent="hibernateBean"/>
    <!-- server side ServiceDocumentManager manager -->
    <bean id="serviceDocumentManager" class="com.l7tech.server.service.ServiceDocumentManagerImpl"
          parent="hibernateBean"/>
    <!-- server side custom assertions registrar -->
    <bean id="customAssertionRegistrar" class="com.l7tech.server.policy.custom.CustomAssertionsRegistrarImpl">
        <constructor-arg ref="assertionRegistry"/>
        <property name="serverConfig" ref="serverConfig"/>
    </bean>
    <!-- jms connection manager -->
    <bean id="jmsConnectionManager" class="com.l7tech.server.transport.jms.JmsConnectionManagerImpl"
          parent="hibernateBean">
        <property name="jmsEndpointManager" ref="jmsEndpointManager"/>
    </bean>
    <!-- jms endpoint manager -->
    <bean id="jmsEndpointManager" class="com.l7tech.server.transport.jms.JmsEndpointManagerImpl" parent="hibernateBean"
          depends-on="jmsInit">
    </bean>
    <!-- jms property resolver -->
    <bean id="jmsPropertyMapper" class="com.l7tech.server.transport.jms.JmsPropertyMapper">
        <constructor-arg ref="trustedCertManager"/>
        <constructor-arg ref="defaultKey"/>
    </bean>
    <bean id="jmsResourceManager" class="com.l7tech.server.transport.jms2.JmsResourceManager">
        <constructor-arg index="0" value="JmsRouting"/>
        <constructor-arg index="1" ref="serverConfig"/>
    </bean>

    <!-- server side policy validator -->
    <bean id="serverPolicyValidator" class="com.l7tech.server.policy.validator.ServerPolicyValidator">
        <constructor-arg ref="policyManager"/>
        <constructor-arg ref="policyPathBuilderFactory"/>
        <property name="jmsEndpointManager" ref="jmsEndpointManager"/>
        <property name="identityProviderFactory" ref="identityProviderFactory"/>
        <property name="resourceEntryManager" ref="resourceEntryManager"/>
        <property name="clientCertManager" ref="clientCertManager"/>
        <property name="entityFinder" ref="entityFinder"/>
        <property name="ssgKeyStoreManager" ref="ssgKeyStoreManager"/>
        <property name="jdbcConnectionManager" ref="jdbcConnectionManager"/>
        <property name="config" ref="serverConfig"/>
    </bean>

    <!-- server side policy filter manager  -->
    <bean id="policyFilterManager" class="com.l7tech.server.policy.filter.FilterManager">
        <constructor-arg ref="identityProviderFactory"/>
        <constructor-arg>
            <list>
                <value>com.l7tech.server.policy.filter.HideDisabledAssertions</value>
                <value>com.l7tech.server.policy.filter.IdentityRule</value>
                <value>com.l7tech.server.policy.filter.HideUnsupportedClientAssertions</value>
            </list>
        </constructor-arg>
    </bean>

    <!-- server side policy filter manager for WS-SecurityPolicies -->
    <bean id="wsspolicyFilterManager" class="com.l7tech.server.policy.filter.FilterManager">
        <constructor-arg ref="identityProviderFactory"/>
        <constructor-arg>
            <list>
                <value>com.l7tech.server.policy.filter.HideDisabledAssertions</value>
                <value>com.l7tech.server.policy.filter.HideUnsupportedClientAssertions</value>
            </list>
        </constructor-arg>
    </bean>

    <!-- server side client cert manager -->
    <bean id="clientCertManager" class="com.l7tech.server.identity.cert.ClientCertManagerImp">
        <constructor-arg ref="defaultKey"/>
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <!-- server side audit archiver -->
    <bean id="auditArchiver" class="com.l7tech.server.audit.AuditArchiver">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="clusterPropertyManager"/>
        <constructor-arg index="2" ref="transactionManager"/>
        <constructor-arg index="3" ref="auditRecordManager"/>
        <constructor-arg index="4" ref="auditArchiveReceiver"/>
        <constructor-arg index="5" ref="auditFactory"/>
        <constructor-arg index="6" value="#{'mysql'.equals(hibernateProperties['node.db.type'])}"/><!-- only enabled for a MySQL DB-->
    </bean>

    <bean id="auditArchiveReceiver" class="com.l7tech.server.audit.FtpArchiveReceiver">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="clusterPropertyManager"/>
        <constructor-arg ref="auditExporter"/>
        <constructor-arg ref="trustManager"/>
        <constructor-arg ref="hostnameVerifier"/>
        <constructor-arg ref="defaultKey"/>
    </bean>

    <!-- Checking Audit Cluster Properties -->
    <bean id="auditClusterPropertiesChecker" class="com.l7tech.server.audit.AuditClusterPropertiesChecker">
        <constructor-arg ref="uncachedConfig"/>
        <constructor-arg ref="entityVersionCheckerTimer"/>
    </bean>

    <!-- server side audit record manager -->
    <bean id="auditRecordManager" class="com.l7tech.server.audit.AuditRecordManagerImpl" parent="hibernateBean">
        <property name="serverConfig" ref="serverConfig"/>
    </bean>

    <!-- server side audit download manager -->
    <bean id="auditDownloadManager" class="com.l7tech.server.audit.AuditDownloadManager">
        <constructor-arg ref="defaultKey"/>
    </bean>
    <!-- server side audit exporter -->
    <bean id="auditExporter" class="com.l7tech.server.audit.AuditExporterImpl" scope="prototype">
        <constructor-arg index="0" ref="auditExporterDbDialect"/>
        <property name="sessionFactory" ref="sessionFactory"/>
        <property name="config" ref="serverConfig"/>
    </bean>
    <!-- server side audit message factory -->
    <bean id="messageSummaryAuditFactory" class="com.l7tech.server.audit.MessageSummaryAuditFactory">
        <constructor-arg ref="clusterNodeId"/>
        <property name="identityProviderFactory" ref="identityProviderFactory"/>
    </bean>

    <!-- keystore root cert and ssl config  -->
    <bean id="defaultKey" class="com.l7tech.server.DefaultKeyImpl"
          depends-on="keyUsageChecker ssgKeyStoreManager clusterPropertyCache">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="clusterPropertyManager"/>
        <constructor-arg index="2" ref="ssgKeyStoreManager"/>
        <constructor-arg index="3" ref="transactionManager"/>
    </bean>
    <bean id="keystoreMutatorSwitch"
          class="com.l7tech.server.security.keystore.JdkKeyStoreBackedSsgKeyStore$StartupListener"/>

    <!-- TODO sslKeyEntry, sslKeystoreCertificate, and sslKeyManagers should be removed so the default SSL key can be changed without a restart -->
    <bean id="sslKeyEntry" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetObject" ref="defaultKey"/>
        <property name="targetMethod" value="getSslInfo"/>
        <property name="objectType" value="com.l7tech.gateway.common.security.keystore.SsgKeyEntry"/>
    </bean>

    <bean id="sslKeystoreCertificate" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetObject" ref="sslKeyEntry"/>
        <property name="targetMethod" value="getCertificate"/>
        <property name="objectType" value="java.security.cert.X509Certificate"/>
    </bean>

    <bean id="sslKeyManagers" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetObject" ref="defaultKey"/>
        <property name="targetMethod" value="getSslKeyManagers"/>
        <property name="objectType" value="javax.net.ssl.KeyManager[]"/>
    </bean>

    <bean id="nodeProperties"
          class="com.l7tech.server.util.PasswordDecryptingPropertiesFactoryBean"
          depends-on="systemProperties">
        <constructor-arg ref="propertiesDecryptor"/>
        <property name="ignoreResourceNotFound" value="true"/>
        <property name="locations">
            <list>
                <value>file:${com.l7tech.server.configDirectory}${file.separator}node.properties</value>
            </list>
        </property>
    </bean>

    <!-- server Wss Decorator -->
    <bean id="wssDecorator" class="com.l7tech.security.xml.decorator.WssDecoratorImpl">
        <property name="encryptedKeyCache" ref="encryptedKeyCache"/>
    </bean>

    <!-- server Message Processor -->
    <bean id="messageProcessor" class="com.l7tech.server.MessageProcessor">
        <constructor-arg ref="serviceCache"/>
        <constructor-arg ref="policyCache"/>
        <constructor-arg ref="wssDecorator"/>
        <constructor-arg ref="securityTokenResolver"/>
        <constructor-arg ref="securityContextFinder"/>
        <constructor-arg ref="licenseManager"/>
        <constructor-arg ref="serviceMetricsServices"/>
        <constructor-arg ref="auditContextFactory"/>
        <constructor-arg ref="messageSummaryAuditFactory"/>
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="trafficLogger"/>
        <constructor-arg ref="messageProcessingEventChannel"/>
    </bean>
    <!-- server side policy service -->
    <bean id="policyService" class="com.l7tech.server.policy.PolicyService">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="defaultKey"/>
        <constructor-arg index="2" ref="policyFactory"/>
        <constructor-arg index="3" ref="policyFilterManager"/>
        <constructor-arg index="4" ref="securityTokenResolver"/>
        <constructor-arg index="5" ref="policyPathBuilderFactory"/>
        <constructor-arg index="6" ref="securityContextFinder"/>
    </bean>
    <!-- server side token service -->
    <bean id="tokenService" class="com.l7tech.server.TokenServiceImpl">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="defaultKey"/>
        <constructor-arg ref="policyFactory"/>
        <constructor-arg ref="securityTokenResolver"/>
        <constructor-arg ref="inboundSecureConversationContextManager"/>
    </bean>

    <bean id="auditContextFactory" class="com.l7tech.server.audit.AuditContextFactory">
        <constructor-arg ref="auditLogListener"/>
    </bean>

    <bean id="activateServerAuditContextFactory" class="com.l7tech.server.audit.AuditContextFactoryActivator" depends-on="cryptoInit">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="auditContextFactory"/>
        <constructor-arg index="2" ref="auditRecordManager"/>
        <constructor-arg index="3" ref="clusterNodeId"/>
        <constructor-arg index="4" ref="defaultKey"/>
        <constructor-arg index="5" ref="auditPolicyEvaluator"/>
        <constructor-arg index="6" ref="auditFilterPolicyManager"/>
    </bean>

    <!-- server side Status Update Manager -->
    <bean id="statusUpdateManager" class="com.l7tech.server.cluster.StatusUpdateManagerImpl">
        <constructor-arg ref="clusterInfoManager"/>
        <constructor-arg ref="serviceCache"/>
        <constructor-arg ref="serviceUsageManager"/>
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <!-- Status Update Manager Task Scheduler -->
    <bean id="statusUpdateManagerSchedulerTask" class="org.springframework.scheduling.timer.ScheduledTimerTask"
          depends-on="clusterBoot">
        <!-- wait 10 seconds before starting repeated execution -->
        <property name="delay" value="8000"/>
        <!-- 8 seconds -->
        <property name="period" value="4000"/>
        <!-- repeat every 4 seconds -->
        <property name="timerTask">
            <!-- server side Status Update Manager Scheduled Task -->
            <bean class="org.springframework.scheduling.timer.MethodInvokingTimerTaskFactoryBean">
                <property name="targetObject" ref="statusUpdateManager"/>
                <property name="targetMethod" value="update"/>
            </bean>
        </property>
    </bean>
    <!-- server side Task Scheduler -->
    <bean class="org.springframework.scheduling.timer.TimerFactoryBean">
        <property name="scheduledTimerTasks">
            <list>
                <ref local="statusUpdateManagerSchedulerTask"/>
            </list>
        </property>
    </bean>

    <bean id="messageProcessingAuditListener" class="com.l7tech.server.audit.MessageProcessingAuditListener">
        <constructor-arg index="0" ref="messageSummaryAuditFactory"/>
        <constructor-arg index="1" ref="messageProcessingEventChannel"/>
    </bean>

    <bean id="adminAuditListener" class="com.l7tech.server.audit.AdminAuditListener">
        <constructor-arg ref="clusterNodeId"/>
        <constructor-arg ref="auditContextFactory"/>
    </bean>

    <bean id="systemAuditListener" class="com.l7tech.server.audit.SystemAuditListener">
        <constructor-arg ref="clusterNodeId"/>
        <constructor-arg ref="auditContextFactory"/>
    </bean>

    <bean id="schemaConfiguration" class="com.l7tech.server.communityschemas.SchemaConfiguration"
          depends-on="clusterPropertyManager">
        <constructor-arg ref="serverConfig"/>
    </bean>

    <bean id="schemaMaintenanceTimer" class="com.l7tech.server.util.ManagedTimer">
        <constructor-arg value="Schema cache maintenance"/>
    </bean>

    <bean id="resourceEntrySchemaSourceResolver"
          class="com.l7tech.server.globalresources.ResourceEntrySchemaSourceResolver">
        <constructor-arg index="0" ref="resourceEntryManager"/>
    </bean>

    <bean id="schemaManager" class="com.l7tech.server.communityschemas.SchemaManagerImpl">
        <constructor-arg index="0" ref="schemaConfiguration"/>
        <constructor-arg index="1" ref="schemaMaintenanceTimer"/>
        <constructor-arg index="2">
            <list>
                <ref bean="resourceEntrySchemaSourceResolver"/>
                <bean class="com.l7tech.server.communityschemas.HttpSchemaSourceResolver">
                    <constructor-arg index="0" ref="schemaConfiguration"/>
                    <constructor-arg index="1" ref="httpClientFactory"/>
                    <constructor-arg index="2" ref="resourceEntrySchemaSourceResolver"/>
                </bean>
            </list>
        </constructor-arg>
        <constructor-arg index="3" ref="resourceEntrySchemaSourceResolver"/>
    </bean>

    <bean id="schemaResourceManager" class="com.l7tech.server.globalresources.SchemaResourceManager">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="schemaMaintenanceTimer"/>
        <constructor-arg index="2" ref="resourceEntryManager"/>
        <constructor-arg index="3" ref="schemaManager"/>
    </bean>

    <bean id="resourceEntryManager" class="com.l7tech.server.globalresources.ResourceEntryManagerImpl"
          parent="hibernateBean">
    </bean>

    <bean id="uddiTemplateManager" class="com.l7tech.server.uddi.UDDITemplateManager">
        <constructor-arg ref="serverConfig"/>
    </bean>

    <bean id="aggregator" class="com.l7tech.server.wsdm.Aggregator"/>

    <bean id="gatewaySanityChecker" class="com.l7tech.server.util.GatewaySanityChecker" depends-on="cryptoInit">
        <constructor-arg ref="transactionManager"/>
        <constructor-arg ref="clusterPropertyManager"/>
        <property name="earlyTasks">
            <list>
                <bean class="com.l7tech.server.security.keystore.DefaultKeystoreFilePopulator">
                    <property name="sessionFactory" ref="sessionFactory"/>
                </bean>
            </list>
        </property>
    </bean>

    <bean id="trustedSecurityTokenResolver" class="com.l7tech.server.TrustedCertificateResolver">
        <constructor-arg index="0" ref="trustedCertManager"/>
        <constructor-arg index="1" ref="serverConfig"/>
        <constructor-arg index="2" ref="ssgKeyStoreManager"/>
    </bean>

    <bean id="jdbcConnectionResolver" class="com.l7tech.server.JdbcConnectionResolver">
        <constructor-arg index="0" ref="jdbcConnectionManager"/>
        <constructor-arg index="1" ref="jdbcConnectionPoolManager"/>
    </bean>

    <bean id="identityProviderSecurityTokenResolver" class="com.l7tech.server.IdentityProviderSecurityTokenResolver">
        <constructor-arg index="0" ref="identityProviderFactory"/>
    </bean>

    <bean id="userSecurityTokenResolver" class="com.l7tech.server.UserCertificateResolver">
        <constructor-arg index="0" ref="clientCertManager"/>
    </bean>

    <bean id="securityTokenResolver" class="com.l7tech.security.xml.DelegatingSecurityTokenResolver" primary="true">
        <constructor-arg index="0">
            <list>
                <ref local="trustedSecurityTokenResolver"/>
                <ref local="identityProviderSecurityTokenResolver"/>
                <ref local="userSecurityTokenResolver"/>
            </list>
        </constructor-arg>
    </bean>

    <alias name="securityTokenResolver" alias="encryptedKeyCache"/>

    <bean id="licenseManager" class="com.l7tech.server.GatewayLicenseManager" depends-on="systemAuditListener">
        <constructor-arg ref="clusterPropertyManager"/>
    </bean>

    <bean id="certificateAuthenticator" class="com.l7tech.server.identity.cert.CertificateAuthenticator">
        <constructor-arg ref="clientCertManager"/>
        <constructor-arg ref="certValidationProcessor"/>
    </bean>

    <!--
    The MAC of this cluster node, so that we don't need to throw the whole
    ClusterInfoManager around
    -->
    <bean id="clusterNodeId" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject" ref='clusterIDManager'/>
        <property name="targetMethod" value="thisNodeId"/>
    </bean>

    <bean id="clusterMaster" class="com.l7tech.server.cluster.ClusterMaster">
        <constructor-arg index="0" ref="transactionManager"/>
        <constructor-arg index="1" ref="hibernateDataSource"/>
        <constructor-arg index="2" ref="serverConfig"/>
        <constructor-arg index="3">
            <bean class="com.l7tech.server.util.ManagedTimer">
                <constructor-arg value="ClusterMasterChecker"/>
            </bean>
        </constructor-arg>
        <constructor-arg index="4" ref="clusterNodeId"/>
    </bean>
    <bean id="databaseReplicationMonitor" class="com.l7tech.server.cluster.DatabaseReplicationMonitor"
          init-method="init">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="clusterMaster"/>
        <constructor-arg index="2" value="#{hibernateProperties['l7.database.main.description']}"/>
        <constructor-arg index="3" ref="primaryDbDataSource"/>
        <constructor-arg index="4" value="#{hibernateProperties['l7.database.failover.description']}"/>
        <constructor-arg index="5" ref="secondaryDbDataSource"/>
        <constructor-arg index="6" ref="lazyDataSource"/>
        <constructor-arg index="7" ref="auditFactory"/>
        <constructor-arg index="8" ref="applicationEventPublisher"/>
        <constructor-arg index="9" ref="clusterNodeId"/>
        <constructor-arg index="10" value="#{hibernateProperties['node.db.clusterType']}"/>
        <constructor-arg index="11">
            <bean class="com.l7tech.server.util.ManagedTimer">
                <constructor-arg value="DatabaseReplicationMonitor"/>
            </bean>
        </constructor-arg>
    </bean>

    <!-- Dependency ensures system.properties file is processed first -->
    <bean id="serviceMetricsManager" class="com.l7tech.server.service.ServiceMetricsManagerImpl" depends-on="ssgBoot">
        <constructor-arg ref="clusterNodeId"/>
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <bean id="entityVersionCheckerTimer" class="com.l7tech.server.util.ManagedTimer">
        <constructor-arg value="EntityVersionChecker"/>
    </bean>

    <bean id="entityInvalidator" class="com.l7tech.server.EntityVersionChecker" depends-on="ssgBoot">
        <property name="applicationEventProxy" ref="applicationEventProxy"/>
        <property name="entityManagers">
            <list>
                <ref bean="resourceEntryManager"/>
                <ref bean="roleManager"/>
                <ref bean="clusterPropertyManager"/>
                <ref bean="identityProviderConfigManager"/>
                <ref bean="jmsConnectionManager"/>
                <ref bean="jmsEndpointManager"/>
                <ref bean="jdbcConnectionManager"/>
                <ref bean="trustedCertManager"/>
                <ref bean="revocationCheckPolicyManager"/>
                <ref bean="ssgActiveConnectorManager"/>
                <ref bean="ssgConnectorManager"/>
                <ref bean="sinkManager"/>
                <ref bean="policyManager"/>
                <ref bean="keystoreFileManager"/>
                <ref bean="messageContextMappingKeyManager"/>
                <ref bean="uddiRegistryManager"/>
                <ref bean="uddiPublishStatusManager"/>
                <ref bean="uddiServiceControlManager"/>
                <ref bean="uddiProxiedServiceInfoManager"/>
                <ref bean="serviceManager"/>
                <ref bean="securePasswordManager"/>
                <ref bean="httpConfigurationManager"/>
                <ref bean="resolutionConfigurationManager"/>
                <ref bean="passwordPolicyManger"/>
                <ref bean="policyVersionManager"/>
                <ref bean="folderManager"/>
                <ref bean="genericEntityManager"/>
                <ref bean="encapsulatedAssertionConfigManager"/>
            </list>
        </property>
        <property name="timer" ref="entityVersionCheckerTimer"/>
    </bean>

    <bean id="soapFaultManager" class="com.l7tech.server.util.SoapFaultManager" depends-on="clusterPropertyManager">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1">
            <bean class="com.l7tech.server.util.ManagedTimer">
                <constructor-arg value="Soap fault manager refresh"/>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="httpClientFactory" class="com.l7tech.server.globalresources.ConfiguredCommonsHttpClientFactory">
        <constructor-arg index="0" ref="httpConfigurationCache"/>
        <constructor-arg index="1" ref="httpConnectionIdleTimeoutManager"/>
        <constructor-arg index="2" value="true"/>
    </bean>

    <bean id="anonHttpClientFactory" class="com.l7tech.server.globalresources.ConfiguredCommonsHttpClientFactory">
        <constructor-arg index="0" ref="httpConfigurationCache"/>
        <constructor-arg index="1" ref="httpConnectionIdleTimeoutManager"/>
        <constructor-arg index="2" value="false"/>
    </bean>

    <bean id="anonUrlHttpClientFactory"
          class="com.l7tech.server.globalresources.ConfiguredUrlConnectionHttpClientFactory">
        <constructor-arg index="0" ref="httpConfigurationCache"/>
        <constructor-arg index="1" value="false"/>
    </bean>

    <bean id="trafficLogger" class="com.l7tech.server.log.TrafficLogger">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="soapFaultManager"/>
    </bean>

    <bean id="entityFinder" class="com.l7tech.server.EntityFinderImpl">
        <property name="identityProviderFactory" ref="identityProviderFactory"/>
        <property name="sessionFactory" ref="sessionFactory"/>
        <property name="policyManager" ref="policyManager"/>
        <property name="keyStoreManager">
            <bean class="com.l7tech.gateway.common.spring.factory.config.LazyProxyFactoryBean">
                <constructor-arg value="ssgKeyStoreManager"/>
                <constructor-arg value="com.l7tech.server.security.keystore.SsgKeyStoreManager"/>
            </bean>
        </property>
    </bean>

    <bean id="applicationEventProxy" class="com.l7tech.server.util.ApplicationEventProxy" primary="true"/>

    <!-- A fast event channel just for MessageProcessingEvent subclasses. -->
    <bean id="messageProcessingEventChannel" class="com.l7tech.server.util.EventChannel"/>

    <bean id="managedBackgroundTimer" class="com.l7tech.server.util.ManagedTimer" primary="true">
        <constructor-arg value="Background timer"/>
    </bean>

    <!-- Use managed timer for all background tasks -->
    <bean id="configureBackgroundTimer"
          class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="staticMethod" value="com.l7tech.util.Background.installTimer"/>
        <property name="arguments">
            <list>
                <ref local="managedBackgroundTimer"/>
            </list>
        </property>
    </bean>


    <bean id="whirlyLife" class="com.l7tech.server.WhirlyLifecycle"/>

    <bean id="timerLife" class="com.l7tech.server.ManagedTimerLifecycle"/>

    <bean id="exceptionLogger" class="com.l7tech.util.UncaughtExceptionLogger" factory-method="createAndInstall"/>

    <bean id="stashManagerFactory" class="com.l7tech.server.DefaultStashManagerFactory" factory-method="getInstance" primary="true"/>

    <bean id="messageCacheStashManagerFactory" class="com.l7tech.server.MessageCacheStashManagerFactory"
          factory-method="getInstance"/>

    <bean id="extensionInterfaceManager" class="com.l7tech.server.admin.ExtensionInterfaceManager">
        <constructor-arg ref="rbacAdvice"/>
        <constructor-arg ref="rbacAdvisor"/>
        <constructor-arg ref="transactionManager"/>
    </bean>

    <bean id="assertionRegistry" class="com.l7tech.server.policy.ServerAssertionRegistry" depends-on="ssgBoot">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="licenseManager"/>
        <constructor-arg ref="extensionInterfaceManager"/>
    </bean>

    <bean id="allModulesClassLoader" class="com.l7tech.server.policy.AllModulesClassLoader">
        <constructor-arg ref="assertionRegistry"/>
    </bean>

    <bean id="wspReader" class="com.l7tech.policy.wsp.WspReader">
        <constructor-arg ref="assertionRegistry"/>
    </bean>

    <bean id="serviceWsdlImportChecker" class="com.l7tech.server.service.ServiceWsdlImportChecker"
          depends-on="systemAuditListener systemProperties gatewaySanityChecker">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="transactionManager"/>
        <constructor-arg ref="serviceManager"/>
        <constructor-arg ref="serviceDocumentManager"/>
    </bean>

    <bean id="keystoreFileManager" class="com.l7tech.server.security.keystore.KeystoreFileManagerImpl"
          parent="hibernateBean">
        <constructor-arg ref="masterPasswordManager"/>
    </bean>

    <bean id="securePasswordManager" class="com.l7tech.server.security.password.SecurePasswordManagerImpl"
          parent="hibernateBean">
        <constructor-arg ref="sharedKeyManager"/>
    </bean>

    <bean id="sftpMessageProcessingThreadPool" class="com.l7tech.server.util.ThreadPoolBean">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" value="SFTP Message Processing Thread Pool"/>
        <constructor-arg index="2" value="sftpMessageProcessingThreadLimit"/>
        <constructor-arg index="3" value="sftp.messageProcessingThreadLimit"/>
        <constructor-arg index="4" value="20"/>
    </bean>

    <bean id="sshResponseDownloadThreadPool" class="com.l7tech.server.util.ThreadPoolBean">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" value="SSH2 Routing Response Download Thread Pool"/>
        <constructor-arg index="2" value="sshResponseDownloadThreadLimit"/>
        <constructor-arg index="3" value="ssh.responseDownloadThreadLimit"/>
        <constructor-arg index="4" value="20"/>
    </bean>

    <bean id="ssgActiveConnectorManager" class="com.l7tech.server.transport.SsgActiveConnectorManagerImpl" parent="hibernateBean"/>

    <bean id="ssgConnectorManager" class="com.l7tech.server.transport.SsgConnectorManagerImpl" parent="hibernateBean">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="applicationEventProxy"/>
    </bean>

    <bean id="emailListenerManager" class="com.l7tech.server.transport.email.EmailListenerManagerImpl"
          parent="hibernateBean"/>

    <bean id="ssgKeyStoreManager" class="com.l7tech.server.security.keystore.SsgKeyStoreManagerImpl"
          depends-on="gatewaySanityChecker">
        <constructor-arg index="0" ref="sharedKeyManager"/>
        <constructor-arg index="1" ref="keystoreFileManager"/>
        <constructor-arg index="2" ref="serverConfig"/>
        <constructor-arg index="3">
            <bean class="com.l7tech.server.util.PropertiesValueFactoryBean">
                <constructor-arg ref="nodeProperties"/>
                <constructor-arg value="node.cluster.pass"/>
            </bean>
        </constructor-arg>
        <constructor-arg index="4" ref="dbPasswordEncryption"/>
        <constructor-arg index="5">
            <bean class="com.l7tech.gateway.common.spring.factory.config.LazyProxyFactoryBean">
                <constructor-arg value="keyAccessFilter"/>
                <constructor-arg value="com.l7tech.server.security.keystore.KeyAccessFilter"/>
                <constructor-arg value="true"/>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="keyAccessFilter" class="com.l7tech.server.GatewayKeyAccessFilter">
        <property name="defaultKey" ref="defaultKey"/>
    </bean>

    <bean id="ftpServerManager" class="com.l7tech.server.transport.ftp.FtpServerManager">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="gatewayState"/>
        <constructor-arg ref="messageProcessor"/>
        <constructor-arg ref="soapFaultManager"/>
        <constructor-arg ref="stashManagerFactory"/>
        <constructor-arg ref="licenseManager"/>
        <constructor-arg ref="defaultKey"/>
        <constructor-arg ref="trustedCertServices"/>
        <constructor-arg ref="ssgConnectorManager"/>
        <constructor-arg ref="messageProcessingEventChannel"/>
        <constructor-arg ref="managedBackgroundTimer"/>
    </bean>

    <bean id="jdbcConnectionPoolManager" class="com.l7tech.server.jdbc.JdbcConnectionPoolManager"/>

    <bean id="jdbcQueryingManager" class="com.l7tech.server.jdbc.JdbcQueryingManagerImpl">
        <constructor-arg ref="jdbcConnectionPoolManager"/>
    </bean>

    <bean id="jdbcConnectionManager" class="com.l7tech.server.jdbc.JdbcConnectionManagerImpl" parent="hibernateBean"/>

    <bean id="sharedKeyManager" class="com.l7tech.server.security.sharedkey.SharedKeyManagerImpl">
        <constructor-arg index="0">
            <bean class="com.l7tech.server.util.PropertiesValueFactoryBean">
                <constructor-arg ref="nodeProperties"/>
                <constructor-arg value="node.cluster.pass"/>
            </bean>
        </constructor-arg>
        <constructor-arg index="1" ref="transactionManager"/>
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <bean id="crlCache" class="com.l7tech.server.security.cert.CrlCacheImpl">
        <constructor-arg ref="httpClientFactory"/>
        <constructor-arg ref="serverConfig"/>
        <constructor-arg>
            <bean class="com.l7tech.server.util.ManagedTimer">
                <constructor-arg value="CRL Refresh"/>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="ocspCache" class="com.l7tech.server.security.cert.OCSPCache">
        <constructor-arg ref="httpClientFactory"/>
        <constructor-arg ref="serverConfig"/>
    </bean>

    <bean id="certValidationProcessor" class="com.l7tech.server.security.cert.CertValidationProcessorImpl">
        <constructor-arg ref="trustedCertManager"/>
        <constructor-arg ref="revocationCheckPolicyManager"/>
        <constructor-arg ref="defaultKey"/>
        <constructor-arg ref="serverConfig"/>
        <!-- These make use of the certificate validation processor so cannot be constructor args -->
        <property name="crlCache" ref="crlCache"/>
        <property name="ocspCache" ref="ocspCache"/>
    </bean>

    <bean id="httpTransportModule" class="com.l7tech.server.transport.http.HttpTransportModule"
          depends-on="systemAuditListener">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="masterPasswordManager"/>
        <constructor-arg ref="defaultKey"/>
        <constructor-arg ref="licenseManager"/>
        <constructor-arg ref="ssgConnectorManager"/>
        <constructor-arg ref="trustedCertServices"/>
        <constructor-arg>
            <set>
                <bean class="com.l7tech.server.util.ClusterNodeSsgConnectorActivationListener">
                    <constructor-arg ref="serverConfig"/>
                </bean>
                <ref bean="pcApiConnectorListener"/>
                <ref bean="uddiHelper"/>
            </set>
        </constructor-arg>
    </bean>
    <!--
      Top level bean since we want to get application events.
    -->
    <bean id="pcApiConnectorListener" class="com.l7tech.server.PcApiConnectorActivationListener"/>


    <bean id="policyCache" class="com.l7tech.server.policy.PolicyCacheImpl">
        <constructor-arg index="0" ref="transactionManager"/>
        <constructor-arg index="1" ref="policyFactory"/>
        <constructor-arg index="2" ref="folderCache"/>
        <property name="policyManager" ref="policyManager"/>
        <property name="policyVersionManager" ref="policyVersionManager"/>
    </bean>

    <bean id="policyManager" class="com.l7tech.server.policy.PolicyManagerImpl" parent="hibernateBean">
        <constructor-arg index="0" ref="roleManager"/>
        <constructor-arg index="1" ref="policyAliasManager"/>
        <constructor-arg index="2" ref="folderManager"/>
        <constructor-arg index="3" >
            <bean class="com.l7tech.gateway.common.spring.factory.config.LazyProxyFactoryBean">
                <constructor-arg value="policyCache"/>
                <constructor-arg value="com.l7tech.server.policy.PolicyCache"/>
            </bean>
        </constructor-arg>
    </bean>

    <!--service side policy alias manager-->
    <bean id="policyAliasManager" class="com.l7tech.server.policy.PolicyAliasManagerImpl" parent="hibernateBean"/>

    <bean id="folderManager" class="com.l7tech.server.folder.FolderManagerImpl" parent="hibernateBean">
        <constructor-arg ref="roleManager"/>
    </bean>

    <bean id="policyPathBuilderFactory" class="com.l7tech.policy.PolicyPathBuilderFactory">
        <constructor-arg ref="policyManager"/>
    </bean>

    <bean id="policyVersionManager" class="com.l7tech.server.policy.PolicyVersionManagerImpl" parent="hibernateBean">
        <constructor-arg ref="serverConfig"/>
    </bean>

    <bean id="syslogManager" class="com.l7tech.server.log.syslog.SyslogManager" destroy-method="close"/>

    <bean id="sinkManager" class="com.l7tech.server.log.SinkManagerImpl" parent="hibernateBean"
          depends-on="systemAuditListener">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="syslogManager"/>
        <constructor-arg ref="trafficLogger"/>
        <constructor-arg ref="applicationEventProxy"/>
        <constructor-arg ref="clusterInfoManager"/>
        <constructor-arg ref="clusterContextFactory"/>
        <constructor-arg ref="roleManager"/>
    </bean>

    <bean id="auditLogListenerTarget" class="com.l7tech.server.log.FilteringAuditLogListener">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg>
            <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
                <property name="targetObject" ref="sinkManager"/>
                <property name="targetMethod" value="getPublishingSink"/>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="auditLevelDetailFilter" class="com.l7tech.server.audit.AuditLevelDetailFilter">
        <constructor-arg ref="serverConfig"/>
    </bean>

    <bean id="auditLogListener" class="com.l7tech.gateway.common.spring.factory.config.LazyProxyFactoryBean">
        <constructor-arg value="auditLogListenerTarget"/>
        <constructor-arg value="com.l7tech.server.audit.AuditLogListener"/>
    </bean>


    <bean id="auditDetailFilter" class="com.l7tech.server.audit.GatewayAuditDetailFilter">
        <constructor-arg ref="serverConfig"/>
    </bean>

    <bean id="auditFactory" class="com.l7tech.server.audit.Auditor$DefaultAuditorFactory">
        <constructor-arg index="0" ref="auditDetailFilter"/>
        <constructor-arg index="1" ref="auditLogListener"/>
    </bean>

    <bean id="serviceTemplateManager" class="com.l7tech.server.service.ServiceTemplateManagerImpl"/>

    <bean id="policyExporterImporterManager" class="com.l7tech.server.policy.export.PolicyExporterImporterManagerImpl"/>

    <bean id="securityTokenServiceTemplateRegistry"
          class="com.l7tech.server.tokenservice.SecurityTokenServiceTemplateRegistry">
        <constructor-arg index="0" ref="serviceTemplateManager"/>
    </bean>

    <bean id="esmSubscriptionManager" class="com.l7tech.server.wsdm.subscription.SubscriptionManagerImpl"
          parent="hibernateBean"/>

    <bean id="kerberosConfig" class="com.l7tech.server.security.kerberos.ServerKerberosConfig">
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="dbPasswordEncryption"/>
    </bean>

    <bean id="messageContextMappingKeyManager" class="com.l7tech.server.mapping.MessageContextMappingKeyManagerImpl"
          parent="hibernateBean"/>
    <bean id="messageContextMappingValueManager" class="com.l7tech.server.mapping.MessageContextMappingValueManagerImpl"
          parent="hibernateBean"/>
    <bean id="messageContextMappingManager" class="com.l7tech.server.mapping.MessageContextMappingManagerImpl">
        <constructor-arg ref="messageContextMappingKeyManager"/>
        <constructor-arg ref="messageContextMappingValueManager"/>
    </bean>

    <bean id="trustedEsmManager" class="com.l7tech.server.TrustedEsmManagerImpl" parent="hibernateBean">
    </bean>

    <bean id="trustedEsmUserManager" class="com.l7tech.server.TrustedEsmUserManagerImpl" parent="hibernateBean">
    </bean>

    <bean id="processControllerNodeApiImpl" class="com.l7tech.server.NodeApiImpl"/>

    <bean id="gatewayApiImpl" class="com.l7tech.server.cluster.GatewayApiImpl">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="clusterInfoManager"/>
        <constructor-arg index="2">
            <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
                <property name="targetObject" ref="rbacAdvice"/>
                <property name="targetMethod" value="getSecurityFilter"/>
            </bean>
        </constructor-arg>
        <constructor-arg index="3" ref="serviceManager"/>
        <constructor-arg index="4" ref="policyManager"/>
        <constructor-arg index="5" ref="folderManager"/>
        <constructor-arg index="6" ref="serviceExternalEntityHeaderEnhancer"/>
    </bean>

    <bean id="reportApiImpl" class="com.l7tech.server.cluster.ReportApiImpl">
        <constructor-arg index="0" ref="transactionManager"/>
        <constructor-arg index="1" ref="rbacServices"/>
        <constructor-arg index="2">
            <bean class="com.l7tech.server.util.ManagedTimer">
                <constructor-arg value="Report Processor"/>
            </bean>
        </constructor-arg>
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>
    <bean id="managedReportApiImpl" class="com.l7tech.server.cluster.ReportApiImpl$ManagedReportApiImpl">
        <constructor-arg ref="reportApiImpl"/>
    </bean>

    <bean id="migrationApiImpl" class="com.l7tech.server.migration.MigrationApiImpl">
        <constructor-arg index="0" ref="migrationManager"/>
    </bean>

    <bean id="systemClassLoader" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetClass" value="java.lang.ClassLoader"/>
        <property name="targetMethod" value="getSystemClassLoader"/>
    </bean>
    <bean id="extensionClassLoader" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject" ref="systemClassLoader"/>
        <property name="targetMethod" value="getParent"/>
    </bean>
    <!--
      Resource classloader that is configured to load Fiorano JMS and the associated
      Gateway provider class(es) in a shared classloader.

      Other JMS classes will be loaded as before from the extension classloader.
    -->
    <bean id="jmsClassLoader" class="com.l7tech.server.util.ResourceClassLoader">
        <constructor-arg index="0">
            <!--
              Filtering classloader that will load bootstrap and extension classes, plus
              the listed gateway packages and classes.
            -->
            <bean class="com.l7tech.util.FilterClassLoader">
                <constructor-arg index="0" ref="extensionClassLoader"/>
                <constructor-arg index="1" ref="systemClassLoader"/>
                <constructor-arg index="2">
                    <list>
                        <value>com.l7tech.server.transport.jms.prov.fiorano</value>
                        <value>com.l7tech.server.transport.jms.JmsSslCustomizerSupport</value>
                        <value>com.l7tech.server.transport.jms.JmsConfigException</value>
                        <value>org.apache.xerces</value>
                        <value>org.apache.xml.serializer</value>
                        <value>org.apache.xalan</value>
                        <value>org.hibernate</value>
                    </list>
                </constructor-arg>
                <constructor-arg index="3" value="true"/>
            </bean>
        </constructor-arg>
        <constructor-arg index="1">
            <list>
                <value>fiorano</value>
                <value>com.fiorano</value>
                <value>com.l7tech.server.transport.jms.prov.fiorano</value>
            </list>
        </constructor-arg>
    </bean>
    <bean id="jmsInit" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.transport.jms.JmsUtil"/>
        <property name="targetMethod" value="setContextClassLoader"/>
        <property name="arguments">
            <list>
                <ref local="jmsClassLoader"/>
            </list>
        </property>
    </bean>

    <bean id="clusterPropertyCleanup" class="com.l7tech.server.cluster.ClusterPropertyCleanup">
        <constructor-arg index="0">
            <set>
                <value>cluster.internodePort</value>
            </set>
        </constructor-arg>
        <constructor-arg index="1" ref="transactionManager"/>
        <constructor-arg index="2" ref="clusterPropertyManager"/>
    </bean>

    <bean id="entityCrud" class="com.l7tech.server.EntityCrudImpl">
        <property name="sessionFactory" ref="sessionFactory"/>
        <constructor-arg ref="entityFinder"/>
        <constructor-arg>
            <list>
                <ref bean="trustedEsmManager"/>
                <ref bean="trustedEsmUserManager"/>
                <ref bean="auditRecordManager"/>
                <ref bean="clusterPropertyManager"/>
                <ref bean="resourceEntryManager"/>
                <ref bean="folderManager"/>
                <ref bean="identityProviderConfigManager"/>
                <ref bean="revocationCheckPolicyManager"/>
                <ref bean="trustedCertManager"/>
                <ref bean="federatedUserManager"/>
                <ref bean="federatedGroupManager"/>
                <ref bean="internalUserManager"/>
                <ref bean="internalGroupManager"/>
                <!--<ref bean="sinkLogManager"/>-->
                <!--<ref bean="logonInfoManager"/>-->
                <ref bean="messageContextMappingKeyManager"/>
                <ref bean="messageContextMappingValueManager"/>
                <bean class="com.l7tech.server.policy.VersioningPolicyManager">
                    <constructor-arg index="0" ref="policyManager"/>
                    <constructor-arg index="1" ref="policyVersionManager"/>
                </bean>
                <ref bean="policyAliasManager"/>
                <ref bean="keystoreFileManager"/>
                <ref bean="roleManager"/>
                <ref bean="serviceAliasManager"/>
                <ref bean="serviceDocumentManager"/>
                <bean class="com.l7tech.server.service.PolicyVersioningServiceManager">
                    <constructor-arg index="0" ref="serviceManager"/>
                    <constructor-arg index="1" ref="policyVersionManager"/>
                </bean>
                <ref bean="ssgConnectorManager"/>
                <ref bean="emailListenerManager"/>
                <ref bean="jmsConnectionManager"/>
                <ref bean="jmsEndpointManager"/>
                <bean class="com.l7tech.server.migration.IdentityEntityManager">
                    <constructor-arg index="0" value="com.l7tech.identity.User"/>
                    <constructor-arg index="1" ref="identityProviderFactory"/>
                </bean>
                <bean class="com.l7tech.server.migration.IdentityEntityManager">
                    <constructor-arg index="0" value="com.l7tech.identity.Group"/>
                    <constructor-arg index="1" ref="identityProviderFactory"/>
                </bean>
                <ref bean="sinkManager"/>
                <ref bean="ssgActiveConnectorManager"/>
            </list>
        </constructor-arg>
    </bean>

    <bean id="propertyResolverFactory" class="com.l7tech.server.migration.PropertyResolverFactory">
        <constructor-arg ref="entityFinder"/>
        <constructor-arg ref="ssgKeyStoreManager"/>
        <constructor-arg ref="serviceDocumentManager"/>
        <constructor-arg ref="clusterPropertyManager"/>
        <constructor-arg ref="resourceEntryManager"/>
        <constructor-arg ref="serverConfig"/>
        <constructor-arg ref="jdbcConnectionManager"/>
    </bean>

    <bean id="serviceExternalEntityHeaderEnhancer"
          class="com.l7tech.server.service.ServiceExternalEntityHeaderEnhancer"/>

    <bean id="migrationManager" class="com.l7tech.server.migration.MigrationManagerImpl">
        <constructor-arg index="0">
            <bean class="com.l7tech.server.SecuredEntityCrud">
                <constructor-arg index="0" ref="rbacServices"/>
                <constructor-arg index="1">
                    <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
                        <property name="targetObject" ref="rbacAdvice"/>
                        <property name="targetMethod" value="getSecurityFilter"/>
                    </bean>
                </constructor-arg>
                <constructor-arg index="2" ref="entityCrud"/>
            </bean>
        </constructor-arg>
        <constructor-arg index="1" ref="propertyResolverFactory"/>
        <constructor-arg index="2">
            <bean class="com.l7tech.server.cluster.ExternalEntityHeaderEnhancer$CompositeExternalEntityHeaderEnhancer">
                <constructor-arg>
                    <list>
                        <bean class="com.l7tech.server.identity.IdentityExternalEntityHeaderEnhancer"/>
                        <ref bean="serviceExternalEntityHeaderEnhancer"/>
                    </list>
                </constructor-arg>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="wsdlStrategyServiceDocumentsInitializer" class="com.l7tech.server.util.TypedMethodInvokingFactoryBean">
        <property name="targetClass" value="com.l7tech.server.service.PersistentServiceDocumentWsdlStrategy"/>
        <property name="targetMethod" value="setServiceDocumentManager"/>
        <property name="arguments">
            <list>
                <ref bean="serviceDocumentManager"/>
            </list>
        </property>
    </bean>

    <bean id="encapsulatedAssertionConfigManager" class="com.l7tech.server.encass.EncapsulatedAssertionConfigManagerImpl" parent="hibernateBean">
    </bean>

    <bean id="uddiHelper" class="com.l7tech.server.uddi.UDDIHelper">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="ssgKeyStoreManager"/>
        <constructor-arg index="2" ref="trustManager"/>
        <constructor-arg index="3" ref="hostnameVerifier"/>
        <constructor-arg index="4" ref="uddiTemplateManager"/>
        <constructor-arg index="5">
            <bean class="org.springframework.beans.factory.config.PropertiesFactoryBean"
                  depends-on="systemProperties">
                <property name="ignoreResourceNotFound" value="true"/>
                <property name="locations">
                    <list>
                        <value>file:${com.l7tech.server.configDirectory}${file.separator}uddi.properties</value>
                    </list>
                </property>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="uddiCoordinator" class="com.l7tech.server.uddi.UDDICoordinator">
        <constructor-arg index="0" ref="transactionManager"/>
        <constructor-arg index="1" ref="uddiHelper"/>
        <constructor-arg index="2" ref="uddiRegistryManager"/>
        <constructor-arg index="3" ref="uddiProxiedServiceInfoManager"/>
        <constructor-arg index="4" ref="uddiPublishStatusManager"/>
        <constructor-arg index="5" ref="uddiServiceControlManager"/>
        <constructor-arg index="6" ref="uddiBusinessServiceStatusManager"/>
        <constructor-arg index="7" ref="serviceCache"/>
        <constructor-arg index="8" ref="clusterMaster"/>
        <constructor-arg index="9">
            <bean class="com.l7tech.server.util.ManagedTimer">
                <constructor-arg value="UDDI Coordinator"/>
            </bean>
        </constructor-arg>
        <constructor-arg index="10">
            <list>
                <bean class="com.l7tech.server.uddi.PublishingUDDITaskFactory">
                    <constructor-arg index="0" ref="uddiRegistryManager"/>
                    <constructor-arg index="1" ref="uddiProxiedServiceInfoManager"/>
                    <constructor-arg index="2" ref="serviceCache"/>
                    <constructor-arg index="3" ref="uddiHelper"/>
                    <constructor-arg index="4" ref="uddiServiceControlManager"/>
                    <constructor-arg index="5" ref="uddiPublishStatusManager"/>
                    <constructor-arg index="6" ref="serverConfig"/>
                </bean>
                <bean class="com.l7tech.server.uddi.WsPolicyAttachmentTaskFactory">
                    <constructor-arg index="0" ref="uddiRegistryManager"/>
                    <constructor-arg index="1" ref="uddiHelper"/>
                    <constructor-arg index="2" ref="uddiTemplateManager"/>
                    <constructor-arg index="3" ref="uddiBusinessServiceStatusManager"/>
                </bean>
                <bean class="com.l7tech.server.uddi.SubscriptionUDDITaskFactory">
                    <constructor-arg index="0" ref="uddiRegistryManager"/>
                    <constructor-arg index="1" ref="uddiHelper"/>
                    <constructor-arg index="2" ref="uddiRegistrySubscriptionManager"/>
                    <constructor-arg index="3" ref="uddiServiceControlManager"/>
                    <constructor-arg index="4" ref="uddiServiceControlMonitorRuntimeManager"/>
                    <constructor-arg index="5" ref="serviceManager"/>
                    <constructor-arg index="6" ref="serviceDocumentManager"/>
                    <constructor-arg index="7" ref="httpClientFactory"/>
                </bean>
                <bean class="com.l7tech.server.uddi.MetricsUDDITaskFactory">
                    <constructor-arg index="0" ref="uddiRegistryManager"/>
                    <constructor-arg index="1" ref="uddiHelper"/>
                    <constructor-arg index="2" ref="uddiTemplateManager"/>
                    <constructor-arg index="3" ref="uddiBusinessServiceStatusManager"/>
                    <constructor-arg index="4" ref="aggregator"/>
                    <constructor-arg index="5" ref="clusterPropertyCache"/>
                </bean>
            </list>
        </constructor-arg>
        <constructor-arg index="11" ref="serverConfig"/>
        <constructor-arg index="12" ref="sessionFactory"/>
    </bean>

    <bean id="uddiRegistryManager" class="com.l7tech.server.uddi.UDDIRegistryManagerImpl" parent="hibernateBean">
        <constructor-arg ref="uddiProxiedServiceInfoManager"/>
    </bean>

    <bean id="uddiProxiedServiceInfoManager" class="com.l7tech.server.uddi.UDDIProxiedServiceInfoManagerImpl"
          parent="hibernateBean"/>

    <bean id="uddiPublishStatusManager" class="com.l7tech.server.uddi.UDDIPublishStatusManagerImpl"
          parent="hibernateBean"/>

    <bean id="uddiServiceControlManager" class="com.l7tech.server.uddi.UDDIServiceControlManagerImpl"
          parent="hibernateBean"/>

    <bean id="uddiRegistrySubscriptionManager" class="com.l7tech.server.uddi.UDDIRegistrySubscriptionManagerImpl"
          parent="hibernateBean"/>

    <bean id="uddiBusinessServiceStatusManager" class="com.l7tech.server.uddi.UDDIBusinessServiceStatusManagerImpl"
          parent="hibernateBean"/>

    <bean id="uddiServiceControlMonitorRuntimeManager"
          class="com.l7tech.server.uddi.UDDIServiceControlRuntimeManagerImpl" parent="hibernateBean"/>

    <bean id="uddiServiceWsdlUpdateChecker" class="com.l7tech.server.uddi.ServiceWsdlUpdateChecker">
        <constructor-arg index="0" ref="serviceManager"/>
        <constructor-arg index="1" ref="uddiServiceControlManager"/>
    </bean>

    <bean id="serviceDocumentResolver" class="com.l7tech.server.service.ServiceDocumentResolver">
        <constructor-arg index="0" ref="httpClientFactory"/>
    </bean>

    <bean id="inboundSecureConversationContextManager"
          class="com.l7tech.server.secureconversation.InboundSecureConversationContextManager">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="storedSecureConversationSessionManager"/>
    </bean>

    <bean id="outboundSecureConversationContextManager"
          class="com.l7tech.server.secureconversation.OutboundSecureConversationContextManager">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="storedSecureConversationSessionManager"/>
    </bean>

    <bean id="kerberosSessionContextManager" class="com.l7tech.server.security.kerberos.KerberosSessionContextManager"/>

    <bean id="securityContextFinder" class="com.l7tech.server.security.DelegatingSecurityContextFinder">
        <constructor-arg index="0">
            <list>
                <ref bean="inboundSecureConversationContextManager"/>
                <ref bean="kerberosSessionContextManager"/>
            </list>
        </constructor-arg>
    </bean>

    <bean id="defaultHttpProxyManager" class="com.l7tech.server.globalresources.DefaultHttpProxyManager">
        <constructor-arg index="0" ref="clusterPropertyManager"/>
    </bean>

    <bean id="httpConfigurationManager" class="com.l7tech.server.globalresources.HttpConfigurationManagerImpl"
          parent="hibernateBean"/>

    <bean id="httpConfigurationCache" class="com.l7tech.server.globalresources.HttpConfigurationCache">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="defaultHttpProxyManager"/>
        <constructor-arg index="2" ref="httpConfigurationManager"/>
        <constructor-arg index="3" ref="securePasswordManager"/>
        <constructor-arg index="4" ref="hostnameVerifier"/>
        <constructor-arg index="5" ref="ssgKeyStoreManager"/>
        <constructor-arg index="6" ref="defaultKey"/>
        <constructor-arg index="7">
            <bean class="com.l7tech.gateway.common.spring.factory.config.LazyProxyFactoryBean">
                <constructor-arg value="trustManager"/>
                <constructor-arg value="javax.net.ssl.X509TrustManager"/>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="storedSecureConversationSessionManager" class="com.l7tech.server.secureconversation.StoredSecureConversationSessionManagerImpl" parent="hibernateBean"/>

    <bean id="storedSecureConversationSessionMaintainer" class="com.l7tech.server.secureconversation.StoredSecureConversationSessionMaintainer" init-method="init">
        <constructor-arg index="0" ref="serverConfig"/>
        <constructor-arg index="1" ref="storedSecureConversationSessionManager"/>
        <constructor-arg index="2">
            <bean class="com.l7tech.server.util.ManagedTimer">
                <constructor-arg value="Stored WSSC Session Maintainer"/>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="injector" class="com.l7tech.server.util.ApplicationContextInjector"/>

    <bean id="ldapTemplateManager" class="com.l7tech.server.identity.ldap.LdapConfigTemplateManager"/>

    <bean id="postStartupApplicationListenerRegistration" class="com.l7tech.server.util.PostStartupApplicationListener$StartupListenerRegistration"/>

    <bean id="entityManagementContextProvider" class="com.l7tech.server.EntityManagementContextProvider"/>

    <bean id="dateTimeConfigUtils" class="com.l7tech.util.DateTimeConfigUtils" >
        <property name="config" ref="serverConfig" />
    </bean>

    <bean id="failoverStrategyFactory" class="com.l7tech.common.io.failover.FailoverStrategyFactory"/>

    <!-- export beans to JMX -->
    <context:mbean-export/>

</beans>
