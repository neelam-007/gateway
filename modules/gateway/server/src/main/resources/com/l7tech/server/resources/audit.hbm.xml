<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC
    "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
    "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<!--
  This is the Hibernate mapping file for audit records.
-->
<hibernate-mapping>
    <typedef class="com.l7tech.server.util.CompressedStringType" name="ziptext"/>
    <typedef class="com.l7tech.server.util.SecurityTokenUserType" name="securitytoken"/>
    <typedef class="com.l7tech.server.util.GoidType" name="goid"/>

    <class name="com.l7tech.gateway.common.audit.AuditRecord" table="audit_main" lazy="false">
        <id name="oid" column="objectid" type="long" unsaved-value="-1">
            <generator class="layer7-generator"/>
        </id>

        <!-- No version column required, since these never get modified -->
        <property name="nodeId" column="nodeid" type="string"/>
        <property name="millis" column="time" type="long"/>
        <property name="strLvl" column="audit_level" type="string"/>
        <property name="message" column="message" type="string"/>
        <property name="ipAddress" column="ip_address" type="string"/>
        <property name="name" column="name" type="string"/>
        <property name="identityProviderOid" column="provider_oid" type="long"/>
        <property name="userId" column="user_id" type="string"/>
        <property name="userName" column="user_name" type="string"/>
        <property name="signature" column="signature" type="string"/>

        <set name="details" lazy="false" inverse="true" cascade="all">
            <key column="audit_oid"/>
            <one-to-many class="com.l7tech.gateway.common.audit.AuditDetail"/>
        </set>
        
        <joined-subclass name="com.l7tech.gateway.common.audit.MessageSummaryAuditRecord" table="audit_message" lazy="false">
            <key column="objectid"/>
            <property name="status" type="int"/>
            <property name="strRequestId" column="request_id" type="string"/>
            <property name="serviceGoid" column="service_goid" type="goid"/>
            <property name="operationName" column="operation_name" type="string"/>
            <property name="authenticated" column="authenticated" type="boolean"/>
            <property name="authenticationType" column="authenticationType" type="securitytoken"/>
            <property name="requestXml" column="request_zipxml" type="ziptext"/>
            <property name="requestContentLength" column="request_length" type="int"/>
            <property name="responseXml" column="response_zipxml" type="ziptext"/>
            <property name="responseContentLength" column="response_length" type="int"/>
            <property name="responseHttpStatus" column="response_status" type="int"/>
            <property name="routingLatency" column="routing_latency" type="int"/>
            <property name="mappingValuesOid" column="mapping_values_oid" type="long"/>

            <many-to-one name="mappingValuesEntity" class="com.l7tech.gateway.common.mapping.MessageContextMappingValues" column="mapping_values_oid" update="false" insert="false"/>
        </joined-subclass>

        <joined-subclass name="com.l7tech.gateway.common.audit.AdminAuditRecord" table="audit_admin" lazy="false">
            <key column="objectid"/>
            <property name="entityClassname" column="entity_class" type="string"/>
            <property name="entityOid" column="entity_id" type="long"/>
            <property name="action" column="action" type="char"/>
        </joined-subclass>

        <joined-subclass name="com.l7tech.gateway.common.audit.SystemAuditRecord" table="audit_system" lazy="false">
            <key column="objectid"/>
            <property name="componentId" column="component_id" type="int"/>
            <property name="action" type="string"/>
        </joined-subclass>
    </class>

    <class name="com.l7tech.gateway.common.audit.AuditDetail" table="audit_detail" lazy="false">
        <id name="oid" column="objectid" type="long" unsaved-value="-1">
            <generator class="layer7-generator"/>
        </id>

        <property name="time" type="long"/>
        <property name="componentId" column="component_id" type="int"/>
        <property name="ordinal" type="int"/>
        <property name="messageId" column="message_id" type="int"/>
        <property name="exception" column="exception_message" type="text"/>

        <array name="params" table="audit_detail_params" cascade="all" outer-join="true">
            <key column="audit_detail_oid"/>
            <index column="position"/>
            <element column="value" type="string"/>
        </array>

        <many-to-one name="auditRecord" class="com.l7tech.gateway.common.audit.AuditRecord" column="audit_oid"/>
    </class>

</hibernate-mapping>
