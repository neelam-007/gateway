<?xml version="1.0" encoding="UTF-8"?>
<!-- Ant build file for CA Unicenter WSDM observer module. -->
<project name="module.CaWsdmObserver" default="package">

    <description>
    Builds the CA Unicenter WSDM observer module.
    </description>

    <property name="UneasyRooster.dir" location="../.."/>

    <!-- Extra Ant task definitions -->
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="${UneasyRooster.dir}/lib/ant-contrib.jar"/>
        </classpath>
    </taskdef>

    <!-- Gets the build version number. -->
    <property file="${UneasyRooster.dir}/build.version"/>

    <property name="build.classes" location="build/classes"/>

    <path id="compile.classpath">
        <fileset dir="ssg/tomcat/webapps/ROOT/WEB-INF/lib">
            <include name="**/*.jar"/>
        </fileset>
        <fileset dir="${UneasyRooster.dir}/lib">
            <include name="0500-wsdl4j.jar"/>
            <include name="spring-beans.jar"/>
            <include name="spring-context.jar"/>
        </fileset>
        <pathelement location="${UneasyRooster.dir}/build/classes"/>
    </path>

    <target name="-init">
        <!-- OS-dependent stuff -->
        <if>
            <os family="unix"/>
            <then>
                <property name="ssg.home" value="/ssg"/>
            </then>
            <elseif>
                <os family="windows"/>
                <then>
                    <property name="ssg.home" value="C:\Program Files\Layer 7 Technologies\SecureSpan Gateway"/>
                </then>
            </elseif>
        </if>
    </target>

    <target name="-compile">
        <mkdir dir="${build.classes}"/>
        <javac srcdir="src"
               destdir="${build.classes}"
               classpathref="compile.classpath">
        </javac>
    </target>

    <target name="-jar" depends="-compile">
        <mkdir dir="build/ssg/tomcat/webapps/ROOT/WEB-INF/lib"/>
        <jar destfile="build/ssg/tomcat/webapps/ROOT/WEB-INF/lib/CaWsdmObserver.jar"
             basedir="build/classes"/>
    </target>

    <target name="package" depends="-jar"
            description="Creates the distributable ZIP file.">
        <zip destfile="build/CaWsdmObserver-${build.version.major}.${build.version.minor}.zip">
            <fileset dir="." includes="ssg/**/*"/>
            <fileset dir="build" includes="ssg/**/*"/>
            <fileset dir="bin" includes="install.*"/>
        </zip>
    </target>

    <!-- Tests if the SSG home folder exists. -->
    <target name="-ssg.home.testexist" depends="-init">
        <if>
            <not>
                <available file="${ssg.home}" property="ssg.home.exists"/>
            </not>
            <then>
                <fail message="SSG home folder not found: ${ssg.home}"/>
            </then>
        </if>
    </target>

    <target name="deploy" depends="-jar,-ssg.home.testexist"
            description="Deploys to SSG at ${ssg.home}.">
        <echo>Deploying to ${ssg.home}.</echo>
        <copy overwrite="true" todir="${ssg.home}" verbose="true">
            <fileset dir="ssg">
                <include name="tomcat/webapps/ROOT/WEB-INF/CaWsdmObserverContext.xml"/>
                <include name="tomcat/webapps/ROOT/WEB-INF/lib/*.jar"/>
            </fileset>
            <fileset dir="build/ssg">
                <include name="tomcat/webapps/ROOT/WEB-INF/lib/CaWsdmObserver.jar"/>
            </fileset>
        </copy>

        <!-- Do not overwrite these if modified. -->
        <copy overwrite="false" todir="${ssg.home}" verbose="true">
            <fileset dir="ssg">
                <include name="etc/conf/CaWsdmObserver.properties"/>
                <include name="tomcat/webapps/ROOT/WEB-INF/classes/WsdmSOMMA_Basic.properties"/>
            </fileset>
        </copy>
    </target>

    <target name="undeploy" depends="-ssg.home.testexist"
            description="Undeploys from SSG at ${ssg.home}. (Deletes all deployed files.)">
        <delete verbose="true">
            <fileset dir="${ssg.home}">
                <include name="etc/conf/CaWsdmObserver.properties"/>
                <include name="tomcat/webapps/ROOT/WEB-INF/CaWsdmObserverContext.xml"/>
                <include name="tomcat/webapps/ROOT/WEB-INF/classes/WsdmSOMMA_Basic.properties"/>
                <include name="tomcat/webapps/ROOT/WEB-INF/lib/axis-1.3.jar"/>
                <include name="tomcat/webapps/ROOT/WEB-INF/lib/CaWsdmObserver.jar"/>
                <include name="tomcat/webapps/ROOT/WEB-INF/lib/ca_wsdm-3.50-core.jar"/>
                <include name="tomcat/webapps/ROOT/WEB-INF/lib/ca_wsdm-3.50-handler_common.jar"/>
                <include name="tomcat/webapps/ROOT/WEB-INF/lib/ca_wsdm-3.50-wsdm35mmi-axis-stubskel.jar"/>
            </fileset>
        </delete>
    </target>

    <target name="clean"
            description="Deletes all generated files.">
        <delete dir="build"/>
    </target>

</project>