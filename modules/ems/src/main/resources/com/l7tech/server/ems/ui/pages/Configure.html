<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" xmlns:wicket="http://wicket.apache.org/">
<head>
    <!-- PROTOTYPE ONLY BEGIN -->
    <meta http-equiv="Expires" content="-1" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta http-equiv="Pragma" content="no-cache" />
    <!-- PROTOTYPE ONLY END -->
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <title>Configure [Enterprise Service Manager]</title>
    <link rel="stylesheet" type="text/css" href="../css/l7.css" />

    <wicket:head>
        <!-- Required YUI modules: button, connection, container, datasource, datatable, dom, event, get, json, logger, menu -->
        <link rel="stylesheet" type="text/css" href="../yui/assets/skins/sam/skin.css">
        <script type="text/javascript" src="/yui/utilities/utilities.js"></script>
        <script type="text/javascript" src="/yui/container/container-min.js"></script>
        <script type="text/javascript" src="/yui/menu/menu-min.js"></script>
        <script type="text/javascript" src="/yui/button/button-min.js"></script>
        <script type="text/javascript" src="/yui/datasource/datasource-min.js"></script>
        <script type="text/javascript" src="/yui/datatable/datatable-min.js"></script>
        <script type="text/javascript" src="/yui/json/json-min.js"></script>
        <script type="text/javascript" src="/yui/logger/logger-min.js"></script>

        <script type="text/javascript" src="../js/entityTreeTable.js"></script>
        <script type="text/javascript">
            // TODO generate these variables dynamically on the server according to user's langauge preference

            /** Localized strings for passing into l7.EntityTreeTable constructor. */
            var entityTreeTableLocalizedStrings = {
                SSG_CLUSTER_STATE_UP : 'Up',
                SSG_CLUSTER_STATE_PARTIAL : 'Partial',
                SSG_CLUSTER_STATE_DOWN : 'Down',
                SSG_NODE_STATE_ON : 'On',
                SSG_NODE_STATE_OFF : 'Off',
                SSG_NODE_STATE_DOWN : 'Down',
                SSG_NODE_STATE_OFFLINE : 'Offline',
                TRUST_ESTABLISHED : 'Trust has been established',
                TRUST_NOT_ESTABLISHED : 'Trust has not been established',
                TRUST_TO_BE_ESTABLISHED : 'Trust has not been established. Click to establish.',
                ACCESS_ACCOUNT_IS_SET : 'Access account is set. Click to change access account.',
                ACCESS_ACCOUNT_CAN_SET : 'No access account. Click to enter access account.',
                ACCESS_ACCOUNT_CANNOT_CHANGE : 'Access account is set. Trust must be established before changing access account.',
                ACCESS_ACCOUNT_CANNOT_SET : 'No access account. Trust must be established before entering access account.',
                ACCESS_GRANTED : 'Access granted',
                ACCESS_NOT_GRANTED : 'Access not granted',
                DASHBOARD_CHECKBOX_TOOLTIP : 'Show/Hide dashboard for this SSG Cluster',
                MONITORED_PROPERTY_BUTTON_TOOLTIP : 'Click to configure this monitoring property',
                ENTERPRISE_FOLDER : 'folder',
                SSG_CLUSTER : 'SSG Cluster',
                SSG_NODE : 'SSG Node',
                SERVICE_FOLDER : 'folder',
                PUBLISHED_SERVICE : 'published service',
                POLICY_FRAGMENT : 'policy fragment',
                SSL_HOST_NAME : 'SSL host name',
                ADMINISTRATIVE_PORT_NUMBER : 'administrative port number',
                IP_ADDRESS : 'IP address',
                DATABASE_HOSTS : 'database host(s)',
                SELF_HOST_NAME : 'self host name',
                ZOOM_ICON_TOOLTIP : 'Show details'
            };

            /** Localized strings for local HTML markups, e.g., toolbar buttons, context menu, dialogs. */
            var localizedStrings = {
                ADD_FOLDER : 'New Folder',
                ADD_SSG_CLUSTER : 'Add Cluster',
                EDIT : 'Edit',
                MOVE : 'Move',
                DELETE : 'Delete',
                START : 'Start',
                STOP : 'Stop',
                LAUNCH_SSM : 'Launch SecureSpan Manager',
                NO_ACCESS : 'No Access',
                OK : 'OK',
                CANCEL : 'Cancel',
                ERROR : 'Error',
                CANNOT_PARSE_RESPONSE_JSON : 'Malformed response from server: ',
                CANNOT_DOWNLOAD_ENTITY_DATA : 'Failed to get array of enterprise entities from server: ',
                CANNOT_PARSE_ENTITY_DATA : 'Failed to parse array of enterprise entities downloaded from server: ',
                ENTITY_DATA_ERROR : 'Data error.',
                CANNOT_GET_DATA_TO_ESTABLISH_TRUST : 'Failed to get data from server for establishing trust by SSG Cluster: ',
                CANNOT_GET_DATA_TO_MAP_ACCESS_ACCOUNT : 'Failed to get data from server for mapping access account: ',
                INVALID_NAME_LENGTH : 'must be 1 to 128 characters',
                INVALID_NAME_SLASH : 'slash "/" not allowed',
                INVALID_NAME_LEADING_SPACES : 'leading spaces not allowed',
                INVALID_NAME_TRAILING_SPACES : 'trailing spaces not allowed',
                SSG_CLUSTER_PORT_HINT : 'port number must be a positive integer',
                STARTING_SSG_NODE : 'Starting SSG Node &ldquo;{0}&rdquo;...',
                STOPPING_SSG_NODE : 'Stopping SSG Node &ldquo;{0}&rdquo;...',
                CANNOT_ADD_FOLDER : 'Failed to add folder: ',
                CANNOT_EDIT_FOLDER : 'Failed to edit folder: ',
                CANNOT_DELETE_FOLDER : 'Failed to delete folder: ',
                CANNOT_ADD_SSG_CLUSTER : 'Failed to add SSG Cluster: ',
                CANNOT_EDIT_SSG_CLUSTER : 'Failed to edit SSG Cluster: ',
                CANNOT_DELETE_SSG_CLUSTER : 'Failed to delete SSG Cluster: ',
                CANNOT_START_SSG_NODE : 'Failed to start SSG Node: ',
                CANNOT_STOP_SSG_NODE : 'Failed to stop SSG Node: '
            };
        </script>
        <script type="text/javascript">
            /**
             * The enterpries tree table object.
             * @type l7.EntityTreeTable
             */
            var entityTreeTable;

            var addFolderButton;
            var addSSGClusterButton;
            var editButton;
            //var moveButton;
            var deleteButton;
            var startButton;
            var stopButton;
            var launchSSMButton;

            var addFolderMenuItem;
            var addSSGClusterMenuItem;
            var editMenuItem;
            var moveMenuItem;
            var deleteMenuItem;
            var startMenuItem;
            var stopMenuItem;
            var launchSSMMenuItem;

            var addFolderDialog;
            var editFolderDialog;
            var deleteFolderDialog;
            var addSSGClusterDialog;
            var editSSGClusterDialog;
            var deleteSSGClusterDialog;
            var reconfirmSSGClusterDeletionDialog;
            var ssgClusterTrustDialog;
            var mapAccessAccountDialog;
            var changeAccessAccountDialog;

            function showHideLogReader() {
                var debugLogReader = document.getElementById('debugLogReader');
                if (debugLogReader.style.display == '') {
                    debugLogReader.style.display = 'none';
                } else {
                    debugLogReader.style.display = '';
                }
            }

            /**
             * @param {object} entity   the entity object literal
             * @param {string} action
             */
            function isPermitted(entity, action) {
                var result = false;
                if (entity.type == l7.EntityTreeTable.ENTITY.ENTERPRISE_FOLDER) {
                    var isRootFolder = entity.parentId == null;
                    if (action == 'addFolder') result = entity.rbacCUD;
                    if (action == 'edit') result = entity.rbacCUD;
                    if (action == 'move') result = !isRootFolder && entity.rbacCUD;
                    if (action == 'delete') result = !isRootFolder && entity.rbacCUD;
                    if (action == 'addSSGCluster') result = entity.rbacCUD;
                } else if (entity.type == l7.EntityTreeTable.ENTITY.SSG_CLUSTER) {
                    if (action == 'edit') result = entity.rbacCUD;
                    if (action == 'move') result = entity.rbacCUD;
                    if (action == 'delete') result = entity.rbacCUD;
                    if (action == 'launchSSM') result = entity.trustStatus &&
                                                        entity.accessStatus &&
                                                        entity.onlineStatus != l7.EntityTreeTable.SSG_CLUSTER_ONLINE_STATE.DOWN;
                } else if (entity.type == l7.EntityTreeTable.ENTITY.SSG_NODE) {
                    if (action == 'start') result = entity.trustStatus &&
                                                    entity.accessStatus &&
                                                    entity.onlineStatus != l7.EntityTreeTable.SSG_NODE_ONLINE_STATE.ON &&
                                                    entity.onlineStatus != l7.EntityTreeTable.SSG_NODE_ONLINE_STATE.OFFLINE;
                    if (action == 'stop') result = entity.trustStatus &&
                                                   entity.accessStatus &&
                                                   entity.onlineStatus == l7.EntityTreeTable.SSG_NODE_ONLINE_STATE.ON;
                } else if (entity.type == l7.EntityTreeTable.ENTITY.SERVICE_FOLDER) {
                    if (action == 'addFolder') result = entity.rbacCUD;
                    if (action == 'edit') result = entity.rbacCUD;
                    if (action == 'move') result = entity.rbacCUD;
                    if (action == 'delete') result = entity.rbacCUD;
                } else if (entity.type == l7.EntityTreeTable.ENTITY.PUBLISHED_SERVICE) {
                    if (action == 'launchSSM') result = entity.rbacCUD;
                } else if (entity.type == l7.EntityTreeTable.ENTITY.POLICY_FRAGMENT) {
                    if (action == 'launchSSM') result = entity.rbacCUD;
                }
                return result;
            }

            /**
             * Enables/Disables all toolbar buttons.
             * @param {boolean} enabled     true to enable; false to disable
             */
            function enableToolbarButtons(enabled) {
                addFolderButton.set('disabled', !enabled);
                addSSGClusterButton.set('disabled', !enabled);
                editButton.set('disabled', !enabled);
                //moveButton.set('disabled', !enabled);
                deleteButton.set('disabled', !enabled);
                startButton.set('disabled', !enabled);
                stopButton.set('disabled', !enabled);
                launchSSMButton.set('disabled', !enabled);
            }

            function onEntityHighlighted(previous, entity) {
                enableToolbarButtons(false);
                addFolderButton.set('disabled', !isPermitted(entity, 'addFolder'));
                editButton.set('disabled', !isPermitted(entity, 'edit'));
                //moveButton.set('disabled', !isPermitted(entity, 'move'));
                deleteButton.set('disabled', !isPermitted(entity, 'delete'));
                addSSGClusterButton.set('disabled', !isPermitted(entity, 'addSSGCluster'));
                startButton.set('disabled', !isPermitted(entity, 'start'));
                stopButton.set('disabled', !isPermitted(entity, 'stop'));
                launchSSMButton.set('disabled', !isPermitted(entity, 'launchSSM'));
            }

            function loadEntityTreeTable() {
                entityTreeTable.clear();
                enableToolbarButtons(false);    // because no entity is selected now

                function displayError() {
                    var tbody = document.getElementById('entityTreeTableBody');
                    var tr = tbody.insertRow(-1);
                    var td = tr.insertCell(-1);
                    td.colSpan = entityTreeTable._config.columns.length;
                    td.innerHTML = localizedStrings.ENTITY_DATA_ERROR;
                }

                var callback = {
                    success : function(o) {
                        var entities;
                        try {
                            entities = YAHOO.lang.JSON.parse(o.responseText);
                        } catch (e) {
                            displayError();
                            l7.Dialog.showErrorDialog(localizedStrings.ERROR, localizedStrings.CANNOT_PARSE_ENTITY_DATA + e, localizedStrings.OK);
                            return;
                        }
                        entityTreeTable.load(entities);
                    },
                    failure : function(o) {
                        displayError();
                        l7.Dialog.showErrorDialog(localizedStrings.ERROR, localizedStrings.CANNOT_DOWNLOAD_ENTITY_DATA + o.statusText, localizedStrings.OK);
                    }
                };
                YAHOO.util.Connect.asyncRequest('GET', jsonUrl, callback, null);
            }

            /**
             * Fetches entities data from server and then populates table body.
             */
            function initEntityTreeTable() {
                var tbody = document.getElementById('entityTreeTableBody');
                var config = {
                    localizedStrings : entityTreeTableLocalizedStrings,
                    columns : [
                        l7.EntityTreeTable.COLUMN.NAME,
                        l7.EntityTreeTable.COLUMN.ONLINE_STATUS,
                        l7.EntityTreeTable.COLUMN.TRUST_STATUS,
                        l7.EntityTreeTable.COLUMN.ACCESS_STATUS,
                        l7.EntityTreeTable.COLUMN.TYPE,
                        l7.EntityTreeTable.COLUMN.VERSION,
                        l7.EntityTreeTable.COLUMN.DETAILS
                    ],
                    highlightableEntities : [
                        l7.EntityTreeTable.ENTITY.ENTERPRISE_FOLDER,
                        l7.EntityTreeTable.ENTITY.SSG_CLUSTER,
                        l7.EntityTreeTable.ENTITY.SSG_NODE
                    ],
                    onEntityHighlighted : onEntityHighlighted,
                    onClickTrustDialogButton : onClickTrustDialogButton,
                    onClickAccessDialogButton : onClickAccessDialogButton
                };
                entityTreeTable = new l7.EntityTreeTable(tbody, [], '../images', config);

                loadEntityTreeTable();
            }

            /**
             * @param {string} name     the folder name to validate
             * @return {string} null if valid; displayable error message if invalid
             */
            function validateFolderName(name) {
                if (name.length < 1 || name.length > 128) return localizedStrings.INVALID_NAME_LENGTH;
                if (name.indexOf('/') != -1) return localizedStrings.INVALID_NAME_SLASH;
                if (name.search(/^\s/) != -1) return localizedStrings.INVALID_NAME_LEADING_SPACES;
                if (name.search(/\s$/) != -1) return localizedStrings.INVALID_NAME_TRAILING_SPACES;
                return null;
            }

            /**
             * @param {string} name     the folder name to validate
             * @return {string} null if valid; displayable error message if invalid
             */
            function validateSSGClusterName(name) {
                if (name.length < 1 || name.length > 128) return localizedStrings.INVALID_NAME_LENGTH;
                if (name.indexOf('/') != -1) return localizedStrings.INVALID_NAME_SLASH;
                if (name.search(/^\s/) != -1) return localizedStrings.INVALID_NAME_LEADING_SPACES;
                if (name.search(/\s$/) != -1) return localizedStrings.INVALID_NAME_TRAILING_SPACES;
                return null;
            }

            function onClickAddFolder(event) {
                var entity = entityTreeTable.getHighlightedEntity();
                document.getElementById('addFolderDialog_parentId').value = entity.id;
                document.getElementById('addFolderDialog_name').value = '';
                validateAddFolderDialog();
                addFolderDialog.center();
                addFolderDialog.show();
            }

            function onClickEditFolder(event) {
                var entity = entityTreeTable.getHighlightedEntity();
                document.getElementById('editFolderDialog_id').value = entity.id;
                document.getElementById('editFolderDialog_name').value = entity.name;
                validateEditFolderDialog();
                editFolderDialog.center();
                editFolderDialog.show();
            }

            function onClickEditSSGCluster(event) {
                var entity = entityTreeTable.getHighlightedEntity();
                document.getElementById('editSSGClusterDialog_id').value = entity.id;
                document.getElementById('editSSGClusterDialog_name').value = entity.name;
                document.getElementById('editSSGClusterDialog_sslHostname').value = entity.sslHostName;
                document.getElementById('editSSGClusterDialog_adminPort').value = entity.adminPort;

                validateEditSSGClusterDialog();
                editSSGClusterDialog.center();
                editSSGClusterDialog.show();
            }

            function onClickEdit(event) {
                var entity = entityTreeTable.getHighlightedEntity();
                if (entity.type == l7.EntityTreeTable.ENTITY.ENTERPRISE_FOLDER) {
                    onClickEditFolder(event);
                } else if (entity.type == l7.EntityTreeTable.ENTITY.SSG_CLUSTER) {
                    onClickEditSSGCluster(event);
                } else {
                    YAHOO.log('No edit handler for entity type: ' + entity.type, 'error', 'Configure.html');
                }
            }

            function onClickMove(event) {
                var entity = entityTreeTable.getHighlightedEntity();
                // TODO
alert('Not implemented yet!\n\nonClickMove\nentity.name = ' + entity.name);
            }

            function onClickDeleteFolder(event) {
                var entity = entityTreeTable.getHighlightedEntity();
                document.getElementById('deleteFolderDialog_id').value = entity.id;
                document.getElementById('deleteFolderDialog_name').innerHTML = l7.Util.escapeAsText(entity.name);
                deleteFolderDialog.center();
                deleteFolderDialog.show();
            }

            function onClickDeleteSSGCluster(event) {
                var entity = entityTreeTable.getHighlightedEntity();
                document.getElementById('deleteSSGClusterDialog_id').value = entity.id;
                document.getElementById('deleteSSGClusterDialog_name').innerHTML = l7.Util.escapeAsText(entity.name);
                deleteSSGClusterDialog.center();
                deleteSSGClusterDialog.show();
            }

            function onClickDelete(event) {
                var entity = entityTreeTable.getHighlightedEntity();
                if (entity.type == l7.EntityTreeTable.ENTITY.ENTERPRISE_FOLDER) {
                    onClickDeleteFolder(event);
                } else if (entity.type == l7.EntityTreeTable.ENTITY.SSG_CLUSTER) {
                    onClickDeleteSSGCluster(event);
                } else {
                    YAHOO.log('No delete handler for entity type: ' + entity.type, 'error', 'Configure.html');
                }
            }

            function onClickAddSSGCluster(event) {
                var entity = entityTreeTable.getHighlightedEntity();
                document.getElementById('addSSGClusterDialog_parentId').value = entity.id;
                document.getElementById('addSSGClusterDialog_name').value = '';
                document.getElementById('addSSGClusterDialog_hostName').value = '';
                document.getElementById('addSSGClusterDialog_port').value = '8443';
                validateAddSSGClusterDialog();
                addSSGClusterDialog.center();
                addSSGClusterDialog.show();
            }

            function onClickTrustDialogButton(event, entity) {
                if (entity.type == l7.EntityTreeTable.ENTITY.SSG_CLUSTER) {
                    launchSSGClusterTrustDialog(entity.id, entity.name, entity.sslHostName, entity.adminPort);
                } else if (entity.type == l7.EntityTreeTable.ENTITY.SSG_NODE) {
                    // TODO
alert('Not implemented yet!\n\nonClickTrustDialogButton\n\nentity.id = ' + entity.id + '\nentity.type = ' + entity.type + '\nentity.name = ' + entity.name);
                } else {
                    YAHOO.log('No trust action for entity type: ' + entity.type, 'error', 'Configure.html');
                }
            };

            function onClickAccessDialogButton(event, entity) {
                if (entity.type == l7.EntityTreeTable.ENTITY.SSG_CLUSTER) {
                    if (entity.accessStatus) {
                        launchChangeAccessAccountDialog(entity);
                    } else {
                        launchMapAccessAccountDialog(entity);
                    }
                } else {
                    YAHOO.log('No trust action for entity type: ' + entity.type, 'error', 'Configure.html');
                }
            };

            function onClickStart(event) {
                var entity = entityTreeTable.getHighlightedEntity();
                var callback = {
                    success : function(o) {
                        l7.Dialog.hideWaitDialog();
                        var result = l7.Dialog.parseJSON(
                                o.responseText,
                                localizedStrings.ERROR,
                                '<p>' + l7.Util.escapeAsText(localizedStrings.CANNOT_START_SSG_NODE) + '</p>',
                                localizedStrings.CANNOT_PARSE_RESPONSE_JSON,
                                localizedStrings.OK);
                        if (!l7.Util.isException(result)) {
                            // No return object expected.
                            loadEntityTreeTable();  // TODO should instead just update the status icon
                        }
                    },
                    failure : function(o) {
                        l7.Dialog.hideWaitDialog();
                        l7.Dialog.showErrorDialog(localizedStrings.ERROR, localizedStrings.CANNOT_START_SSG_NODE + o.statusText, localizedStrings.OK);
                    }
                };
                var url = document.forms['startSsgNodeForm'].action;
                var postData = 'startSsgNode_id=' + encodeURIComponent(entity.id);
                l7.Dialog.showWaitDialog(l7.Util.formatMessage(localizedStrings.STARTING_SSG_NODE, entity.name));
                YAHOO.util.Connect.asyncRequest('POST', url, callback, postData);
            }

            function onClickStop(event) {
                var entity = entityTreeTable.getHighlightedEntity();
                var callback = {
                    success : function(o) {
                        l7.Dialog.hideWaitDialog();
                        var result = l7.Dialog.parseJSON(
                                o.responseText,
                                localizedStrings.ERROR,
                                '<p>' + l7.Util.escapeAsText(localizedStrings.CANNOT_STOP_SSG_NODE) + '</p>',
                                localizedStrings.CANNOT_PARSE_RESPONSE_JSON,
                                localizedStrings.OK);
                        if (!l7.Util.isException(result)) {
                            // No return object expected.
                            loadEntityTreeTable();  // TODO should instead just update the status icon
                        }
                    },
                    failure : function(o) {
                        l7.Dialog.hideWaitDialog();
                        l7.Dialog.showErrorDialog(localizedStrings.ERROR, localizedStrings.CANNOT_STOP_SSG_NODE + o.statusText, localizedStrings.OK);
                    }
                };
                var url = document.forms['stopSsgNodeForm'].action;
                var postData = 'stopSsgNode_id=' + encodeURIComponent(entity.id);
                l7.Dialog.showWaitDialog(l7.Util.formatMessage(localizedStrings.STOPPING_SSG_NODE, entity.name));
                YAHOO.util.Connect.asyncRequest('POST', url, callback, postData);
            }

            function onClickLaunchSSM(event) {
                var entity = entityTreeTable.getHighlightedEntity();
                var url = 'https://' + entity.sslHostName + ':' + entity.adminAppletPort + '/ssg/webadmin';
                window.open(url, '_blank');
            }

            function validateAddFolderDialog() {
                var nameTextBox = document.getElementById('addFolderDialog_name');
                var name = nameTextBox.value;
                var errMsg = validateFolderName(name);
                var nameIsValid = errMsg == null;
                if (nameIsValid || name.length == 0) {
                    YAHOO.util.Dom.removeClass(nameTextBox, 'invalid');
                    document.getElementById('addFolderDialog_name_hint').innerHTML = '';
                } else if (name.length != 0) {
                    YAHOO.util.Dom.addClass(nameTextBox, 'invalid');
                    document.getElementById('addFolderDialog_name_hint').innerHTML = '(' + errMsg + ')';
                }

                var okButton = addFolderDialog.getButtons()[0];
                if (nameIsValid) {
                    okButton.set('disabled', false);
                } else {
                    okButton.set('disabled', true);
                }
            }

            function validateEditFolderDialog() {
                var nameTextBox = document.getElementById('editFolderDialog_name');
                var name = nameTextBox.value;
                var errMsg = validateFolderName(name);
                var nameIsValid = errMsg == null;
                if (nameIsValid || name.length == 0) {
                    YAHOO.util.Dom.removeClass(nameTextBox, 'invalid');
                    document.getElementById('editFolderDialog_name_hint').innerHTML = '';
                } else if (name.length != 0) {
                    YAHOO.util.Dom.addClass(nameTextBox, 'invalid');
                    document.getElementById('editFolderDialog_name_hint').innerHTML = '(' + errMsg + ')';
                }

                var okButton = editFolderDialog.getButtons()[0];
                if (nameIsValid) {
                    okButton.set('disabled', false);
                } else {
                    okButton.set('disabled', true);
                }
            }

            function validateAddSSGClusterDialog() {
                var nameTextBox = document.getElementById('addSSGClusterDialog_name');
                var name = nameTextBox.value;
                var errMsg = validateSSGClusterName(name);
                var nameIsValid = errMsg == null;
                if (nameIsValid || name.length == 0) {
                    YAHOO.util.Dom.removeClass(nameTextBox, 'invalid');
                    document.getElementById('addSSGClusterDialog_name_hint').innerHTML = '';
                } else if (name.length != 0) {
                    YAHOO.util.Dom.addClass(nameTextBox, 'invalid');
                    document.getElementById('addSSGClusterDialog_name_hint').innerHTML = '(' + errMsg + ')';
                }

                var hostNameIsValid = document.getElementById('addSSGClusterDialog_hostName').value.length > 0;

                var portTextBox = document.getElementById('addSSGClusterDialog_port');
                var port = portTextBox.value;
                var portIsValid = l7.Util.isIntString(port) && port > 0;
                if (portIsValid || port.length == 0) {
                    YAHOO.util.Dom.removeClass(portTextBox, 'invalid');
                    document.getElementById('addSSGClusterDialog_port_hint').innerHTML = '';
                } else if (port.length != 0) {
                    YAHOO.util.Dom.addClass(portTextBox, 'invalid');
                    document.getElementById('addSSGClusterDialog_port_hint').innerHTML = '(' + localizedStrings.SSG_CLUSTER_PORT_HINT + ')';
                }

                var okButton = addSSGClusterDialog.getButtons()[0];
                if (nameIsValid && hostNameIsValid && portIsValid) {
                    okButton.set('disabled', false);
                } else {
                    okButton.set('disabled', true);
                }
            }

            function validateEditSSGClusterDialog() {
                var nameTextBox = document.getElementById('editSSGClusterDialog_name');
                var name = nameTextBox.value;
                var errMsg = validateSSGClusterName(name);
                var nameIsValid = errMsg == null;
                if (nameIsValid || name.length == 0) {
                    YAHOO.util.Dom.removeClass(nameTextBox, 'invalid');
                    document.getElementById('editSSGClusterDialog_name_hint').innerHTML = '';
                } else if (name.length != 0) {
                    YAHOO.util.Dom.addClass(nameTextBox, 'invalid');
                    document.getElementById('editSSGClusterDialog_name_hint').innerHTML = '(' + errMsg + ')';
                }

                var hostNameIsValid = document.getElementById('editSSGClusterDialog_sslHostname').value.length > 0;

                var portTextBox = document.getElementById('editSSGClusterDialog_adminPort');
                var port = portTextBox.value;
                var portIsValid = l7.Util.isIntString(port) && port > 0;
                if (portIsValid || port.length == 0) {
                    YAHOO.util.Dom.removeClass(portTextBox, 'invalid');
                    document.getElementById('editSSGClusterDialog_port_hint').innerHTML = '';
                } else if (port.length != 0) {
                    YAHOO.util.Dom.addClass(portTextBox, 'invalid');
                    document.getElementById('editSSGClusterDialog_port_hint').innerHTML = '(' + localizedStrings.SSG_CLUSTER_PORT_HINT + ')';
                }

                var okButton = editSSGClusterDialog.getButtons()[0];
                if (nameIsValid && hostNameIsValid && portIsValid) {
                    okButton.set('disabled', false);
                } else {
                    okButton.set('disabled', true);
                }
            }

            function initAddFolderDialog() {
                addFolderDialog = new YAHOO.widget.Dialog('addFolderDialog', {
                    buttons     : [
                        {
                            text      : localizedStrings.OK,
                            handler   : function() {
                                this.submit();
                            },
                            isDefault : true
                        },
                        {
                            text      : localizedStrings.CANCEL,
                            handler   : function() {
                                this.hide();
                            }
                        }
                    ],
                    close       : true,
                    draggable   : true,
                    icon        : YAHOO.widget.SimpleDialog.ICON_BLOCK,
                    modal       : true,
                    postmethod  : 'async',
                    visible     : false
                });
                addFolderDialog.render();
                addFolderDialog.callback.success = function(o) {
                    var result = l7.Dialog.parseJSON(
                            o.responseText,
                            localizedStrings.ERROR,
                            '<p>' + l7.Util.escapeAsText(localizedStrings.CANNOT_ADD_FOLDER) + '</p>',
                            localizedStrings.CANNOT_PARSE_RESPONSE_JSON,
                            localizedStrings.OK);
                    if (typeof result == 'object' && !l7.Util.isException(result)) {
                        // A return object containing the ID of the new folder is expected.
                        var id = result.id; // Not used now but may be I'll think of something.
                        loadEntityTreeTable();  // Reloads to show new folder.
                    }
                }
                addFolderDialog.callback.failure = function(o) {
                    l7.Dialog.showErrorDialog(localizedStrings.ERROR, localizedStrings.CANNOT_ADD_FOLDER + o.statusText, localizedStrings.OK);
                }
            }

            function initEditFolderDialog() {
                editFolderDialog = new YAHOO.widget.Dialog('editFolderDialog', {
                    buttons     : [
                        {
                            text      : localizedStrings.OK,
                            handler   : function() {
                                this.submit();
                            },
                            isDefault : true
                        },
                        {
                            text      : localizedStrings.CANCEL,
                            handler   : function() {
                                this.hide();
                            }
                        }
                    ],
                    close       : true,
                    draggable   : true,
                    icon        : YAHOO.widget.SimpleDialog.ICON_BLOCK,
                    modal       : true,
                    postmethod  : 'async',
                    visible     : false
                });
                editFolderDialog.render();
                editFolderDialog.callback.success = function(o) {
                    var result = l7.Dialog.parseJSON(
                            o.responseText,
                            localizedStrings.ERROR,
                            '<p>' + l7.Util.escapeAsText(localizedStrings.CANNOT_EDIT_FOLDER) + '</p>',
                            localizedStrings.CANNOT_PARSE_RESPONSE_JSON,
                            localizedStrings.OK);
                    if (!l7.Util.isException(result)) {
                        // No return object expected.
                        loadEntityTreeTable();  // Reloads to show new folder name.
                    }
                }
                editFolderDialog.callback.failure = function(o) {
                    l7.Dialog.showErrorDialog(localizedStrings.ERROR, localizedStrings.CANNOT_EDIT_FOLDER + o.statusText, localizedStrings.OK);
                }
            }

            function initDeleteFolderDialog() {
                deleteFolderDialog = new YAHOO.widget.Dialog('deleteFolderDialog', {
                    buttons     : [
                        {
                            text      : localizedStrings.OK,
                            handler   : function() {
                                this.submit();
                            },
                            isDefault : true
                        },
                        {
                            text      : localizedStrings.CANCEL,
                            handler   : function() {
                                this.hide();
                            }
                        }
                    ],
                    close       : true,
                    draggable   : true,
                    icon        : YAHOO.widget.SimpleDialog.ICON_BLOCK,
                    modal       : true,
                    postmethod  : 'async',
                    visible     : false
                });
                deleteFolderDialog.render();
                deleteFolderDialog.callback.success = function(o) {
                    var result = l7.Dialog.parseJSON(
                            o.responseText,
                            localizedStrings.ERROR,
                            '<p>' + l7.Util.escapeAsText(localizedStrings.CANNOT_DELETE_FOLDER) + '</p>',
                            localizedStrings.CANNOT_PARSE_RESPONSE_JSON,
                            localizedStrings.OK);
                    if (!l7.Util.isException(result)) {
                        // No return object expected.
                        loadEntityTreeTable();  // Reloads to show folder gone.
                    }
                }
                deleteFolderDialog.callback.failure = function(o) {
                    l7.Dialog.showErrorDialog(localizedStrings.ERROR, localizedStrings.CANNOT_DELETE_FOLDER + o.statusText, localizedStrings.OK);
                }
            }

            function initAddSSGClusterDialog() {
                addSSGClusterDialog = new YAHOO.widget.Dialog('addSSGClusterDialog', {
                    buttons     : [
                        {
                            text      : localizedStrings.OK,
                            handler   : function() {
                                this.submit();
                            },
                            isDefault : true
                        },
                        {
                            text      : localizedStrings.CANCEL,
                            handler   : function() {
                                this.hide();
                            }
                        }
                    ],
                    close       : true,
                    draggable   : true,
                    icon        : YAHOO.widget.SimpleDialog.ICON_BLOCK,
                    modal       : true,
                    postmethod  : 'async',
                    visible     : false
                });
                addSSGClusterDialog.render();
                addSSGClusterDialog.callback.success = function(o) {
                    var result = l7.Dialog.parseJSON(
                            o.responseText,
                            localizedStrings.ERROR,
                            '<p>' + l7.Util.escapeAsText(localizedStrings.CANNOT_ADD_SSG_CLUSTER) + '</p>',
                            localizedStrings.CANNOT_PARSE_RESPONSE_JSON,
                            localizedStrings.OK);
                    if (typeof result == 'object' && !l7.Util.isException(result)) {
                        // A return object containing the ID of the new cluster is expected.
                        var id = result.id;
                        loadEntityTreeTable();  // Reloads to show new SSG Cluster.

                        // Note: loadEntityTreeTable() is asynchronous, so we cannot
                        // call entityTreeTable.getEntityById(id).name etc. here.
                        var name = document.getElementById('addSSGClusterDialog_name').value;
                        var hostName = document.getElementById('addSSGClusterDialog_hostName').value;
                        var port = document.getElementById('addSSGClusterDialog_port').value;
                        launchSSGClusterTrustDialog(id, name, hostName, port);
                    }
                }
                addSSGClusterDialog.callback.failure = function(o) {
                    l7.Dialog.showErrorDialog(localizedStrings.ERROR, localizedStrings.CANNOT_ADD_SSG_CLUSTER + o.statusText, localizedStrings.OK);
                }
            }

            function initEditSSGClusterDialog() {
                editSSGClusterDialog = new YAHOO.widget.Dialog('editSSGClusterDialog', {
                    buttons     : [
                        {
                            text      : localizedStrings.OK,
                            handler   : function() {
                                this.submit();
                            },
                            isDefault : true
                        },
                        {
                            text      : localizedStrings.CANCEL,
                            handler   : function() {
                                this.hide();
                            }
                        }
                    ],
                    close       : true,
                    draggable   : true,
                    icon        : YAHOO.widget.SimpleDialog.ICON_BLOCK,
                    modal       : true,
                    postmethod  : 'async',
                    visible     : false
                });
                editSSGClusterDialog.render();
                editSSGClusterDialog.callback.success = function(o) {
                    var result = l7.Dialog.parseJSON(
                            o.responseText,
                            localizedStrings.ERROR,
                            '<p>' + l7.Util.escapeAsText(localizedStrings.CANNOT_EDIT_SSG_CLUSTER) + '</p>',
                            localizedStrings.CANNOT_PARSE_RESPONSE_JSON,
                            localizedStrings.OK);
                    if (!l7.Util.isException(result)) {
                        // No return object expected.
                        loadEntityTreeTable();  // Reloads to show new SSG Cluster name.
                    }
                }
                editSSGClusterDialog.callback.failure = function(o) {
                    l7.Dialog.showErrorDialog(localizedStrings.ERROR, localizedStrings.CANNOT_EDIT_SSG_CLUSTER + o.statusText, localizedStrings.OK);
                }
            }

            function initDeleteSSGClusterDialog() {
                deleteSSGClusterDialog = new YAHOO.widget.Dialog('deleteSSGClusterDialog', {
                    buttons     : [
                        {
                            text      : localizedStrings.OK,
                            handler   : function() {
                                this.submit();
                            },
                            isDefault : true
                        },
                        {
                            text      : localizedStrings.CANCEL,
                            handler   : function() {
                                this.hide();
                            }
                        }
                    ],
                    close       : true,
                    draggable   : true,
                    icon        : YAHOO.widget.SimpleDialog.ICON_BLOCK,
                    modal       : true,
                    postmethod  : 'async',
                    visible     : false
                });
                deleteSSGClusterDialog.render();
                deleteSSGClusterDialog.callback.success = function(o) {
                    var result = l7.Dialog.parseJSON(
                            o.responseText,
                            localizedStrings.ERROR,
                            '<p>' + l7.Util.escapeAsText(localizedStrings.CANNOT_DELETE_SSG_CLUSTER) + '</p>',
                            localizedStrings.CANNOT_PARSE_RESPONSE_JSON,
                            localizedStrings.OK);
                    if (!l7.Util.isException(result)) {
                        if (result == null)  {
                            // No return object expected.
                            loadEntityTreeTable();  // Reloads to show SSG Cluster gone.
                        } else if (result.reconfirm != undefined && result.reconfirm == true) {
                            // Launch the dialog to reconfirm the SSG Cluster deletion with all related informatin deleted.
                            launchReconfirmSSGClusterDeletionDialog();
                        }
                    }
                }
                deleteSSGClusterDialog.callback.failure = function(o) {
                    l7.Dialog.showErrorDialog(localizedStrings.ERROR, localizedStrings.CANNOT_DELETE_SSG_CLUSTER + o.statusText, localizedStrings.OK);
                }
            }

            function initReconfirmSSGClusterDeletionDialog() {
                reconfirmSSGClusterDeletionDialog = new YAHOO.widget.Dialog('reconfirmSSGClusterDeletionDialog', {
                    buttons     : [
                        {
                            text      : localizedStrings.OK,
                            handler   : function() {
                                this.submit();
                            },
                            isDefault : true
                        },
                        {
                            text      : localizedStrings.CANCEL,
                            handler   : function() {
                                this.hide();
                            }
                        }
                    ],
                    close       : true,
                    draggable   : true,
                    icon        : YAHOO.widget.SimpleDialog.ICON_BLOCK,
                    modal       : true,
                    postmethod  : 'async',
                    visible     : false
                });
                reconfirmSSGClusterDeletionDialog.render();
                reconfirmSSGClusterDeletionDialog.callback.success = function(o) {
                    var result = l7.Dialog.parseJSON(
                            o.responseText,
                            localizedStrings.ERROR,
                            '<p>' + l7.Util.escapeAsText(localizedStrings.CANNOT_DELETE_SSG_CLUSTER) + '</p>',
                            localizedStrings.CANNOT_PARSE_RESPONSE_JSON,
                            localizedStrings.OK);
                    if (!l7.Util.isException(result)) {
                        // No return object expected.
                        loadEntityTreeTable();  // Reloads to show SSG Cluster gone.
                    }
                }
                reconfirmSSGClusterDeletionDialog.callback.failure = function(o) {
                    l7.Dialog.showErrorDialog(localizedStrings.ERROR, localizedStrings.CANNOT_DELETE_SSG_CLUSTER + o.statusText, localizedStrings.OK);
                }
            }

            function initSSGClusterTrustDialog() {
                ssgClusterTrustDialog = new YAHOO.widget.Dialog('ssgClusterTrustDialog', {
                    buttons     : [
                        {
                            text      : localizedStrings.OK,
                            handler   : function() {
                                this.submit();
                            },
                            isDefault : true
                        },
                        {
                            text      : localizedStrings.CANCEL,
                            handler   : function() {
                                this.hide();
                            }
                        }
                    ],
                    close       : true,
                    draggable   : true,
                    icon        : YAHOO.widget.SimpleDialog.ICON_BLOCK,
                    modal       : true,
                    postmethod  : 'form',
                    visible     : false
                });
                ssgClusterTrustDialog.render();
            }

            function initMapAccessAccountDialog() {
                mapAccessAccountDialog = new YAHOO.widget.Dialog('mapAccessAccountDialog', {
                    buttons     : [
                        {
                            text      : localizedStrings.OK,
                            handler   : function() {
                                this.submit();
                            },
                            isDefault : true
                        },
                        {
                            text      : localizedStrings.CANCEL,
                            handler   : function() {
                                this.hide();
                            }
                        }
                    ],
                    close       : true,
                    draggable   : true,
                    icon        : YAHOO.widget.SimpleDialog.ICON_BLOCK,
                    modal       : true,
                    postmethod  : 'form',
                    visible     : false
                });
                mapAccessAccountDialog.render();
            }

            function initChangeAccessAccountDialog() {
                changeAccessAccountDialog = new YAHOO.widget.Dialog('changeAccessAccountDialog', {
                    buttons     : [
                        {
                            text      : localizedStrings.OK,
                            handler   : function() {
                                this.submit();
                            },
                            isDefault : true
                        },
                        {
                            text      : localizedStrings.CANCEL,
                            handler   : function() {
                                this.hide();
                            }
                        }
                    ],
                    close       : true,
                    draggable   : true,
                    icon        : YAHOO.widget.SimpleDialog.ICON_BLOCK,
                    modal       : true,
                    postmethod  : 'form',
                    visible     : false
                });
                changeAccessAccountDialog.render();
            }

            /**
             * Launch the dialog to reconfirm the SSG Cluster deletion with all related informatin deleted.
             */
            function launchReconfirmSSGClusterDeletionDialog() {
                var entity = entityTreeTable.getHighlightedEntity();
                document.getElementById('reconfirmSSGClusterDeletionDialog_id').value = entity.id;
                document.getElementById('reconfirmSSGClusterDeletionDialog_name').innerHTML = l7.Util.escapeAsText(entity.name);
                reconfirmSSGClusterDeletionDialog.center();
                reconfirmSSGClusterDeletionDialog.show();
            }

            /**
             * @param {string} id   SSG Cluster ID
             */
            function launchSSGClusterTrustDialog(id, name, hostName, port) {
                var callback = {
                    success : function(o) {
                        var result = l7.Dialog.parseJSON(
                                o.responseText,
                                localizedStrings.ERROR,
                                '<p>' + l7.Util.escapeAsText(localizedStrings.CANNOT_GET_DATA_TO_ESTABLISH_TRUST) + '</p>',
                                localizedStrings.CANNOT_PARSE_RESPONSE_JSON,
                                localizedStrings.OK);
                        if (typeof result == 'object' && !l7.Util.isException(result)) {
                            // The response object is expected to have these properties:
                            // token {string} - an opague token for use as input to the gateway trust servlet
                            var baseURL = document.URL;
                            var queryPos = baseURL.indexOf('?');
                            if (queryPos > -1) {
                                baseURL = baseURL.substr(0, queryPos);  // Strips off query part.
                            }
                            document.getElementById('ssgClusterTrustForm_returnurl').value = baseURL + '?clusterguid=' + o.argument.id;
                            document.getElementById('ssgClusterTrustForm_emstoken').value = result.token;
                            document.getElementById('ssgClusterTrustForm').action = 'https://' + o.argument.hostName + ':' + o.argument.port + '/ssg/esmtrust?esmtrust=1';
                            document.getElementById('ssgClusterTrustDialog_name').innerHTML = o.argument.name;
                            ssgClusterTrustDialog.center();
                            ssgClusterTrustDialog.show();
                        }
                    },
                    failure : function(o) {
                        l7.Dialog.showErrorDialog(
                                localizedStrings.ERROR,
                                localizedStrings.CANNOT_GET_DATA_TO_ESTABLISH_TRUST + o.statusText,
                                localizedStrings.OK);
                    },
                    argument : {
                        id       : id,
                        name     : name,
                        hostName : hostName,
                        port     : port
                    }
                };
                var url = document.forms['getGatewayTrustServletInputsForm'].action;
                YAHOO.util.Connect.asyncRequest('GET', url, callback, null);
            }

            /**
             * @param {object} entity   the SSG Cluster entity object literal
             */
            function launchMapAccessAccountDialog(entity) {
                var callback = {
                    success : function(o) {
                        var result = l7.Dialog.parseJSON(
                                o.responseText,
                                localizedStrings.ERROR,
                                '<p>' + l7.Util.escapeAsText(localizedStrings.CANNOT_GET_DATA_TO_MAP_ACCESS_ACCOUNT) + '</p>',
                                localizedStrings.CANNOT_PARSE_RESPONSE_JSON,
                                localizedStrings.OK);
                        if (typeof result == 'object' && !l7.Util.isException(result)) {
                            // The response object is expected to have these properties:
                            // token {string} - an opague token for use as input to the gateway trust servlet
                            var entity = o.argument;
                            document.getElementById('mapAccessAccountForm_emstoken').value = result.token;
                            document.getElementById('mapAccessAccountForm_returnurl').value = document.URL + '?clusterguid=' + entity.id;
                            document.getElementById('mapAccessAccountForm').action = 'https://' + entity.sslHostName + ':' + entity.adminPort + '/ssg/esmtrust';
                            document.getElementById('mapAccessAccountDialog_ssgClusterName').innerHTML = entity.name;
                            mapAccessAccountDialog.center();
                            mapAccessAccountDialog.show();
                        }
                    },
                    failure : function(o) {
                        l7.Dialog.showErrorDialog(
                                localizedStrings.ERROR,
                                localizedStrings.CANNOT_GET_DATA_TO_MAP_ACCESS_ACCOUNT + o.statusText,
                                localizedStrings.OK);
                    },
                    argument : entity
                };
                var url = document.forms['getGatewayTrustServletInputsForm'].action;
                YAHOO.util.Connect.asyncRequest('GET', url, callback, null);
            }

            /**
             * @param {object} entity   the SSG Cluster entity object literal
             */
            function launchChangeAccessAccountDialog(entity) {
                var callback = {
                    success : function(o) {
                        var result = l7.Dialog.parseJSON(
                                o.responseText,
                                localizedStrings.ERROR,
                                '<p>' + l7.Util.escapeAsText(localizedStrings.CANNOT_GET_DATA_TO_MAP_ACCESS_ACCOUNT) + '</p>',
                                localizedStrings.CANNOT_PARSE_RESPONSE_JSON,
                                localizedStrings.OK);
                        if (typeof result == 'object' && !l7.Util.isException(result)) {
                            // The response object is expected to have these properties:
                            // token {string} - an opague token for use as input to the gateway trust servlet
                            var entity = o.argument;
                            document.getElementById('changeAccessAccountForm_emstoken').value = result.token;
                            document.getElementById('changeAccessAccountForm_returnurl').value = document.URL + '?clusterguid=' + entity.id;
                            document.getElementById('changeAccessAccountForm').action = 'https://' + entity.sslHostName + ':' + entity.adminPort + '/ssg/esmtrust';
                            document.getElementById('changeAccessAccountDialog_ssgClusterName').innerHTML = entity.name;
                            changeAccessAccountDialog.center();
                            changeAccessAccountDialog.show();
                        }
                    },
                    failure : function(o) {
                        l7.Dialog.showErrorDialog(
                                localizedStrings.ERROR,
                                localizedStrings.CANNOT_GET_DATA_TO_MAP_ACCESS_ACCOUNT + o.statusText,
                                localizedStrings.OK);
                    },
                    argument : entity
                };
                var url = document.forms['getGatewayTrustServletInputsForm'].action;
                YAHOO.util.Connect.asyncRequest('GET', url, callback, null);
            }

            function initDialogs() {
                initAddFolderDialog();
                initEditFolderDialog();
                initDeleteFolderDialog();
                initAddSSGClusterDialog();
                initEditSSGClusterDialog();
                initDeleteSSGClusterDialog();
                initReconfirmSSGClusterDeletionDialog();
                initSSGClusterTrustDialog();
                initMapAccessAccountDialog();
                initChangeAccessAccountDialog();
            }

            function initToolbar() {
                addFolderButton = new YAHOO.widget.Button('addFolderButton', {
                    label   : '<img src="../images/addFolder.png" alt="" />&nbsp;' + localizedStrings.ADD_FOLDER,
                    onclick : {fn : onClickAddFolder}
                });
                addSSGClusterButton = new YAHOO.widget.Button('addSSGClusterButton', {
                    label   : '<img src="../images/addSSGCluster.png" alt="" />&nbsp;' + localizedStrings.ADD_SSG_CLUSTER,
                    onclick : {fn : onClickAddSSGCluster}
                });
                editButton = new YAHOO.widget.Button('editButton', {
                    label   : '<img src="../images/rename.png" alt="" />&nbsp;' + localizedStrings.EDIT,
                    onclick : {fn : onClickEdit}
                });
                /*moveButton = new YAHOO.widget.Button('moveButton', {
                    label   : '<img src="../images/move.png" alt="" />&nbsp;' + localizedStrings.MOVE,
                    onclick : {fn : onClickMove}
                });*/
                deleteButton = new YAHOO.widget.Button('deleteButton', {
                    label   : '<img src="../images/delete.png" alt="" />&nbsp;' + localizedStrings.DELETE,
                    onclick : {fn : onClickDelete}
                });
                startButton = new YAHOO.widget.Button('startButton', {
                    label   : '<img src="../images/start.png" alt="" />&nbsp;' + localizedStrings.START,
                    onclick : {fn : onClickStart}
                });
                stopButton = new YAHOO.widget.Button('stopButton', {
                    label   : '<img src="../images/stop.png" alt="" />&nbsp;' + localizedStrings.STOP,
                    onclick : {fn : onClickStop}
                });
                launchSSMButton = new YAHOO.widget.Button('launchSSMButton', {
                    label   : '<img src="../images/ssm.png" alt="" />&nbsp;' + localizedStrings.LAUNCH_SSM,
                    onclick : {fn : onClickLaunchSSM}
                });

                // Buttons are initially disabled because no entity has been selected yet.
                enableToolbarButtons(false);
            }

            /**
             * "beforeshow" event handler for the ContextMenu instance.
             *
             * @param {string} eventName    string representing the name of the event that was fired
             * @param {array} args          first array element is the DOM event object (if this is a DOM event),
             *                              second array element is the target of the event if it was a MenuItem instance
             */
            function onContextMenuBeforeShow(eventName, args) {
                var entity = entityTreeTable.findEntityFromContextEventTarget(this.contextEventTarget);
                entityTreeTable.highlightEntity(entity, true);

                this.clearContent();
                initContextMenuItemsEventHandler(); // Need to do this because, strangely, clearContent destroys the onclick handler of menu items.

                if (isPermitted(entity, 'addFolder')) this.addItem(addFolderMenuItem);
                if (isPermitted(entity, 'edit')) this.addItem(editMenuItem);
// TODO         if (isPermitted(entity, 'move')) this.addItem(moveMenuItem);
                if (isPermitted(entity, 'delete')) this.addItem(deleteMenuItem);
                if (isPermitted(entity, 'addSSGCluster')) this.addItem(addSSGClusterMenuItem);
                if (isPermitted(entity, 'start')) this.addItem(startMenuItem);
                if (isPermitted(entity, 'stop')) this.addItem(stopMenuItem);
                if (isPermitted(entity, 'launchSSM')) this.addItem(launchSSMMenuItem);

                if (this.getItems().length == 0) {
                    // So we don't have a blank context menu.
                    this.addItem({text : localizedStrings.NO_ACCESS, disabled : true});
                }

                this.render();
            }

            /**
             * "hide" event handler for the ContextMenu instance.
             *
             * @param {string} eventName    string representing the name of the event that was fired
             * @param {array} args          first array element is the DOM event object (if this is a DOM event),
             *                              second array element is the target of the event if it was a MenuItem instance
             */
            function onContextMenuHide(eventName, args) {
                entityTreeTable.highlightEntity(null, true);
            }

            function initContextMenuItemsEventHandler() {
                addFolderMenuItem.cfg.setProperty('onclick', {fn : onClickAddFolder});
                addSSGClusterMenuItem.cfg.setProperty('onclick', {fn : onClickAddSSGCluster});
                editMenuItem.cfg.setProperty('onclick', {fn : onClickEdit});
                moveMenuItem.cfg.setProperty('onclick', {fn : onClickMove});
                deleteMenuItem.cfg.setProperty('onclick', {fn : onClickDelete});
                startMenuItem.cfg.setProperty('onclick', {fn : onClickStart});
                stopMenuItem.cfg.setProperty('onclick', {fn : onClickStop});
                launchSSMMenuItem.cfg.setProperty('onclick', {fn : onClickLaunchSSM});
            }

            function initContextMenuItems() {
                addFolderMenuItem = new YAHOO.widget.MenuItem('<img src="../images/addFolder.png">&nbsp;' + localizedStrings.ADD_FOLDER);
                addSSGClusterMenuItem = new YAHOO.widget.MenuItem('<img src="../images/addSSGCluster.png">&nbsp;' + localizedStrings.ADD_SSG_CLUSTER);
                editMenuItem = new YAHOO.widget.MenuItem('<img src="../images/rename.png">&nbsp;' + localizedStrings.EDIT);
                moveMenuItem = new YAHOO.widget.MenuItem('<img src="../images/move.png">&nbsp;' + localizedStrings.MOVE);
                deleteMenuItem = new YAHOO.widget.MenuItem('<img src="../images/delete.png">&nbsp;' + localizedStrings.DELETE);
                startMenuItem = new YAHOO.widget.MenuItem('<img src="../images/start.png">&nbsp;' + localizedStrings.START);
                stopMenuItem = new YAHOO.widget.MenuItem('<img src="../images/stop.png">&nbsp;' + localizedStrings.STOP);
                launchSSMMenuItem = new YAHOO.widget.MenuItem('<img src="../images/ssm.png">&nbsp;' + localizedStrings.LAUNCH_SSM);
                initContextMenuItemsEventHandler(); // This could have been done by a configuration parameter passed into
                                                    // the constructor, but refactored out so that onContextMenuBeforeShow
                                                    // call the same function.
            }

            function initContextMenu() {
                initContextMenuItems();

                var tbody = document.getElementById('entityTreeTableBody');
                var contextMenu = new YAHOO.widget.ContextMenu('contextMenu', {
                    trigger: tbody,
                    lazyload: true
                });

                // Subscribe to the ContextMenu instance's "beforeshow" and "hide" events.
                contextMenu.subscribe('beforeShow', onContextMenuBeforeShow);
                contextMenu.subscribe('hide', onContextMenuHide);
            }

            function init() {
                var debugLogReader = new YAHOO.widget.LogReader('debugLogReader');
                debugLogReader.hide();   // Initially hidden.

                initDialogs();
                initToolbar();
                initContextMenu();
                initEntityTreeTable();
            }

            YAHOO.util.Event.onDOMReady(init);
        </script>
    </wicket:head>
</head>
<body class="yui-skin-sam">
<noscript><div class="javascriptWarning">This page requires JavaScript. Your browser either does not have JavaScript support or has disabled it.</div></noscript>
<table width="100%">
    <tr>
        <td>
            <div class="header">
                <table width="100%">
                    <tr class="header">
                        <td class="logoLeft"><img src="../images/logoLeft.png" alt="" /></td>
                        <td class="logo"><a href="Monitor.html"><img src="../images/l7Logo.png" alt="Layer 7 Technologies Inc." /><img src="../images/esmLogo.png" alt="" /></a></td>
                        <td class="logoRight"><img src="../images/logoRight.png" alt="" /></td>
                        <td width="100%"><img src="../images/spacer.png" alt="" /></td>
                        <td class="middle nowrap">Logged in as "admin"<br />since May 5, 2008 05:57:54 PM</td>
                        <td class="middle"><form method="get" action="Login.html"><input type="submit" value="Log Out" /></form></td>
                        <td class="middle help"><a href="Help.html" target="l7-esm-help" title="Open help page in a separate window">Help</a></td>
                    </tr>
                </table>
            </div>
            <div class="divider"><img src="../images/spacer.png" alt="" /></div>
            <div>
                <table>
                    <tr>
                        <td id="tabLTManageGateways"><img src="../images/tabLT.png" alt="" /></td>
                        <td id="tabCTManageGateways" class="tabCT"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabRTManageGateways"><img src="../images/tabRT.png" alt="" /></td>
                        <td id="tabLTManagePolicies"><img src="../images/tabLT.png" alt="" /></td>
                        <td id="tabCTManagePolicies" class="tabCT"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabRTManagePolicies"><img src="../images/tabRT.png" alt="" /></td>
                        <td id="tabLTReports"><img src="../images/tabLT.png" alt="" /></td>
                        <td id="tabCTReports" class="tabCT"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabRTReports"><img src="../images/tabRT.png" alt="" /></td>
                        <td id="tabLTTools"><img src="../images/tabLT.png" alt="" /></td>
                        <td id="tabCTTools" class="tabCT"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabRTTools"><img src="../images/tabRT.png" alt="" /></td>
                        <td id="tabLTSettings"><img src="../images/tabLT.png" alt="" /></td>
                        <td id="tabCTSettings" class="tabCT"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabRTSettings"><img src="../images/tabRT.png" alt="" /></td>
                        <td><img src="../images/tabLT.png" alt="" /></td>
                        <td class="tabCT"><img src="../images/spacer.png" alt="" /></td>
                        <td><img src="../images/tabRT.png" alt="" /></td>
                    </tr>
                    <tr>
                        <td id="tabLMManageGateways" class="tabLM"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabCMManageGateways" class="tabCMon">Manage Gateways</td>
                        <td id="tabRMManageGateways" class="tabRM"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabLMManagePolicies" class="tabLM"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabCMManagePolicies" class="tabCM"><a href="PolicyMigration.html">Manage Policies</a></td>
                        <td id="tabRMManagePolicies" class="tabRM"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabLMReports" class="tabLM"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabCMReports" class="tabCM"><a href="StandardReports.html">Reports</a></td>
                        <td id="tabRMReports" class="tabRM"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabLMTools" class="tabLM"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabCMTools" class="tabCM"><a href="Messages.html">Tools</a></td>
                        <td id="tabRMTools" class="tabRM"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabLMSettings" class="tabLM"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabCMSettings" class="tabCM"><a href="UserSettings.html">Settings</a></td>
                        <td id="tabRMSettings" class="tabRM"><img src="../images/spacer.png" alt="" /></td>
                        <td class="tabLM"><img src="../images/spacer.png" alt="" /></td>
                        <td class="tabCM" width="100%"><img src="../images/spacer.png" alt="" /></td>
                        <td class="tabRM"><img src="../images/spacer.png" alt="" /></td>
                    </tr>
                    <tr>
                        <td id="tabLBManageGateways"><img src="../images/tabLBon.png" alt="" /></td>
                        <td id="tabCBManageGateways" class="tabCBon"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabRBManageGateways"><img src="../images/tabRBon.png" alt="" /></td>
                        <td id="tabLBManagePolicies"><img src="../images/tabLBoff.png" alt="" /></td>
                        <td id="tabCBManagePolicies" class="tabCBoff"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabRBManagePolicies"><img src="../images/tabRBoff.png" alt="" /></td>
                        <td id="tabLBReports"><img src="../images/tabLBoff.png" alt="" /></td>
                        <td id="tabCBReports" class="tabCBoff"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabRBReports"><img src="../images/tabRBoff.png" alt="" /></td>
                        <td id="tabLBTools"><img src="../images/tabLBoff.png" alt="" /></td>
                        <td id="tabCBTools" class="tabCBoff"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabRBTools"><img src="../images/tabRBoff.png" alt="" /></td>
                        <td id="tabLBSettings"><img src="../images/tabLBoff.png" alt="" /></td>
                        <td id="tabCBSettings" class="tabCBoff"><img src="../images/spacer.png" alt="" /></td>
                        <td id="tabRBSettings"><img src="../images/tabRBoff.png" alt="" /></td>
                        <td><img src="../images/tabLBoff.png" alt="" /></td>
                        <td class="tabCBoff"><img src="../images/spacer.png" alt="" /></td>
                        <td><img src="../images/tabRBoff.png" alt="" /></td>
                    </tr>
                </table>
            </div>
            <script language="JavaScript" type="text/javascript">
                l7.TabBar.initTab('ManagePolicies');
                l7.TabBar.initTab('Reports');
                l7.TabBar.initTab('Tools');
                l7.TabBar.initTab('Settings');
            </script>
            <div class="subtabBar">
                <span class="subtabOff"><a href="Monitor.html">Monitor</a></span>
                |
                <span class="subtabOn">Configure</span>
                |
                <span class="subtabOff"><a href="Backup.html">Backup</a></span>
                |
                <span class="subtabOff"><a href="Restore.html">Restore</a></span>
            </div>
            <div class="content">
                <wicket:extend>
                    <div class="panel">
                        <div class="panelTitle">Enterprise Gateways <img class="refresh clickableImg" src="../images/refresh.png" title="Refresh" alt="Refresh" onclick="loadEntityTreeTable();" /></div>
                        <div id="enterpriseTree">
                            <div class="panelToolbar">
                                <button id="addFolderButton" type="submit" name="addFolderButton" value="addFolder"></button>
                                <button id="addSSGClusterButton" type="submit" name="addSSGClusterButton" value="addSSGCluster"></button>
                                <button id="editButton" type="submit" name="editButton" value="edit"></button>
                                <!--<button id="moveButton" type="submit" name="moveButton" value="move"></button>-->
                                <button id="deleteButton" type="submit" name="deleteButton" value="delete"></button>
                                <button id="startButton" type="submit" name="startButton" value="start"></button>
                                <button id="stopButton" type="submit" name="stopButton" value="stop"></button>
                                <button id="launchSSMButton" type="submit" name="launchSSMButton" value="ssm"></button>
                            </div>
                            <div class="panelContent">
                                <table id="entityTreeTable" class="dataTable" width="100%">
                                    <thead>
                                        <tr>
                                            <th class="name">Name<br /><img src="../images/spacer.png" alt="" height="0" width="140" /><!-- minimum width --></th>
                                            <th><img src="../images/status.png" title="Online Status" alt="" /></th>
                                            <th><img src="../images/trust.png" title="Trust Status" alt="" /></th>
                                            <th><img src="../images/accessAccount.png" title="Access Status" alt="" /></th>
                                            <th>Type</th>
                                            <th>Version</th>
                                            <th width="100%">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="entityTreeTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

<div wicket:id="actiondiv"/>


<div id="addFolderDialog">
    <div class="hd">New Folder</div>
    <div class="bd">
        <form name="addFolderForm" wicket:id="addFolderForm" method="POST">
            <input id="addFolderDialog_parentId" wicket:id="addFolderDialog_parentId" type="hidden" name="parentId" />
            <table class="spaced">
                <tr>
                    <th>Name:</th>
                    <td><input type="text" id="addFolderDialog_name" wicket:id="addFolderDialog_name" name="name" size="40" maxlength="128" onkeyup="validateAddFolderDialog();" /> <span id="addFolderDialog_name_hint" class="red"></span></td>
                </tr>
            </table>
        </form>
    </div>
</div>

<div id="editFolderDialog">
    <div class="hd">Edit Folder</div>
    <div class="bd">
        <form name="editFolderForm" wicket:id="editFolderForm" method="POST">
            <input id="editFolderDialog_id" wicket:id="editFolderDialog_id" type="hidden" name="id" />
            <table class="spaced">
                <tr>
                    <th>New Name:</th>
                    <td><input type="text" id="editFolderDialog_name" wicket:id="editFolderDialog_name" name="name" size="40" maxlength="128" onkeyup="validateEditFolderDialog();" /> <span id="editFolderDialog_name_hint" class="red"></span></td>
                </tr>
            </table>
        </form>
    </div>
</div>

<div id="deleteFolderDialog">
    <div class="hd">Delete Folder</div>
    <div class="bd">
        <form name="deleteFolderForm" wicket:id="deleteFolderForm" method="POST">
            <input id="deleteFolderDialog_id" wicket:id="deleteFolderDialog_id" type="hidden" name="id" />
            Are you sure to delete the folder &ldquo;<span id="deleteFolderDialog_name"></span>&rdquo;?
        </form>
    </div>
</div>

<div id="addSSGClusterDialog">
    <div class="hd">Add SSG Cluster</div>
    <div class="bd">
        <form name="addSSGClusterForm" wicket:id="addSSGClusterForm" method="POST">
            <input id="addSSGClusterDialog_parentId" wicket:id="addSSGClusterDialog_parentId" type="hidden" name="parentId" />
            <table class="spaced">
                <tr>
                    <th>Name:</th>
                    <td><input type="text" id="addSSGClusterDialog_name" wicket:id="addSSGClusterDialog_name" name="name" size="40" maxlength="128" onkeyup="validateAddSSGClusterDialog();" /> <span id="addSSGClusterDialog_name_hint" class="red"></span></td>
                </tr>
                <tr>
                    <th>Host Name:</th>
                    <td><input type="text" id="addSSGClusterDialog_hostName" wicket:id="addSSGClusterDialog_hostName" name="hostName" size="40" maxlength="128" onkeyup="validateAddSSGClusterDialog();" /></td>
                </tr>
                <tr>
                    <th>Administrative Port Number:</th>
                    <td><input type="text" id="addSSGClusterDialog_port" wicket:id="addSSGClusterDialog_port" name="port" size="10" onkeyup="validateAddSSGClusterDialog();" /> <span id="addSSGClusterDialog_port_hint" class="red"></span></td>
                </tr>
            </table>
        </form>
    </div>
</div>

<div id="ssgClusterTrustDialog">
    <div class="hd">Establish Trust by SSG Cluster</div>
    <div class="bd" style="width: 40em;">
        <form id="ssgClusterTrustForm" method="POST">
            <input id="ssgClusterTrustForm_emstoken" type="hidden" name="token" />
            <input id="ssgClusterTrustForm_returnurl" type="hidden" name="returnurl" />
            <input id="ssgClusterTrustForm_returntoken" type="hidden" name="returntoken" />
        </form>
        To establish trust of this Enterprise Service Manager by the SSG Cluster
        &ldquo;<span id="ssgClusterTrustDialog_name"></span>&rdquo;,
        you will now be redirected to the cluster server where
        you can authenticate using a gateway administrator account.
        That account will also be mapped to your Enterprise Service Manager account.
        When completed, you will be returned to this page.
    </div>
</div>

<div style="display: none;">
    <form name="getGatewayTrustServletInputsForm" wicket:id="getGatewayTrustServletInputsForm" method="POST">
    </form>
</div>

<div id="mapAccessAccountDialog">
    <div class="hd">Map Access Account</div>
    <div class="bd" style="width: 40em;">
        <form id="mapAccessAccountForm" method="POST">
            <input id="mapAccessAccountForm_emstoken" type="hidden" name="token" />
            <input id="mapAccessAccountForm_returnurl" type="hidden" name="returnurl" />
        </form>
        To enable access to the SSG Cluster
        &ldquo;<span id="mapAccessAccountDialog_ssgClusterName"></span>&rdquo;,
        you will now be redirected to the cluster server where
        you can map a gateway user account to your Enterprise Service Manager account.
        When completed, you will be returned to this page.
    </div>
</div>

<div id="changeAccessAccountDialog">
    <div class="hd">Change Access Account</div>
    <div class="bd" style="width: 40em;">
        <form id="changeAccessAccountForm" method="POST">
            <input id="changeAccessAccountForm_emstoken" type="hidden" name="token" />
            <input id="changeAccessAccountForm_returnurl" type="hidden" name="returnurl" />
        </form>
        Your Enterprise Service Manager account is currently mapped to a user account
        on the SSG Cluster
        &ldquo;<span id="changeAccessAccountDialog_ssgClusterName"></span>&rdquo;.
        To change that,  you will now be redirected to the cluster server where
        you can map a different gateway user account.
        When completed, you will be returned to this page.
    </div>
</div>

<div id="editSSGClusterDialog">
    <div class="hd">Edit SSG Cluster</div>
    <div class="bd">
        <form name="editSSGClusterForm" wicket:id="editSSGClusterForm" method="POST">
            <input id="editSSGClusterDialog_id" wicket:id="editSSGClusterDialog_id" type="hidden" name="id" />
            <table class="spaced">
                <tr>
                    <th>New Name:</th>
                    <td><input type="text" id="editSSGClusterDialog_name" wicket:id="editSSGClusterDialog_name" name="name" size="40" maxlength="128" onkeyup="validateEditSSGClusterDialog();" /><span id="editSSGClusterDialog_name_hint" class="red"></span></td>
                </tr>
                <tr>
                    <th>New Host Name:</th>
                    <td><input type="text" id="editSSGClusterDialog_sslHostname" wicket:id="editSSGClusterDialog_sslHostname" name="hostName" size="40" maxlength="128" onkeyup="validateEditSSGClusterDialog();" /></td>
                </tr>
                <tr>
                    <th>New Administrative Port Number:</th>
                    <td><input type="text" id="editSSGClusterDialog_adminPort" wicket:id="editSSGClusterDialog_adminPort" name="port" size="10" onkeyup="validateEditSSGClusterDialog();" /><span id="editSSGClusterDialog_port_hint" class="red"></span></td>
                </tr>
            </table>
        </form>
    </div>
</div>

<div id="deleteSSGClusterDialog">
    <div class="hd">Delete SSG Cluster</div>
    <div class="bd">
        <form name="deleteSSGClusterForm" wicket:id="deleteSSGClusterForm" method="POST">
            <input id="deleteSSGClusterDialog_id" wicket:id="deleteSSGClusterDialog_id" type="hidden" name="id" />
            Delete SSG Cluster &ldquo;<span id="deleteSSGClusterDialog_name"></span>&rdquo; from the enterprise tree?
            <br/>This will not destroy the SSG Cluster itself.
        </form>
    </div>
</div>

<div id="reconfirmSSGClusterDeletionDialog">
    <div class="hd">Reconfirm SSG Cluster Deletion</div>
    <div class="bd">
        <form name="reconfirmSSGClusterDeletionForm" wicket:id="reconfirmSSGClusterDeletionForm" method="POST">
            <input id="reconfirmSSGClusterDeletionDialog_id" wicket:id="reconfirmSSGClusterDeletionDialog_id" type="hidden" name="id" />
            The SSG Cluster &ldquo;<span id="reconfirmSSGClusterDeletionDialog_name"></span>&rdquo; has related data such as generated reports
            <br/>and migration history. Deleting the cluster will also delete them.
            <p style="margin-top: 1em;">Proceed?</p>
        </form>
    </div>
</div>

<div style="display: none;">
    <div class="bd">
        <form name="startSsgNodeForm" wicket:id="startSsgNodeForm" method="POST">
            <input id="startSsgNode_id" wicket:id="startSsgNode_id" type="hidden" name="id" />
        </form>
    </div>
</div>

<div style="display: none;">
    <div class="bd">
        <form name="stopSsgNodeForm" wicket:id="stopSsgNodeForm" method="POST">
            <input id="stopSsgNode_id" wicket:id="stopSsgNode_id" type="hidden" name="id" />
        </form>
    </div>
</div>
                </wicket:extend>
            </div>
            <div class="statusBar">
                <table>
                    <tr>
                        <td width="100%">Time Zone: Canada/Pacific (GMT-08:00/<b>-07:00</b>)</td>
                        <td><a class="nowrap" href="http://www.layer7tech.com" target="_blank">Layer 7 Technologies Inc.</a></td>
                    </tr>
                </table>
            </div>
            <div class="divider"><img src="../images/spacer.png" alt="" /></div>
        </td>
    </tr>
</table>
</body>
</html>
