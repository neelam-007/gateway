<?xml version="1.0" encoding="UTF-8"?>
<!-- Ant build file for all modules. -->
<project name="updateinstaller" default="package.sign">

    <property name="build.dir" value="build"/>
    <property name="checksum.dir" value="${build.dir}/checksums"/>
    <property name="bin.dir" value="bin"/>
    <property name="data.dir" value="data"/>
    <property name="stages.dir" value="${bin.dir}/stages"/>
    <property name="stage0.dir" value="${stages.dir}/stage0"/>
    <property name="check.dir" value="${stages.dir}/check"/>
    <property name="readme.file" value="README.TXT"/>
    <property name="description.file" value="description.txt"/>
    <property name="updatefiles.list" value="${checksum.dir}/updatefiles.txt"/>
    <property name="jar.name" value="UpdateInstaller.jar"/>
    <property name="manifest.name" value="UpdateInstaller.mf"/>
    <property name="updatepackage.name" value="SSGUpdatePackage"/>

    <target name="package.sign" depends="package">
        <echo message="Signing the Package Installer Jar"/>
    </target>

    <target name="checkPrepare">
        <condition property="installer.prepared">
            <and>
                <available file="${bin.dir}"/>
                <available file="${data.dir}"/>
            </and>
        </condition>
    </target>

    <target name="package" depends="checkPrepare">
        <fail unless="installer.prepared">The update project needs to be prepared first. Please run prepare task</fail>
        <fail unless="installer.version.string"
              message="Set the version information property (-Dinstaller.version.string=xxx) property before running!"/>

        <echo message="building the source and jar"/>

        <mkdir dir="${build.dir}"/>
        <javac srcdir="." destdir="${build.dir}" />

        <mkdir dir="${checksum.dir}"/>
        <checksum todir="${checksum.dir}">
            <fileset dir="${bin.dir}" includes="**/*"/>
            <fileset dir="${data.dir}" includes="**/*"/>
        </checksum>

        <jar basedir="${build.dir}" destfile="${jar.name}" manifest="${manifest.name}"/>

        <zip destfile="${updatepackage.name}-${installer.version.string}.sup">
            <fileset dir=".">
                <include name="${bin.dir}/**/*"/>
                <include name="${data.dir}/**/*"/>
                <include name="${jar.name}"/>
                <include name="${description.file}"/>
                <include name="${readme.file}"/>
            </fileset>
        </zip>

    </target>

    <target name="prepare" depends="checkPrepare" unless="installer.prepared">
        <echo message="Creating the update project structure."/>
        <mkdir dir="${check.dir}" />
        <mkdir dir="${stage0.dir}" />
        <mkdir dir="${data.dir}"/>
        <echo file="${readme.file}" message="Place excutables that perform the installation tasks in bin/stages/stageX where X indicates the order in which stages are to be performed"/>
        <echo file="${description.file}" message="Enter a description of the update here"/>
        <echo message="*** Preparation complete. PLEASE READ THE README.TXT FILE ***"/>
    </target>

    <target name="clean">
        <delete dir="${build.dir}"/>
        <delete file="${updatefiles.list}"/>
    </target>

</project>