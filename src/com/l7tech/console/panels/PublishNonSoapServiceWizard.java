package com.l7tech.console.panels;

import com.l7tech.common.util.ExceptionUtils;
import com.l7tech.console.action.Actions;
import com.l7tech.console.event.EntityEvent;
import com.l7tech.console.event.EntityListener;
import com.l7tech.console.util.Registry;
import com.l7tech.objectmodel.DuplicateObjectException;
import com.l7tech.objectmodel.EntityHeader;
import com.l7tech.objectmodel.EntityType;
import com.l7tech.policy.assertion.HttpRoutingAssertion;
import com.l7tech.policy.assertion.composite.AllAssertion;
import com.l7tech.policy.wsp.WspWriter;
import com.l7tech.service.PublishedService;

import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.ByteArrayOutputStream;
import java.util.ArrayList;
import java.util.EventListener;
import java.util.Set;
import java.util.HashSet;

/**
 * Wizard that guides the administrator through the publication of a non-soap service.
 * <p/>
 * <br/><br/>
 * LAYER 7 TECHNOLOGIES, INC<br/>
 * User: flascell<br/>
 * Date: Sep 14, 2004<br/>
 * $Id$<br/>
 */
public class PublishNonSoapServiceWizard extends Wizard {
    public static PublishNonSoapServiceWizard getInstance(Frame parent) {
        IdentityProviderWizardPanel panel2 = new IdentityProviderWizardPanel(false);
        NonSoapServicePanel panel1 = new NonSoapServicePanel(panel2);
        PublishNonSoapServiceWizard output = new PublishNonSoapServiceWizard(parent, panel1);
        output.panel2 = panel2;
        output.panel1 = panel1;
        return output;
    }

    public PublishNonSoapServiceWizard(Frame parent, WizardStepPanel panel) {
        super(parent, panel);
        setTitle("Publish XML Application Wizard");

        getButtonHelp().addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                Actions.invokeHelp(PublishNonSoapServiceWizard.this);
            }
        });

    }

    protected void finish(ActionEvent evt) {
        PublishedService service = new PublishedService();
        ArrayList allAssertions = new ArrayList();
        try {
            // get the assertions from the all assertion
            panel2.readSettings(allAssertions);
            AllAssertion policy = new AllAssertion(allAssertions);
            if (panel1.getDownstreamURL() != null)
                policy.addChild(new HttpRoutingAssertion(panel1.getDownstreamURL()));
            ByteArrayOutputStream bo = new ByteArrayOutputStream();
            WspWriter.writePolicy(policy, bo);
            service.setPolicyXml(bo.toString());
            service.setSoap(false);
            service.setHttpMethods(ANYVERBSET);// xml application are not like soap. by default, not just post is allowed
            service.setName(panel1.getPublishedServiceName());
            service.setRoutingUri(panel1.getRoutingURI());

            long oid = Registry.getDefault().getServiceManager().savePublishedService(service);
            Registry.getDefault().getSecurityProvider().refreshPermissionCache();

            EntityHeader header = new EntityHeader();
            header.setType(EntityType.SERVICE);
            header.setName(service.getName());
            header.setOid(oid);
            PublishNonSoapServiceWizard.this.notify(header);
        } catch (Exception e) {
            if (ExceptionUtils.causedBy(e, DuplicateObjectException.class)) {
                JOptionPane.showMessageDialog(this,
                  "Unable to save the service '" + service.getName() + "'\n" +
                  "because an existing service is already using the URI " + service.getRoutingUri(),
                  "Service already exists",
                  JOptionPane.ERROR_MESSAGE);
            } else {
                e.printStackTrace();
                JOptionPane.showMessageDialog(this,
                  "Unable to save the service '" + service.getName() + "'\n",
                  "Error",
                  JOptionPane.ERROR_MESSAGE);
            }
            return;
        }
        super.finish(evt);
    }

    private void notify(EntityHeader header) {
        EntityEvent event = new EntityEvent(this, header);
        EventListener[] listeners = listenerList.getListeners(EntityListener.class);
        for (int i = 0; i < listeners.length; i++) {
            ((EntityListener)listeners[i]).entityAdded(event);
        }
    }

    /**
     * add the EntityListener
     *
     * @param listener the EntityListener
     */
    public void addEntityListener(EntityListener listener) {
        listenerList.add(EntityListener.class, listener);
    }

    /**
     * remove the the EntityListener
     *
     * @param listener the EntityListener
     */
    public void removeEntityListener(EntityListener listener) {
        listenerList.remove(EntityListener.class, listener);
    }

    private IdentityProviderWizardPanel panel2;
    private NonSoapServicePanel panel1;
    private static final Set<String> ANYVERBSET = new HashSet<String>();
    {
        ANYVERBSET.add("POST");
        ANYVERBSET.add("GET");
        ANYVERBSET.add("PUT");
        ANYVERBSET.add("DELETE");
    }
}
