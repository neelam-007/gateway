# /etc/sysconfig/iptables
# Use iptables-singlenet for single address configurations
#
*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

# Optionally redirect the standard ports up to our ports
#[0:0] -A PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080 
#[0:0] -A PREROUTING -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 8443 

COMMIT

*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:badflags - [0:0]
:portdrop - [0:0]

# fast forward established connections, no need to have them traverse the rules
[0:0] -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

# allow all input on localhost 
[0:0] -A INPUT -i lo -m state --state NEW -j ACCEPT

# Block bad tcp flags
[0:0] -A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,PSH,URG -j badflags
[0:0] -A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,PSH,ACK,URG -j badflags 
[0:0] -A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,ACK,URG -j badflags 
[0:0] -A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j badflags 
[0:0] -A INPUT -p tcp -m tcp --tcp-flags SYN,RST SYN,RST -j badflags 
[0:0] -A INPUT -p tcp -m tcp --tcp-flags FIN,SYN FIN,SYN -j badflags 

# allow good icmp
[0:0] -A INPUT -p icmp -m icmp --icmp-type 0 -j ACCEPT
[0:0] -A INPUT -p icmp -m icmp --icmp-type 3 -j ACCEPT 
[0:0] -A INPUT -p icmp -m icmp --icmp-type 11 -j ACCEPT 

# rate limit ping
[0:0] -A INPUT -p icmp -m icmp --icmp-type 8 -m limit --limit 2/sec -j ACCEPT

# drop the rest
[0:0] -A INPUT -p icmp -j portdrop

# And drop anything we might try and inadvertently send back, too
[0:0] -A OUTPUT -p icmp -m state --state INVALID -j DROP

# DNS, NTP
[0:0] -A INPUT -p udp -m udp --dport 53 -j ACCEPT
[0:0] -A INPUT -p udp -m udp --dport 123 -j ACCEPT


# Remote Assertion Server (uses loopback)
[0:0] -A INPUT -i ! lo -p tcp -m tcp --dport 7001 -j portdrop
[0:0] -A INPUT -i ! lo -p tcp -m tcp --dport 7100 -j portdrop

# Allow in the cluster protocol, only for multicast destinations

[0:0] -A INPUT -d ! 224.0.0.0/8 -p udp -m udp --dport 8777 -j ACCEPT

# Allow in the other two ports, for all destinations and sources

# FIXME: Ephemeral port range for Multicast

[0:0] -A INPUT -p udp -m udp --dport 7001:7100 -j ACCEPT
# [0:0] -A INPUT -p udp -m udp --dport 32784 -j ACCEPT

# open on eth0 even if SSG's are  not up

[0:0] -A INPUT -i eth0 -p tcp -m tcp --dport 3306 -j ACCEPT
[0:0] -A INPUT -i eth0 -p tcp -m tcp --dport 22 -j ACCEPT

# Partitions:
# allow in only the known partitions and IPS
# Tricky: Using I (insert) to put the rules in above the drop
# FIXME: if you add new rules above, you MUST change the insert point

# drop all other TCP and UDP
# THESE RULES MUST BE LAST! 

[0:0] -A INPUT -p tcp -m tcp --dport 1:65535 -j portdrop
[0:0] -A INPUT -p udp -m udp --dport 1:65535 -j portdrop

# Portdrop rule: 
# Drop TCP with a tcp reset (as in "I'm not listening on this port)
[0:0] -A portdrop -p tcp -m tcp -j REJECT --reject-with tcp-reset
# any thing else just gets discarded
# That means udp, icmp etc.
[0:0] -A portdrop -j DROP

# Badflags rule
# Limit logging to 15 per minute, so we don't DOS the logfiles
# Anything that gets logged with badflags is LIKELY a port scan or attack attempt.
[0:0] -A badflags -m limit --limit 15/min -j LOG --log-prefix "Badflags:" 
[0:0] -A badflags -j DROP 
COMMIT
