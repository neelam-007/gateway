<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd">
    <changeSet author="gateway" id="update_ssg_version">
        <update tableName="ssg_version">
            <column name="current_version" value="8.4.00"/>
        </update>
        <rollback>
            <update tableName="ssg_version">
                <column name="current_version" value="8.3.00"/>
            </update>
        </rollback>
    </changeSet>
    <changeSet author="gateway" id="create_published_service_properties">
        <createTable tableName="published_service_property">
            <column name="published_service_goid" type="${goid.type}">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="${mediumtext.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="gateway" id="add_version_column_to_sample_messages_table">
        <addColumn tableName="sample_messages">
            <column name="version" type="INT(10)" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <dropDefaultValue tableName="sample_messages" columnName="version" />
    </changeSet>
    <changeSet id="add_work_queue_table" author="gateway">
        <createTable tableName="work_queue">
            <column name="goid" type="${goid.type}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="max_queue_size" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="thread_pool_max" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="reject_policy" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="security_zone_goid" type="${goid.type}"/>
        </createTable>
    </changeSet>
	<changeSet id="create-index-work-queue-name" author="gateway">
        <createIndex indexName="index_work_queue_name" tableName="work_queue" unique="true">
            <column name="name"/>
        </createIndex>
    </changeSet>
    <changeSet id="add-fk-work-queue-security-zone" author="gateway">
        <addForeignKeyConstraint baseTableName="work_queue" baseColumnNames="security_zone_goid"
                                 constraintName="work_queue_security_zone" referencedTableName="security_zone"
                                 referencedColumnNames="goid" onDelete="SET NULL" onUpdate="NO ACTION"/>
    </changeSet>
	<changeSet id="create-manage-work-queue-role" author="gateway">
        <comment>Manage Work Queue</comment>
        <insert tableName="rbac_role">
            <column name="goid" valueComputed="toGoid(0, -1700)"/>
            <column name="version" valueNumeric="0"/>
            <column name="name" value="Manage Work Queue"/>
            <column name="tag"/>
            <column name="entity_type" value="WORK_QUEUE"/>
            <column name="entity_goid"/>
            <column name="description" value="Users assigned to the {0} role have the ability to read, create, update and delete work queues."/>
            <column name="user_created" valueBoolean="false"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1701)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1700)"/>
            <column name="operation_type" value="READ"/>
            <column name="other_operation"/>
            <column name="entity_type" value="WORK_QUEUE"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1702)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1700)"/>
            <column name="operation_type" value="CREATE"/>
            <column name="other_operation"/>
            <column name="entity_type" value="WORK_QUEUE"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1703)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1700)"/>
            <column name="operation_type" value="UPDATE"/>
            <column name="other_operation"/>
            <column name="entity_type" value="WORK_QUEUE"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1704)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1700)"/>
            <column name="operation_type" value="DELETE"/>
            <column name="other_operation"/>
            <column name="entity_type" value="WORK_QUEUE"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1705)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1700)"/>
            <column name="operation_type" value="READ"/>
            <column name="other_operation"/>
            <column name="entity_type" value="SECURE_PASSWORD"/>
        </insert>
    </changeSet>
    <changeSet id="add_scheduled_task_table" author="gateway">
        <createTable tableName="scheduled_task">
            <column name="goid" type="${goid.type}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="policy_goid" type="${goid.type}">
                <constraints nullable="false"/>
            </column>
            <column name="use_one_node" type="${tinyint.type}" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="job_type" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="job_status" type="VARCHAR(128)"/>
            <column name="execution_date" type="BIGINT(19)"/>
            <column name="executed_date" type="BIGINT(19)"/>
            <column name="cron_expression" type="VARCHAR(255)"/>
            <column name="${properties.column.name}" type="${mediumtext.type}"/>
            <column name="security_zone_goid" type="${goid.type}"/>
        </createTable>
    </changeSet>
    <changeSet id="create-index-scheduled_task-name" author="gateway">
        <createIndex indexName="index_scheduled_task_name" tableName="scheduled_task" unique="true">
            <column name="name"/>
        </createIndex>
    </changeSet>
    <changeSet id="add-fk-scheduled_task-security-zone" author="gateway">
        <addForeignKeyConstraint baseTableName="scheduled_task" baseColumnNames="security_zone_goid"
                                 constraintName="scheduled_task_security_zone" referencedTableName="security_zone"
                                 referencedColumnNames="goid" onDelete="SET NULL" onUpdate="NO ACTION"/>
    </changeSet>
    <changeSet id="add-fk-scheduled_task-policy" author="gateway">
        <addForeignKeyConstraint baseTableName="scheduled_task" baseColumnNames="policy_goid"
                                 constraintName="scheduled_task_policy" referencedTableName="policy"
                                 referencedColumnNames="goid" onDelete="NO ACTION" onUpdate="NO ACTION"/>
    </changeSet>
    <changeSet id="create-scheduled_task-role" author="gateway">
        <comment>Manage Scheduled Task</comment>
        <insert tableName="rbac_role">
            <column name="goid" valueComputed="toGoid(0, -1750)"/>
            <column name="version" valueNumeric="0"/>
            <column name="name" value="Manage Scheduled Task"/>
            <column name="tag"/>
            <column name="entity_type" value="SCHEDULED_TASK"/>
            <column name="entity_goid"/>
            <column name="description" value="Users assigned to the {0} role have the ability to read, create, update and delete Scheduled Task."/>
            <column name="user_created" valueBoolean="false"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1751)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1750)"/>
            <column name="operation_type" value="READ"/>
            <column name="other_operation"/>
            <column name="entity_type" value="SCHEDULED_TASK"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1752)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1750)"/>
            <column name="operation_type" value="CREATE"/>
            <column name="other_operation"/>
            <column name="entity_type" value="SCHEDULED_TASK"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1753)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1750)"/>
            <column name="operation_type" value="UPDATE"/>
            <column name="other_operation"/>
            <column name="entity_type" value="SCHEDULED_TASK"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1754)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1750)"/>
            <column name="operation_type" value="DELETE"/>
            <column name="other_operation"/>
            <column name="entity_type" value="SCHEDULED_TASK"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1755)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1750)"/>
            <column name="operation_type" value="READ"/>
            <column name="other_operation"/>
            <column name="entity_type" value="SECURE_PASSWORD"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1756)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1750)"/>
            <column name="operation_type" value="READ"/>
            <column name="other_operation"/>
            <column name="entity_type" value="POLICY"/>
        </insert>
        <insert tableName="rbac_predicate">
            <column name="goid" valueComputed="toGoid(0, -1757)"/>
            <column name="version" valueNumeric="0"/>
            <column name="permission_goid" valueComputed="toGoid(0, -1756)"/>
        </insert>
        <insert tableName="rbac_predicate_attribute">
            <column name="goid" valueComputed="toGoid(0, -1757)"/>
            <column name="attribute" value="type"/>
            <column name="value" value="Policy-Backed Service Operation Policy Fragment"/>
            <column name="mode" value="eq"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1757)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1750)"/>
            <column name="operation_type" value="READ"/>
            <column name="other_operation"/>
            <column name="entity_type" value="ASSERTION_ACCESS"/>
        </insert>
    </changeSet>
</databaseChangeLog>
