<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd">
    <changeSet author="vkazakov" id="update_ssg_version">
        <update tableName="ssg_version">
            <column name="current_version" value="8.3.00"/>
        </update>
        <rollback>
            <update tableName="ssg_version">
                <column name="current_version" value="8.3.pre"/>
            </update>
        </rollback>
    </changeSet>
    <changeSet id="remove_next_hi_function" author="vkazakov">
        <sql dbms="mysql">DROP FUNCTION next_hi</sql>
        <rollback>
            <createProcedure dbms="mysql"
                             procedureName="next_hi">
                CREATE FUNCTION next_hi() RETURNS bigint NOT DETERMINISTIC MODIFIES SQL DATA SQL SECURITY INVOKER
                BEGIN
                UPDATE hibernate_unique_key SET next_hi=last_insert_id(next_hi)+IF(@@global.server_id=0,1,2);
                RETURN IF((last_insert_id()%2=0 and @@global.server_id=1) or (last_insert_id()%2=1 and @@global.server_id=2),last_insert_id()+1,last_insert_id());
                END
            </createProcedure>
        </rollback>
    </changeSet>
    <changeSet id="remove_hibernate_unique_key_table" author="vkazakov" dbms="mysql">
        <dropTable tableName="hibernate_unique_key"/>
        <rollback>
            <createTable tableName="hibernate_unique_key">
                <column name="next_hi" type="INT(11)">
                    <constraints nullable="true"/>
                </column>
            </createTable>
            <insert tableName="hibernate_unique_key">
                <column name="next_hi" valueNumeric="1"/>
            </insert>
        </rollback>
    </changeSet>
    <changeSet id="update_manage_siteminder_configuration_role" author="ymoiseyenko">
        <comment>Update SiteMinder Configuration</comment>
        <update tableName="rbac_role">
            <column name="name" value="Manage CA Single Sign-On Configuration"/>
            <column name="description" value="Users assigned to the {0} role have the ability to read, create, update and delete CA Single Sign-On configuration."/>
            <where>entity_type = 'SITEMINDER_CONFIGURATION'</where>
        </update>
        <rollback>
            <update tableName="rbac_role">
                <column name="name" value="Manage SiteMinder Configuration"/>
                <column name="description" value="Users assigned to the {0} role have the ability to read, create, update and delete SiteMinder configuration."/>
                <where>entity_type = 'SITEMINDER_CONFIGURATION'</where>
            </update>
        </rollback>
    </changeSet>
    <changeSet id="add_cassandra_connection_table" author="acheuk">
        <createTable tableName="cassandra_connection">
            <column name="goid" type="${goid.type}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="keyspace_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="contact_points" type="VARCHAR(4096)">
                <constraints nullable="false"/>
            </column>
            <column name="port" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="username" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="password_goid" type="${goid.type}"/>
            <column name="compression" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="use_ssl" type="${tinyint.type}" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
			<column name="enabled" type="${tinyint.type}" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
            <column name="${properties.column.name}" type="${mediumtext.type}"/>
            <column name="security_zone_goid" type="${goid.type}"/>
        </createTable>
    </changeSet>
	<changeSet id="create-manage-cassandra-connection-role" author="acheuk">
        <comment>Manage Cassandra Configuration</comment>
        <insert tableName="rbac_role">
            <column name="goid" valueComputed="toGoid(0, -1600)"/>
            <column name="version" valueNumeric="0"/>
            <column name="name" value="Manage Cassandra Connection"/>
            <column name="tag"/>
            <column name="entity_type" value="CASSANDRA_CONFIGURATION"/>
            <column name="entity_goid"/>
            <column name="description" value="Users assigned to the {0} role have the ability to read, create, update and delete Cassandra connection."/>
            <column name="user_created" valueBoolean="false"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1601)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1600)"/>
            <column name="operation_type" value="READ"/>
            <column name="other_operation"/>
            <column name="entity_type" value="CASSANDRA_CONFIGURATION"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1602)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1600)"/>
            <column name="operation_type" value="CREATE"/>
            <column name="other_operation"/>
            <column name="entity_type" value="CASSANDRA_CONFIGURATION"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1603)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1600)"/>
            <column name="operation_type" value="UPDATE"/>
            <column name="other_operation"/>
            <column name="entity_type" value="CASSANDRA_CONFIGURATION"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1604)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1600)"/>
            <column name="operation_type" value="DELETE"/>
            <column name="other_operation"/>
            <column name="entity_type" value="CASSANDRA_CONFIGURATION"/>
        </insert>
        <insert tableName="rbac_permission">
            <column name="goid" valueComputed="toGoid(0, -1605)"/>
            <column name="version" valueNumeric="0"/>
            <column name="role_goid" valueComputed="toGoid(0, -1600)"/>
            <column name="operation_type" value="READ"/>
            <column name="other_operation"/>
            <column name="entity_type" value="SECURE_PASSWORD"/>
        </insert>
    </changeSet>
</databaseChangeLog>
