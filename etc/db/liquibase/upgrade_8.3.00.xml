<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd">
    <changeSet author="vkazakov" id="update_ssg_version">
        <update tableName="ssg_version">
            <column name="current_version" value="8.3.00"/>
        </update>
        <rollback>
            <update tableName="ssg_version">
                <column name="current_version" value="8.3.pre"/>
            </update>
        </rollback>
    </changeSet>
    <changeSet id="remove_next_hi_function" author="vkazakov">
        <sql dbms="mysql">DROP FUNCTION next_hi</sql>
        <rollback>
            <createProcedure dbms="mysql"
                             procedureName="next_hi">
                CREATE FUNCTION next_hi() RETURNS bigint NOT DETERMINISTIC MODIFIES SQL DATA SQL SECURITY INVOKER
                BEGIN
                UPDATE hibernate_unique_key SET next_hi=last_insert_id(next_hi)+IF(@@global.server_id=0,1,2);
                RETURN IF((last_insert_id()%2=0 and @@global.server_id=1) or (last_insert_id()%2=1 and @@global.server_id=2),last_insert_id()+1,last_insert_id());
                END
            </createProcedure>
        </rollback>
    </changeSet>
    <changeSet id="remove_hibernate_unique_key_table" author="vkazakov" dbms="mysql">
        <dropTable tableName="hibernate_unique_key"/>
        <rollback>
            <createTable tableName="hibernate_unique_key">
                <column name="next_hi" type="INT(11)">
                    <constraints nullable="true"/>
                </column>
            </createTable>
            <insert tableName="hibernate_unique_key">
                <column name="next_hi" valueNumeric="1"/>
            </insert>
        </rollback>
    </changeSet>
    <changeSet id="update_manage_siteminder_configuration_role" author="ymoiseyenko">
        <comment>Update SiteMinder Configuration</comment>
        <update tableName="rbac_role">
            <column name="name" value="Manage CA Single Sign-On Configuration"/>
            <column name="description" value="Users assigned to the {0} role have the ability to read, create, update and delete CA Single Sign-On configuration."/>
            <where>entity_type = 'SITEMINDER_CONFIGURATION'</where>
        </update>
        <rollback>
            <update tableName="rbac_role">
                <column name="name" value="Manage SiteMinder Configuration"/>
                <column name="description" value="Users assigned to the {0} role have the ability to read, create, update and delete SiteMinder configuration."/>
                <where>entity_type = 'SITEMINDER_CONFIGURATION'</where>
            </update>
        </rollback>
    </changeSet>
    <changeSet id="introduce_policy_backed_services" author="mlyons">
        <comment>Adds subtags to the policy table, and introduces the policy_backed_service and policy_backed_service_operation tables</comment>
        <addColumn tableName="policy">
            <column name="internal_sub_tag" type="VARCHAR(255)"/>
        </addColumn>
        <modifyDataType tableName="policy" columnName="internal_tag" newDataType="VARCHAR(255)"/>
        <createTable tableName="policy_backed_service">
            <column name="goid" type="${goid.type}">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="version" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="interface_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="security_zone_goid" type="${goid.type}"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="security_zone_goid" baseTableName="policy_backed_service" constraintName="policy_backed_service_security_zone" deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="goid" referencedTableName="security_zone"/>
        <createTable tableName="policy_backed_service_operation">
            <column name="goid" type="${goid.type}">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="version" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="policy_backed_service_goid" type="${goid.type}">
                <constraints nullable="false" references="policy_backed_service(goid)" foreignKeyName="fk_pbs_operation_pbs_service"/>
            </column>
            <column name="policy_goid" type="${goid.type}">
                <constraints references="policy(goid)" foreignKeyName="fk_pbs_operation_policy" deleteCascade="true"/>
            </column>
        </createTable>
        <addUniqueConstraint tableName="policy_backed_service_operation" columnNames="policy_backed_service_goid, name" constraintName="i_pbs_operation_goid_name"/>
        <rollback>
            <modifyDataType tableName="policy" columnName="internal_tag" newDataType="VARCHAR(64)"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
