<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC  "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
    <!--
    The Application Context contains the definitions that describe the SSG server side components.
    Things such as identitiy managers, trust components, policy services token services etc. are defined
    here.
    Admin Services are defined in adminContext.xml.
    Data Access (Hibernate, Transactions) is defined in dataAccessContext.xml.
 -->


<beans>

    <!-- SSG boot process -->
    <bean id="ssgBoot" class="com.l7tech.server.BootProcess" depends-on="systemAuditListener">
        <property name="serverConfig">
            <ref local="serverConfig"/>
        </property>
    </bean>
<!--
    * singleton using the factory method. This is transitional, as it is referencef from
    * too many places.
    -->
    <bean id="serverConfig" class="com.l7tech.server.ServerConfig" factory-method="getInstance"/>
    <!-- server side identity provider factory -->
    <bean id="identityProviderFactory" class="com.l7tech.server.identity.IdentityProviderFactory"></bean>
    <!-- server side identity configuration manager -->
    <bean id="identityProviderConfigManager" class="com.l7tech.server.identity.IdProvConfManagerServer">
        <property name="identityProviderFactory">
            <ref bean='identityProviderFactory'/>
        </property>
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>

    <!--
      Event multicaster for supporting non-container managed event listeners.
    -->
    <bean id="applicationEventMulticaster" class="com.l7tech.spring.util.SafeApplicationEventMulticaster"/>

    <!--
        Internal Identity Provider

        The factory method with support with construction arguments. The bean must be instantiated
        programatically with the required runtime construction arguments (IdentityProviderConfig)
        See IdentityProviderFactory implementation.
    -->
    <bean id="internalIdentityProvider" factory-bean="identityProviderFactory" factory-method="createProviderInstance"
          class="com.l7tech.server.identity.internal.InternalIdentityProvider" singleton="false">
        <property name="clientCertManager">
            <ref bean="clientCertManager"/>
        </property>
        <property name="keystore">
            <ref local='keystore'/>
        </property>

        <property name="certificateAuthenticator">
            <ref bean="certificateAuthenticator"/>
        </property>
    </bean>
    <!-- Internal UserManager -->
    <bean id="internalUserManager" factory-bean="identityProviderFactory" factory-method="createManagerInstance"
          class="com.l7tech.server.identity.internal.InternalUserManager" singleton="false">
        <property name="clientCertManager">
            <ref local="clientCertManager"/>
        </property>
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>
    <!-- Internal GroupManager -->
    <bean id="internalGroupManager" factory-bean="identityProviderFactory" factory-method="createManagerInstance"
          class="com.l7tech.server.identity.internal.InternalGroupManager" singleton="false">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>
    <!-- Federated Identity Provider -->
    <bean id="federatedIdentityProvider" factory-bean="identityProviderFactory" factory-method="createProviderInstance"
          class="com.l7tech.server.identity.fed.FederatedIdentityProvider" singleton="false">
        <property name="clientCertManager">
            <ref local="clientCertManager"/>
        </property>
        <property name="trustedCertManager">
            <ref bean="trustedCertManager"/>
        </property>
        <property name="keystore">
            <ref local='keystore'/>
        </property>
    </bean>

    <bean id="federatedUserManager" factory-bean="identityProviderFactory" factory-method="createManagerInstance"
          class="com.l7tech.server.identity.fed.FederatedUserManager" singleton="false">
        <property name="clientCertManager">
            <ref bean="clientCertManager"/>
        </property>
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>

    <bean id="federatedGroupManager" factory-bean="identityProviderFactory" factory-method="createManagerInstance"
          class="com.l7tech.server.identity.fed.FederatedGroupManager" singleton="false">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>
    <!-- LDAP Identity Provider -->
    <bean id="ldapIdentityProvider" factory-bean="identityProviderFactory" factory-method="createProviderInstance"
          class="com.l7tech.server.identity.ldap.LdapIdentityProvider" singleton="false">
        <property name="clientCertManager">
            <ref local="clientCertManager"/>
        </property>
        <property name="serverConfig">
            <ref local="serverConfig"/>
        </property>
        <property name="certificateAuthenticator">
            <ref local="certificateAuthenticator"/>
        </property>
    </bean>

    <!-- LDAP UserManager -->
    <bean id="ldapUserManager" factory-bean="identityProviderFactory" factory-method="createManagerInstance"
          class="com.l7tech.server.identity.ldap.LdapUserManager" singleton="false"></bean>
    <!-- LDAP GroupManager -->
    <bean id="ldapGroupManager" factory-bean="identityProviderFactory" factory-method="createManagerInstance"
          class="com.l7tech.server.identity.ldap.LdapGroupManager" singleton="false"></bean>
    <!-- server side Cluster Info manager -->
    <bean id="clusterInfoManager" class="com.l7tech.cluster.ClusterInfoManager">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
        <property name="keystore">
            <ref local='keystore'/>
        </property>
    </bean>
    <!-- server side Service Usage  manager -->
    <bean id="serviceUsageManager" class="com.l7tech.cluster.ServiceUsageManager">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>
    <!-- server side DistributedMessageIdManager -->
    <bean id="distributedMessageIdManager" class="com.l7tech.cluster.DistributedMessageIdManager">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>

    <bean id="counterManager" class="com.l7tech.server.sla.DBCounterManager">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>

    <!-- server side policy factory -->
    <bean id="policyFactory" class="com.l7tech.server.policy.ServerPolicyFactory"></bean>
    <!-- server side service manager -->
    <bean id="serviceCache" class="com.l7tech.server.service.ServiceCache">
        <constructor-arg>
            <ref bean="policyFactory"/>
        </constructor-arg>
    </bean>
    <!-- server side HTTP routing client trust manager -->
    <bean id="httpRoutingAssertionTrustManager" class="com.l7tech.server.transport.http.SslClientTrustManager">
        <property name="trustedCertManager">
            <ref bean="trustedCertManager"/>
        </property>
    </bean>
    <!-- server side service manager -->
    <bean id="serviceManagerTarget" class="com.l7tech.server.service.ServiceManagerImp">
        <property name="serviceCache">
            <ref bean='serviceCache'/>
        </property>
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
        <property name="resolutionManager">
            <ref bean="resolutionManager"/>
        </property>
        <property name="transactionManager">
            <ref bean="transactionManager"/>
        </property>
    </bean>
    <!-- server side resolution manager -->
    <bean id="resolutionManager" class="com.l7tech.server.service.resolution.ResolutionManager">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>
    <!-- server side trusted cert manager -->
    <bean id="trustedCertManager" class="com.l7tech.server.identity.cert.TrustedCertManagerImp">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
        <property name="transactionManager">
            <ref bean="transactionManager"/>
        </property>
    </bean>
    <!-- server side SampleMessage manager -->
    <bean id="sampleMessageManager" class="com.l7tech.server.service.SampleMessageManagerImp">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>
    <!-- server side custom assertions registrar -->
    <bean id="customAssertionRegistrar" class="com.l7tech.policy.assertion.ext.CustomAssertionsRegistrarImpl">
        <property name="serviceManager">
            <ref bean="serviceManager"/>
        </property>
    </bean>
    <!-- jms connection manager -->
    <bean id="jmsConnectionManager" class="com.l7tech.server.transport.jms.JmsConnectionManager">
        <property name="jmsEndpointManager">
            <ref bean="jmsEndpointManager"/>
        </property>
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>
    <!-- jms connection manager -->
    <bean id="jmsEndpointManager" class="com.l7tech.server.transport.jms.JmsEndpointManager">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>
    
    <!-- server side policy validator -->
    <bean id="policyValidator" class="com.l7tech.server.policy.validator.ServerPolicyValidator">
        <property name="jmsEndpointManager">
            <ref bean="jmsEndpointManager"/>
        </property>
        <property name="identityProviderFactory">
            <ref bean='identityProviderFactory'/>
        </property>
        <property name="communitySchemaManager">
            <ref bean='communitySchemaManager'/>
        </property>
    </bean>

    <!-- server side policy filter manager  -->
    <bean id="policyFilterManager" class="com.l7tech.server.policy.filter.FilterManager">
        <constructor-arg>
            <ref bean="identityProviderConfigManager"/>
        </constructor-arg>
        <constructor-arg>
            <list>
                <value>com.l7tech.server.policy.filter.IdentityRule</value>
                <value>com.l7tech.server.policy.filter.HideUnsupportedClientAssertions</value>
            </list>
        </constructor-arg>
    </bean>
    <!-- server side client cert manager -->
    <bean id="clientCertManager" class="com.l7tech.server.identity.cert.ClientCertManagerImp">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
        <property name="rootCertificate">
            <ref bean="rootCertificate"/>
        </property>
    </bean>

    <!-- server side log ring buffer -->
    <bean id="logRecordRingBuffer" class="com.l7tech.server.log.LogRecordRingBuffer" init-method="init">
        <property name="loggerName">
            <value>com.l7tech</value>
        </property>
        <property name="bufferSize">
            <value>500</value> <!-- NOTE that the max retrieval block size is 600, this should be less than that -->
        </property>
    </bean>

    <!-- server side log manager -->
    <bean id="logRecordManager" class="com.l7tech.server.audit.LogRecordManager">
        <constructor-arg>
            <ref local="clusterInfoManager"/>
        </constructor-arg>
        <constructor-arg>
            <ref local="logRecordRingBuffer"/>
        </constructor-arg>
    </bean>

    <!-- server side audit record manager -->
    <bean id="auditRecordManager" class="com.l7tech.server.audit.AuditRecordManagerImpl">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
        <property name="serverConfig">
            <ref bean="serverConfig"/>
        </property>
    </bean>
    <!-- server side audit exporter -->
    <bean id="auditExporter" class="com.l7tech.server.audit.AuditExporter" singleton="false">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>
    <!-- server side audit message factory -->
    <bean id="messageSummaryAuditFactory" class="com.l7tech.server.audit.MessageSummaryAuditFactory">
        <constructor-arg>
            <ref bean="clusterNodeId"/>
        </constructor-arg>
    </bean>

    <!-- keystore root cert and ssl config  -->
    <bean id="keystore" class="com.l7tech.common.util.KeystoreUtils">
        <constructor-arg>
            <ref bean="serverConfig"/>
        </constructor-arg>
    </bean>

    <bean id="sslKeystoreType" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject">
            <ref local='keystore'/>
        </property>
        <property name="targetMethod">
            <value>getKeyStoreType</value>
        </property>
    </bean>

    <bean id="sslKeystorePassword" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject">
            <ref local='keystore'/>
        </property>
        <property name="targetMethod">
            <value>getSslKeystorePasswd</value>
        </property>
    </bean>

    <bean id="sslKeystoreFile" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject">
            <ref local='keystore'/>
        </property>
        <property name="targetMethod">
            <value>getSslKeystorePath</value>
        </property>
    </bean>

    <bean id="sslKeystoreCertificate" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject">
            <ref local='keystore'/>
        </property>
        <property name="targetMethod">
            <value>getSslCert</value>
        </property>
    </bean>

    <bean id="sslKeystorePrivateKey" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject">
            <ref local='keystore'/>
        </property>
        <property name="targetMethod">
            <value>getSSLPrivateKey</value>
        </property>
    </bean>

    <bean id="sslKeyManagerFactory" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject">
            <ref local='keystore'/>
        </property>
        <property name="targetMethod">
            <value>getSSLKeyManagerFactory</value>
        </property>
    </bean>

    <bean id="rootCertificate" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject">
            <ref local='keystore'/>
        </property>
        <property name="targetMethod">
            <value>getRootCert</value>
        </property>
    </bean>

    <!--
    set the KeyManagers for use within a cluster
    -->
    <bean id="setKeyManagerFactoryForNodeToNodeRMI"
          class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="staticMethod">
            <value>com.l7tech.spring.remoting.rmi.ssl.SslRMIClientSocketFactory.setKeyManagerFactory</value>
        </property>
        <property name="arguments">
            <list>
                <ref local="sslKeyManagerFactory"/>
            </list>
        </property>
    </bean>


    <!-- server Wss Decorator -->
    <bean id="wssDecorator" class="com.l7tech.common.security.xml.decorator.WssDecoratorImpl"></bean>
    <!-- server Message Processor -->
    <bean id="messageProcessor" class="com.l7tech.server.MessageProcessor">
        <constructor-arg>
            <ref bean="serviceManager"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="wssDecorator"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="sslKeystorePrivateKey"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="sslKeystoreCertificate"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="securityTokenResolver"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="licenseManager"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="serviceMetricsManager"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="auditContext"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="serverConfig"/>
        </constructor-arg>
     </bean>
    <!-- server side policy service -->
    <bean id="policyService" class="com.l7tech.server.policy.PolicyService">
        <constructor-arg>
            <ref bean="sslKeystorePrivateKey"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="sslKeystoreCertificate"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="policyFactory"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="policyFilterManager"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="securityTokenResolver"/>
        </constructor-arg>
    </bean>
    <!-- server side token service -->
    <bean id="tokenService" class="com.l7tech.server.TokenServiceImpl">
        <constructor-arg>
            <ref bean="sslKeystorePrivateKey"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="sslKeystoreCertificate"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="policyFactory"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="securityTokenResolver"/>
        </constructor-arg>
    </bean>


    <bean id="auditContext" class="org.springframework.aop.framework.ProxyFactoryBean">
        <property name="proxyInterfaces"><value>com.l7tech.common.audit.AuditContext</value></property>
        <property name="targetSource">
            <ref local="auditContextTargetSource"/>
        </property>
    </bean>

    <bean id="auditContextTarget" class="com.l7tech.server.audit.AuditContextImpl" singleton="false">
        <constructor-arg>
            <ref bean="serverConfig"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="auditRecordManager"/>
        </constructor-arg>
    </bean>

    <bean id="auditContextTargetSource" class="org.springframework.aop.target.ThreadLocalTargetSource">
        <property name="targetBeanName">
            <value>auditContextTarget</value>
        </property>
    </bean>

    <!-- server side Status Update Manager -->
    <bean id="statusUpdateManager" class="com.l7tech.cluster.StatusUpdateManagerImpl">
        <constructor-arg>
            <ref bean="clusterInfoManager"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="serviceManager"/>
        </constructor-arg>
        <constructor-arg>
            <ref bean="serviceUsageManager"/>
        </constructor-arg>

        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>

    <!-- Status Update Manager Task Scheduler -->
    <bean id="statusUpdateManagerSchedulerTask" class="org.springframework.scheduling.timer.ScheduledTimerTask">
        <!-- wait 10 seconds before starting repeated execution -->
        <property name="delay">
            <!-- 8 seconds -->
            <value>8000</value>
        </property>
        <property name="period">
            <!-- repeat every 4 seconds -->
            <value>4000</value>
        </property>
        <property name="timerTask">
            <!-- server side Status Update Manager Scheduled Task -->
            <bean class="org.springframework.scheduling.timer.MethodInvokingTimerTaskFactoryBean">
                <property name="targetObject">
                    <ref bean="statusUpdateManager"/>
                </property>
                <property name="targetMethod">
                    <value>update</value>
                </property>
            </bean>
        </property>
    </bean>
    <!-- server side Task Scheduler -->
    <bean class="org.springframework.scheduling.timer.TimerFactoryBean">
        <property name="scheduledTimerTasks">
            <list>
                <ref local="statusUpdateManagerSchedulerTask"/>
            </list>
        </property>
    </bean>

    <bean id="messageProcessingAuditListener" class="com.l7tech.server.audit.MessageProcessingAuditListener">
        <constructor-arg>
            <ref local="messageSummaryAuditFactory"/>
        </constructor-arg>

        <constructor-arg>
            <ref local="auditContext"/>
        </constructor-arg>
    </bean>

    <bean id="adminAuditListener" class="com.l7tech.server.audit.AdminAuditListener">
        <constructor-arg>
            <ref local="clusterNodeId"/>
        </constructor-arg>

        <constructor-arg>
            <ref local="auditContext"/>
        </constructor-arg>
    </bean>

    <bean id="systemAuditListener" class="com.l7tech.server.audit.SystemAuditListener">
        <constructor-arg>
            <ref local="clusterNodeId"/>
        </constructor-arg>

        <constructor-arg>
            <ref local="auditContext"/>
        </constructor-arg>
    </bean>

    <bean id="counterIDManager" class="com.l7tech.server.sla.CounterIDManager">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>

    <bean id="counterCache" class="com.l7tech.server.sla.CounterCache" />

    <bean id="communitySchemaManager" class="com.l7tech.server.communityschemas.CommunitySchemaManager">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
        <property name="serverConfig">
            <ref local="serverConfig"/>
        </property>
    </bean>

    <bean id="registryPublicationManager" class="com.l7tech.server.systinet.RegistryPublicationManager">
        <property name="serverConfig">
            <ref local="serverConfig"/>
        </property>
        <property name="keystore">
            <ref local="keystore"/>
        </property>
    </bean>

    <bean id="clusterPropertyManagerTarget" class="com.l7tech.cluster.ClusterPropertyManager">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>

    <bean id="securityTokenResolver" class="com.l7tech.server.TrustedAndUserCertificateResolver">
        <property name="clientCertManager">
            <ref bean="clientCertManager"/>
        </property>

        <property name="trustedCertManager">
            <ref bean="trustedCertManager"/>
        </property>

        <property name="sslKeystoreCertificate">
            <ref bean="sslKeystoreCertificate"/>
        </property>

        <property name="rootCertificate">
            <ref bean="rootCertificate"/>
        </property>
    </bean>

    <bean id="licenseManager" class="com.l7tech.server.GatewayLicenseManager" depends-on="systemAuditListener">
        <constructor-arg>
            <ref bean="clusterPropertyManager"/>
        </constructor-arg>
    </bean>

    <bean id="certificateAuthenticator" class="com.l7tech.server.identity.cert.CertificateAuthenticator">
        <constructor-arg>
            <ref bean="clientCertManager"/>
        </constructor-arg>
    </bean>

    <!-- Identity mapping stuff -->
    <bean id="identityMappingManager" class="com.l7tech.server.identity.mapping.IdentityMappingManager">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>

    <bean id="attributeConfigManager" class="com.l7tech.server.identity.mapping.AttributeConfigManager">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>

    <bean id="securityTokenMappingManager" class="com.l7tech.server.identity.mapping.SecurityTokenMappingManager">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>

    <!--
    The MAC of this cluster node, so that we don't need to throw the whole
    ClusterInfoManager around 
    -->
    <bean id="clusterNodeId" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject">
            <ref local='clusterInfoManager'/>
        </property>
        <property name="targetMethod">
            <value>thisNodeId</value>
        </property>
    </bean>

    <bean id="serviceMetricsManagerTarget"
          class="com.l7tech.server.service.ServiceMetricsManager"
          singleton="true"
          depends-on="ssgBoot"> <!-- To ensure system.properties file is processed first -->
        <constructor-arg>
            <ref bean="clusterNodeId"/>
        </constructor-arg>
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
        <property name="transactionManager">
            <ref bean="transactionManager"/>
        </property>
        <property name="serviceManager">
            <ref bean="serviceManager"/>
        </property>
    </bean>

    <bean id="entityInvalidator" class="com.l7tech.server.EntityVersionChecker" depends-on="ssgBoot">
        <property name="entityManagers">
            <list>
                <ref local="communitySchemaManager"/>
            </list>
        </property>
    </bean>

</beans>
