#!/bin/sh -x 
echo "Layer 7 SecureSpan(tm) Gateway v4.0" >/etc/issue

cd /etc/rc2.d
ln -s ../init.d/ssg_tcp_tune.sh S71SSG_tcptune
ln -s ../init.d/ssg S99SSG_ssg

cd /ssg

# migrate the structure to the new partitioning scheme using the configuration wizard
# Set java in version, in case its needed
JAVA_HOME=/usr/j2se/jre1.6.0_01
export JAVA_HOME

/ssg/configwizard/ssgconfig.sh -partitionMigrate 

# Added user previously, pre-expire them
passwd -x 0 ssgconfig

# set the ssgconfig password, this string was copied from a /etc/shadow of a machine
# where the ssgconfig password was previously set to '7layer'. Salting may apply.
PASSWD=YyodXLOqlkTSg

#create a temporary input file
cp /etc/shadow /etc/shadow.orig

nawk -F: '{
	if ( $1 == "ssgconfig" )
		printf"%s:%s:%s:%s:%s:%s:%s:%s:%s\n",$1,passwd,$3,$4,$5,$6,$7,$8,$9
	else
		printf"%s:%s:%s:%s:%s:%s:%s:%s:%s\n",$1,$2,$3,$4,$5,$6,$7,$8,$9
}' passwd="$PASSWD" /etc/shadow.orig > /etc/shadow

# Enable pfil hooks for e1000g driver
echo "e1000g -1      0       pfil" >> /etc/ipf/pfil.ap
/usr/sbin/svcadm enable -r network/pfil

# Enable ipfilter, you are at risk of being disconnected...
/usr/sbin/svcadm enable -r network/ipfilter
