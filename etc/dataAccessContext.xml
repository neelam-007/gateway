<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC  "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<!--
    The Spring Hibernate configuration. References Hibernate mappings, defines transaction managers
    persistence interceptors, and transactional behaviour.
 -->
<beans>

    <!--
    Hibernate Properties location

    Note that serverConfig has to initialize first, since it will set the configDirectory
    system property.
    -->
    <bean id="hibernateProperties"
          class="com.l7tech.spring.factory.config.PropertiesFactoryBean"
          depends-on="serverConfig">
        <property name="locations">
            <list>
                <value>classpath:hibernate.properties</value>
                <value>file:${com.l7tech.server.configDirectory}${file.separator}hibernate.properties</value>
            </list>
        </property>
    </bean>

    <!--
    Default Hibernate Session Manager
    -->
    <bean id="sessionFactory" class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
        <property name="mappingResources">
            <list>
                <value>SSG.hbm.xml</value>
                <value>audit.hbm.xml</value>
                <value>rbac.hbm.xml</value>
            </list>
        </property>
        <property name="hibernateProperties">
            <ref local="hibernateProperties"/>
        </property>
        <property name="entityInterceptor">
            <ref local="persistenceEventInterceptor"/>
        </property>
    </bean>

    <!--
    Default Hibernate Transaction Manager
    -->
    <bean id="transactionManager" class="org.springframework.orm.hibernate3.HibernateTransactionManager">
        <property name="sessionFactory">
            <ref local="sessionFactory"/>
        </property>
    </bean>

    <!-- The audit events hibernate interceptor -->
    <bean id="persistenceEventInterceptor" class="com.l7tech.server.PersistenceEventInterceptor"/>

    <!-- Transaction interception for beans that implement an interface -->
    <bean class="org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator">
        <property name="proxyTargetClass" value="false"/>
        <property name="interceptorNames">
            <list>
                <idref bean="annotationTransactionInterceptor"/>
            </list>
        </property>
        <property name="beanNames">
            <list>
                <idref bean="identityProviderConfigManager"/>
                <idref bean="serviceManager"/>
                <idref bean="trustedCertManager"/>
                <idref bean="clientCertManager"/>
                <idref bean="auditRecordManager"/>
                <idref bean="statusUpdateManager"/>
                <idref bean="sampleMessageManager"/>
            </list>
        </property>
    </bean>

    <!-- Transaction and RBAC interception for admin beans -->
    <bean class="org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator">
        <property name="proxyTargetClass" value="false"/>
        <property name="interceptorNames">
            <list>
                <idref bean="annotationTransactionInterceptor"/>
                <idref bean="rbacAdvisor"/>
            </list>
        </property>
        <property name="beanNames">
            <list>
                <idref bean="serviceAdmin"/>
                <idref bean="auditAdmin"/>
                <idref bean="identityAdmin"/>
                <idref bean="jmsAdmin"/>
                <idref bean="rbacAdmin"/>
                <idref bean="schemaAdmin"/>
                <idref bean="trustedCertAdmin"/>
                <idref bean="kerberosAdmin"/>
                <idref bean="clusterStatusAdmin"/>
            </list>
        </property>
    </bean>


    <!-- Transaction interception for beans that don't implement an interface -->
    <bean class="org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator">
        <property name="proxyTargetClass" value="true"/>
        <property name="interceptorNames">
            <list>
                <idref bean="annotationTransactionInterceptor"/>
            </list>
        </property>
        <property name="beanNames">
            <list>
                <idref bean="internalIdentityProvider"/>
                <idref bean="internalUserManager"/>
                <idref bean="internalGroupManager"/>

                <idref bean="federatedIdentityProvider"/>
                <idref bean="federatedUserManager"/>
                <idref bean="federatedGroupManager"/>

                <idref bean="resolutionManager"/>
                <idref bean="clusterInfoManager"/>
                <idref bean="serviceUsageManager"/>
                <idref bean="jmsEndpointManager"/>
                <idref bean="jmsConnectionManager"/>
                <idref bean="auditExporter"/>
                <idref bean="counterIDManager"/>
                <idref bean="entityFinder"/>
                <idref bean="attributeConfigManager"/>
                <idref bean="identityMappingManager"/>
                <idref bean="securityTokenMappingManager"/>

                <!--
                The following are here, even though they both implement interfaces, because they're
                passed as constructor-args to entityInvalidator, where they get downcast to
                HibernateEntityManager.
                -->
                <idref bean="roleManager"/>
                <idref bean="schemaEntryManager"/>

            </list>
        </property>
    </bean>

    <bean class="org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor">
        <property name="transactionInterceptor" ref="annotationTransactionInterceptor"/>
    </bean>

    <bean id="annotationTransactionInterceptor" class="org.springframework.transaction.interceptor.TransactionInterceptor">
        <property name="transactionManager" ref="transactionManager"/>
        <property name="transactionAttributeSource">
            <bean class="org.springframework.transaction.annotation.AnnotationTransactionAttributeSource"/>
        </property>
    </bean>

</beans>
