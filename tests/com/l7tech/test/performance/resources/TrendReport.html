<html>
    <head>
        <title><!--{title}--></title>
        <link href="TrendReport.css" type="text/css" rel="stylesheet">
        <script type="text/javascript">
            /**
             * Hide/show all columns of reports in the results table.
             *
             * @param flag  true to show all; false to hide all
             */
            function hideShowAll(flag) {
                var elements = document.getElementsByTagName("input");
                for (var i = 0; i < elements.length; ++ i) {
                    if (elements[i].className == "hideShowCheckbox") {
                        elements[i].checked = flag;
                    }
                }

                var display = flag ? "" : "none";
                var rows = document.getElementById("resultsTable").rows;
                for (var rowIndex = 0; rowIndex < rows.length; ++ rowIndex) {
                    var cells = rows[rowIndex].cells;
                    for (var columnIndex = 1; columnIndex < cells.length - 2; ++ columnIndex) {
                        cells[columnIndex].style.display = display;
                    }
                }

                undoHighlightThresholds();
                calcStats();
            }

            /**
             * Hide/show a specific column of report in the results table.
             *
             * @param column    index of column to hide/show
             * @param flag      true to show; false to hide
             */
            function hideShowColumn(column, flag) {
                var display = flag ? "" : "none";
                var rows = document.getElementById("resultsTable").rows;
                for (var rowIndex = 0; rowIndex < rows.length; ++ rowIndex) {
                    var cells = rows[rowIndex].cells;
                    for (var columnIndex = 1; columnIndex < cells.length; ++ columnIndex) {
                        if (columnIndex == column) {
                            cells[columnIndex].style.display = display;
                        }
                    }
                }

                undoHighlightThresholds();
                calcStats();
            }

            /**
             * Handles onclick events of the outlier checkbox.
             */
            function onOutlierCheckboxClicked() {
                var rows = document.getElementById("reportsTable").rows;
                var headers = rows[0].cells;
                // Loop through each column.
                for (var columnIndex = 0; columnIndex < headers.length; ++ columnIndex) {
                    if (isOutlierColumn(columnIndex)) {
                        if (document.getElementById("outlierCheckbox").checked) {
                            highlightOutliers(columnIndex);
                        } else {
                            // Undo any outlier highlighting.
                            for (var rowIndex = 1; rowIndex < rows.length - 1; ++ rowIndex) {
                                rows[rowIndex].cells[columnIndex].style.backgroundColor = "white";
                            }
                        }
                    }
                }
            }

            /**
             * Determines if a column is a candidate for outlier highlighting;
             * those columns has the class "outlierCandidate".
             *
             * @param column    index of column to test
             * @return true or false
             */
            function isOutlierColumn(column) {
                var headers = document.getElementById("reportsTable").rows[0].cells;
                var classes = headers[column].className.split(" ");
                for (var i = 0; i < classes.length; ++ i) {
                    if (classes[i] == "outlierCandidate") {
                        return true;
                    }
                }
                return false;
            }

            /**
             * Highlights outliers in the given column in the reports table.
             *
             * @param column    index of column to highlight
             */
            function highlightOutliers(column) {
                var rows = document.getElementById("reportsTable").rows;
                // First pass: find value of maximum occurrence in this column
                var values = new Object();  // Map of value and number of occurrences
                for (var rowIndex = 1; rowIndex < rows.length - 1; ++ rowIndex) {
                    var value = rows[rowIndex].cells[column].innerHTML;
                    if (values[value] == undefined) {
                        values[value] = 1;
                    } else {
                        ++ values[value];
                    }
                }
                var maxOccurs = 0, maxValue;
                for (var value in values) {
                    if (values[value] > maxOccurs) {
                        maxOccurs = values[value];
                        maxValue = value;
                    }
                }

                // Second pass: highlight any cells not equal to value of maximum occurrence
                for (var rowIndex = 1; rowIndex < rows.length - 1; ++ rowIndex) {
                    var cell = rows[rowIndex].cells[column];
                    cell.style.backgroundColor = cell.innerHTML == maxValue ? "white" : "pink";
                }
            }

            /**
             * Calculates avg and stdev for each row in the results table.
             */
            function calcStats() {
                var rows = document.getElementById("resultsTable").rows;
                var avgColumnIndex = rows[0].cells.length - 2;
                var stdevColumnIndex = rows[0].cells.length - 1;
                for (var rowIndex = 1; rowIndex < rows.length; ++ rowIndex) {
                    var cells = rows[rowIndex].cells;
                    var n = 0;
                    var sum = 0.;
                    var sum2 = 0.;
                    for (var columnIndex = 1; columnIndex < cells.length - 2; ++ columnIndex) {
                        if (cells[columnIndex].style.display != "none" && cells[columnIndex].innerHTML != "") {
                            var value = Number(cells[columnIndex].innerHTML);
                            ++ n;
                            sum += value;
                            sum2 += value * value;
                        }
                    }
                    var avg = 0;
                    var stdev = 0;
                    if (n > 0) {
                        avg = sum / n;
                        if (n > 1) {
                            stdev = Math.sqrt((sum2 - n * avg * avg) / (n - 1));
                        }
                    }
                    cells[avgColumnIndex].innerHTML = avg.toFixed(3);
                    cells[stdevColumnIndex].innerHTML = stdev.toFixed(3);
                }
            }

            /**
             * Highlight cells in the results table that meets the threshold.
             */
            function highlightThresholds() {
                var percent = document.getElementById("percent").value;
                var comparison = document.getElementById("comparison").value;
                var benchmark = document.getElementById("benchmark").value;
                var rows = document.getElementById("resultsTable").rows;
                var avgColumnIndex = rows[0].cells.length - 2;
                var stdevColumnIndex = rows[0].cells.length - 1;
                for (var rowIndex = 1; rowIndex < rows.length; ++ rowIndex) {
                    var cells = rows[rowIndex].cells;
                    var avg, stdev = 0;
                    if (benchmark == "avg" || benchmark == "stdev") {
                        avg = Number(cells[avgColumnIndex].innerHTML);
                        stdev = Number(cells[stdevColumnIndex].innerHTML);
                    } else {
                        avg = Number(cells[benchmark].innerHTML);
                    }
                    for (var columnIndex = 1; columnIndex < cells.length - 2; ++ columnIndex) {
                        var cell = cells[columnIndex];
                        var value = cell.innerHTML;
                        if (value != "") {
                            var delta;  // percentage difference
                            if (benchmark == "stdev") {
                                delta = (value - avg) / stdev * 100;
                            } else {
                                delta = (value - avg) / avg * 100;
                            }

                            var highlight = false;
                            if (comparison == "ge") {
                                highlight = delta >= percent;
                            } else if (comparison == "le") {
                                highlight = delta <= percent;
                            } else if (comparison == "outside") {
                                highlight = Math.abs(delta) >= percent;
                            } else if (comparison == "within") {
                                highlight = Math.abs(delta) <= percent;
                            } else {
                                alert("Programming Error: missing code to handle comparison type: " + comparison);
                            }
                            cell.style.backgroundColor = highlight ? "yellow" : "white";
                        }
                    }
                }
            }

            /**
             * Undo threshold highlighting all cells in the results table.
             */
            function undoHighlightThresholds() {
                var rows = document.getElementById("resultsTable").rows;
                for (var rowIndex = 1; rowIndex < rows.length; ++ rowIndex) {
                    var cells = rows[rowIndex].cells;
                    for (var columnIndex = 1; columnIndex < cells.length; ++ columnIndex) {
                        cells[columnIndex].style.backgroundColor = "white";
                    }
                }
            }
        </script>
    </head>
    <body onload="calcStats()">
        <h1><!--{title}--></h1>
        <p>Created: <!--{creation time}--> by com.l7tech.test.performance.TrendReport</p>
        <h2>Performance Reports</h2>
        <div>
        <div style="margin-bottom: 3px">Use checkboxes to hide/show columns in the Throughput Data table.</div>
            <table id="reportsTable" class="bluewhite">
                <tr>
                    <th><input type="checkbox" checked onClick="hideShowAll(this.checked)"></th>
                    <th>Report</th>
                    <th>Date</th>
                    <th>Version</th>
                    <th class="outlierCandidate">Host</th>
                    <th class="outlierCandidate">CPUs</th>
                    <th class="outlierCandidate">OS</th>
                    <th class="outlierCandidate">JVM</th>
                    <th>Notes</th>
                    <th>File</th>
                </tr>
                <!--{next report row}-->
                <tr>
                    <th colspan="10" style="text-align: right"><input id="outlierCheckbox" type="checkbox" onclick="onOutlierCheckboxClicked()"/>highlight outlier</th>
                </tr>
            </table>
        </div>
        <br>
        <h2>Throughput Data <span style="font-size: smaller">(in transactions/sec)</span></h2>
        <div style="margin-bottom: 3px">
            <span style="padding-left: 10px; background-color: yellow; border: 1px solid #005A9C">&nbsp;</span>
            <input type="button" value="Highlight" onclick="highlightThresholds()"/> values
            <input id="percent" type="text" size="2" style="text-align: right"/>%
            <select id="comparison">
                <option value="ge">&gt;=</option>
                <option value="le">&lt;=</option>
                <option value="outside" selected>outside (inclusive)</option>
                <option value="within">within (inclusive)</option>
            </select>
            <select id="benchmark">
                <option value="avg">Average</option>
                <option value="stdev">Standard Deviation</option>
                <!--{next report option}-->
            </select>
            (only visible columns are used to calculate averge and std dev)
        </div>
        <table id="resultsTable" class="bluewhite">
            <!--{results header}-->
            <!--{next results row}-->
        </table>
        <br>
        <h2>Throughput Charts</h2>
        <!--{next test case img}-->
        <h2>Notes</h2>
        <!--{next note}-->
    </body>
</html>
